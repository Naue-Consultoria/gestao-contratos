<div class="public-planejamento-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando planejamento estratÃ©gico...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">âš ï¸</div>
    <h2>Erro ao carregar planejamento</h2>
    <p>{{ error }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error && planejamento" class="content-container">

    <!-- Header -->
    <header class="planejamento-header">
      <div class="logo-section">
        <img src="/assets/logo-naue.png" alt="NAUE Consultoria" class="logo" />
      </div>

      <div class="title-section">
        <h1>{{ planejamento.titulo }}</h1>
        <h2>Matriz de EvoluÃ§Ã£o Consciente</h2>
      </div>

      <div class="info-section">
        <div class="info-item">
          <strong>Cliente:</strong> {{ getClientName() }}
        </div>
        <div class="info-item" *ngIf="planejamento.data_inicio">
          <strong>PerÃ­odo:</strong> {{ formatDate(planejamento.data_inicio) }}
          <span *ngIf="planejamento.data_fim"> atÃ© {{ formatDate(planejamento.data_fim) }}</span>
        </div>
        <div class="info-item" *ngIf="planejamento.prazo_preenchimento">
          <strong>Prazo para preenchimento:</strong>
          <span [class.expired]="isPrazoVencido()">
            {{ formatDateTime(planejamento.prazo_preenchimento) }}
          </span>
          <span *ngIf="isPrazoVencido()" class="expired-badge">Expirado</span>
        </div>
        <div class="info-item">
          <strong>Progresso:</strong>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getMatrizPreenchimentoPercentage()"></div>
          </div>
          <span class="progress-text">{{ getMatrizPreenchimentoPercentage() }}% preenchido</span>
        </div>
      </div>

      <div *ngIf="planejamento.descricao" class="description-section">
        <p>{{ planejamento.descricao }}</p>
      </div>
    </header>

    <!-- Instructions -->
    <div class="instructions-box">
      <h3>ğŸ“‹ InstruÃ§Ãµes</h3>
      <p>
        Cada departamento deve preencher sua matriz de evoluÃ§Ã£o consciente.
        Clique no botÃ£o "Editar Matriz" correspondente ao seu departamento para preencher as quatro colunas:
      </p>
      <ul>
        <li><strong>Vulnerabilidades:</strong> Pontos fracos ou Ã¡reas que necessitam atenÃ§Ã£o</li>
        <li><strong>Conquistas:</strong> RealizaÃ§Ãµes e sucessos obtidos</li>
        <li><strong>LiÃ§Ãµes Aprendidas:</strong> Conhecimentos adquiridos atravÃ©s da experiÃªncia</li>
        <li><strong>Compromissos:</strong> AÃ§Ãµes e metas para o futuro</li>
      </ul>
    </div>

    <!-- Departamentos sem matriz preenchida -->
    <div *ngIf="departamentos.length > 0 && !hasAnyMatrizPreenchida()" class="empty-state">
      <p>Nenhum departamento preencheu a matriz ainda.</p>
      <p>Clique em "Editar Matriz" abaixo para comeÃ§ar.</p>
    </div>

    <!-- Tabela de Departamentos com Cards -->
    <div class="departamentos-grid">
      <div *ngFor="let departamento of departamentos; let i = index" class="departamento-card">

        <!-- CabeÃ§alho do Card -->
        <div class="card-header">
          <div class="departamento-info">
            <h3>{{ departamento.nome_departamento }}</h3>
            <div *ngIf="departamento.responsavel_nome" class="responsavel-info">
              <span class="icon">ğŸ‘¤</span>
              <span>{{ departamento.responsavel_nome }}</span>
              <span *ngIf="departamento.responsavel_email" class="email">
                ({{ departamento.responsavel_email }})
              </span>
            </div>
          </div>

          <div class="card-status">
            <span *ngIf="isMatrizPreenchida(departamento)" class="status-badge filled">
              âœ“ Preenchida
            </span>
            <span *ngIf="!isMatrizPreenchida(departamento)" class="status-badge pending">
              â³ Pendente
            </span>
          </div>
        </div>

        <!-- Corpo do Card - Matriz -->
        <div class="card-body">
          <div class="matriz-grid">
            <div class="matriz-column">
              <div class="column-header vulnerabilidades">
                <span class="icon">âš ï¸</span>
                <span>Vulnerabilidades</span>
              </div>
              <div class="column-content">
                <p [innerHTML]="getMatrizColuna(departamento, 'vulnerabilidades') | newlineToBr"></p>
              </div>
            </div>

            <div class="matriz-column">
              <div class="column-header conquistas">
                <span class="icon">ğŸ†</span>
                <span>Conquistas</span>
              </div>
              <div class="column-content">
                <p [innerHTML]="getMatrizColuna(departamento, 'conquistas') | newlineToBr"></p>
              </div>
            </div>

            <div class="matriz-column">
              <div class="column-header licoes">
                <span class="icon">ğŸ’¡</span>
                <span>LiÃ§Ãµes Aprendidas</span>
              </div>
              <div class="column-content">
                <p [innerHTML]="getMatrizColuna(departamento, 'licoes_aprendidas') | newlineToBr"></p>
              </div>
            </div>

            <div class="matriz-column">
              <div class="column-header compromissos">
                <span class="icon">ğŸ¯</span>
                <span>Compromissos</span>
              </div>
              <div class="column-content">
                <p [innerHTML]="getMatrizColuna(departamento, 'compromissos') | newlineToBr"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer do Card - AÃ§Ãµes -->
        <div class="card-footer">
          <button
            class="btn-edit-matriz"
            (click)="openEditModal(departamento)"
            [disabled]="isPrazoVencido()">
            <span class="icon">âœï¸</span>
            {{ isMatrizPreenchida(departamento) ? 'Editar Matriz' : 'Preencher Matriz' }}
          </button>

          <div *ngIf="isMatrizPreenchida(departamento)" class="last-update">
            Ãšltima atualizaÃ§Ã£o: {{ formatDateTime(departamento.matriz?.atualizado_em) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="planejamento-footer">
      <p>Â© {{ getCurrentYear() }} NAUE Consultoria - Todos os direitos reservados</p>
    </footer>
  </div>

  <!-- Modal de EdiÃ§Ã£o -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h2>Editar Matriz de EvoluÃ§Ã£o Consciente</h2>
        <h3>{{ selectedDepartamento?.nome_departamento }}</h3>
        <button class="btn-close" (click)="closeEditModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="vulnerabilidades">
            <span class="icon">âš ï¸</span>
            Vulnerabilidades
          </label>
          <textarea
            id="vulnerabilidades"
            [(ngModel)]="matrizForm.vulnerabilidades"
            rows="5"
            placeholder="Descreva as vulnerabilidades identificadas..."></textarea>
        </div>

        <div class="form-group">
          <label for="conquistas">
            <span class="icon">ğŸ†</span>
            Conquistas
          </label>
          <textarea
            id="conquistas"
            [(ngModel)]="matrizForm.conquistas"
            rows="5"
            placeholder="Descreva as conquistas alcanÃ§adas..."></textarea>
        </div>

        <div class="form-group">
          <label for="licoes_aprendidas">
            <span class="icon">ğŸ’¡</span>
            LiÃ§Ãµes Aprendidas
          </label>
          <textarea
            id="licoes_aprendidas"
            [(ngModel)]="matrizForm.licoes_aprendidas"
            rows="5"
            placeholder="Descreva as liÃ§Ãµes aprendidas..."></textarea>
        </div>

        <div class="form-group">
          <label for="compromissos">
            <span class="icon">ğŸ¯</span>
            Compromissos
          </label>
          <textarea
            id="compromissos"
            [(ngModel)]="matrizForm.compromissos"
            rows="5"
            placeholder="Descreva os compromissos assumidos..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeEditModal()" [disabled]="isSaving">
          Cancelar
        </button>
        <button class="btn-save" (click)="saveMatriz()" [disabled]="isSaving">
          <span *ngIf="!isSaving">Salvar Matriz</span>
          <span *ngIf="isSaving">Salvando...</span>
        </button>
      </div>
    </div>
  </div>
</div>
