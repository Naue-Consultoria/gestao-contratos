<div class="public-planejamento-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando planejamento estratégico...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">⚠️</div>
    <h2>Erro ao carregar planejamento</h2>
    <p>{{ error }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error && planejamento" class="content-container">

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-background"></div>
      <div class="hero-content">
        <!-- Logos -->
        <div class="logos-container">
          <div class="logo-naue">
            <img src="/logoNaueNeg.png" alt="NAUE Consultoria" />
          </div>
        </div>

        <!-- Title -->
        <div class="hero-title">
          <h1>Planejamento Estratégico</h1>
          <h2 class="client-name">{{ getClientName() }}</h2>
          <h3>Matriz de Evolução Consciente</h3>
        </div>

        <!-- Info Cards -->
        <div class="hero-info-cards">
          <div class="info-card" *ngIf="planejamento.data_inicio">
            <div class="info-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Período</span>
              <span class="info-value">
                {{ formatDate(planejamento.data_inicio) }}
                <span *ngIf="planejamento.data_fim"> - {{ formatDate(planejamento.data_fim) }}</span>
              </span>
            </div>
          </div>

          <div class="info-card" *ngIf="planejamento.prazo_preenchimento">
            <div class="info-icon" [class.expired]="isPrazoVencido()">
              <i class="fas fa-clock"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Prazo de Preenchimento</span>
              <span class="info-value" [class.expired]="isPrazoVencido()">
                {{ formatDate(planejamento.prazo_preenchimento) }}
                <span *ngIf="isPrazoVencido()" class="expired-badge">Vencido</span>
              </span>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Progresso</span>
              <div class="progress-container">
                <div class="progress-bar-hero">
                  <div class="progress-fill-hero" [style.width.%]="getMatrizPreenchimentoPercentage()"></div>
                </div>
                <span class="progress-text-hero">{{ getMatrizPreenchimentoPercentage() }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div *ngIf="planejamento.descricao" class="hero-description">
          <p>{{ planejamento.descricao }}</p>
        </div>

        <!-- Scroll Indicator -->
        <div class="scroll-indicator">
          <i class="fas fa-chevron-down"></i>
          <span>Role para preencher</span>
        </div>
      </div>
    </section>

    <!-- Explicação das Colunas -->
    <div class="colunas-explicacao">
      <div class="coluna-explicacao vulnerabilidade">
        <div class="icon-circle">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h4>Vulnerabilidade</h4>
        <p>Medos, limitações e desafios que impactaram a gestão, o time</p>
      </div>

      <div class="divider-line"></div>

      <div class="coluna-explicacao conquistas">
        <div class="icon-circle">
          <i class="fas fa-star"></i>
        </div>
        <h4>Conquistas</h4>
        <p>Chegou o momento de se venderem: comunicar conquistas, assumir protagonismo</p>
      </div>

      <div class="divider-line"></div>

      <div class="coluna-explicacao licoes">
        <div class="icon-circle">
          <i class="fas fa-book-open"></i>
        </div>
        <h4>Lições Aprendidas</h4>
        <p>Erros que se tornaram sabedoria e princípios</p>
      </div>

      <div class="divider-line"></div>

      <div class="coluna-explicacao compromissos">
        <div class="icon-circle">
          <i class="fas fa-handshake"></i>
        </div>
        <h4>Compromissos</h4>
        <p>Novos projetos, focos, direcionamentos para o próximo ano</p>
      </div>
    </div>

    <!-- Departamentos sem matriz preenchida -->
    <div *ngIf="departamentos.length > 0 && !hasAnyMatrizPreenchida()" class="empty-state">
      <p>Nenhum departamento preencheu a matriz ainda.</p>
      <p>Clique em "Editar Matriz" abaixo para começar.</p>
    </div>

    <!-- Tabela de Departamentos com Cards -->
    <div class="departamentos-grid">
      <div *ngFor="let departamento of departamentos; let i = index" class="departamento-card">

        <!-- Cabeçalho do Card (Clicável para Toggle) -->
        <div class="card-header" (click)="toggleDepartamento(departamento.id)">
          <div class="departamento-info">
            <button class="btn-toggle" type="button">
              <i class="fas" [class.fa-chevron-down]="!isDepartamentoExpanded(departamento.id)" [class.fa-chevron-up]="isDepartamentoExpanded(departamento.id)"></i>
            </button>
            <div>
              <h3>{{ departamento.nome_departamento }}</h3>
              <div *ngIf="departamento.responsavel_nome" class="responsavel-info">
                <i class="fas fa-user"></i>
                <span>{{ departamento.responsavel_nome }}</span>
                <span *ngIf="departamento.responsavel_email" class="email">
                  ({{ departamento.responsavel_email }})
                </span>
              </div>
            </div>
          </div>

          <div class="card-status">
            <span *ngIf="isMatrizPreenchida(departamento)" class="status-badge filled">
              <i class="fas fa-check"></i> Preenchida
            </span>
            <span *ngIf="!isMatrizPreenchida(departamento)" class="status-badge pending">
              <i class="fas fa-clock"></i> Pendente
            </span>
          </div>
        </div>

        <!-- Corpo do Card - Matriz (Sempre editável) -->
        <div class="card-body-edit" *ngIf="isDepartamentoExpanded(departamento.id)" (click)="$event.stopPropagation()">
          <div class="matriz-edit-grid">
            <!-- Vulnerabilidades -->
            <div class="matriz-column-edit">
              <div class="column-header-edit vulnerabilidades">
                <span><i class="fas fa-shield-alt"></i> Vulnerabilidades</span>
                <button type="button" class="btn-add-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="addItemToDepartamento(departamento, 'vulnerabilidades'); $event.stopPropagation()" [disabled]="isPrazoVencido()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div class="column-items">
                <div *ngIf="getDepartamentoItens(departamento, 'vulnerabilidades').length === 0" class="empty-column">
                  {{ isEditingDepartamento(departamento.id) ? 'Clique no + para adicionar itens' : 'Nenhum item adicionado' }}
                </div>
                <div *ngFor="let item of getDepartamentoItens(departamento, 'vulnerabilidades'); let i = index; trackBy: trackByIndex" class="item-edit" [class.view-mode]="!isEditingDepartamento(departamento.id)">
                  <textarea
                    [value]="item"
                    (input)="updateItemInDepartamento(departamento, 'vulnerabilidades', i, $event)"
                    placeholder="Digite o item..."
                    class="item-textarea"
                    [disabled]="!isEditingDepartamento(departamento.id) || isPrazoVencido()"
                    rows="1"></textarea>
                  <button type="button" class="btn-remove-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="removeItemFromDepartamento(departamento, 'vulnerabilidades', i)" [disabled]="isPrazoVencido()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Conquistas -->
            <div class="matriz-column-edit">
              <div class="column-header-edit conquistas">
                <span><i class="fas fa-star"></i> Conquistas</span>
                <button type="button" class="btn-add-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="addItemToDepartamento(departamento, 'conquistas'); $event.stopPropagation()" [disabled]="isPrazoVencido()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div class="column-items">
                <div *ngIf="getDepartamentoItens(departamento, 'conquistas').length === 0" class="empty-column">
                  {{ isEditingDepartamento(departamento.id) ? 'Clique no + para adicionar itens' : 'Nenhum item adicionado' }}
                </div>
                <div *ngFor="let item of getDepartamentoItens(departamento, 'conquistas'); let i = index; trackBy: trackByIndex" class="item-edit" [class.view-mode]="!isEditingDepartamento(departamento.id)">
                  <textarea
                    [value]="item"
                    (input)="updateItemInDepartamento(departamento, 'conquistas', i, $event)"
                    placeholder="Digite o item..."
                    class="item-textarea"
                    [disabled]="!isEditingDepartamento(departamento.id) || isPrazoVencido()"
                    rows="1"></textarea>
                  <button type="button" class="btn-remove-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="removeItemFromDepartamento(departamento, 'conquistas', i)" [disabled]="isPrazoVencido()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Lições Aprendidas -->
            <div class="matriz-column-edit">
              <div class="column-header-edit licoes">
                <span><i class="fas fa-book-open"></i> Lições Aprendidas</span>
                <button type="button" class="btn-add-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="addItemToDepartamento(departamento, 'licoes_aprendidas'); $event.stopPropagation()" [disabled]="isPrazoVencido()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div class="column-items">
                <div *ngIf="getDepartamentoItens(departamento, 'licoes_aprendidas').length === 0" class="empty-column">
                  {{ isEditingDepartamento(departamento.id) ? 'Clique no + para adicionar itens' : 'Nenhum item adicionado' }}
                </div>
                <div *ngFor="let item of getDepartamentoItens(departamento, 'licoes_aprendidas'); let i = index; trackBy: trackByIndex" class="item-edit" [class.view-mode]="!isEditingDepartamento(departamento.id)">
                  <textarea
                    [value]="item"
                    (input)="updateItemInDepartamento(departamento, 'licoes_aprendidas', i, $event)"
                    placeholder="Digite o item..."
                    class="item-textarea"
                    [disabled]="!isEditingDepartamento(departamento.id) || isPrazoVencido()"
                    rows="1"></textarea>
                  <button type="button" class="btn-remove-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="removeItemFromDepartamento(departamento, 'licoes_aprendidas', i)" [disabled]="isPrazoVencido()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Compromissos -->
            <div class="matriz-column-edit">
              <div class="column-header-edit compromissos">
                <span><i class="fas fa-handshake"></i> Compromissos</span>
                <button type="button" class="btn-add-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="addItemToDepartamento(departamento, 'compromissos'); $event.stopPropagation()" [disabled]="isPrazoVencido()">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div class="column-items">
                <div *ngIf="getDepartamentoItens(departamento, 'compromissos').length === 0" class="empty-column">
                  {{ isEditingDepartamento(departamento.id) ? 'Clique no + para adicionar itens' : 'Nenhum item adicionado' }}
                </div>
                <div *ngFor="let item of getDepartamentoItens(departamento, 'compromissos'); let i = index; trackBy: trackByIndex" class="item-edit" [class.view-mode]="!isEditingDepartamento(departamento.id)">
                  <textarea
                    [value]="item"
                    (input)="updateItemInDepartamento(departamento, 'compromissos', i, $event)"
                    placeholder="Digite o item..."
                    class="item-textarea"
                    [disabled]="!isEditingDepartamento(departamento.id) || isPrazoVencido()"
                    rows="1"></textarea>
                  <button type="button" class="btn-remove-item" *ngIf="isEditingDepartamento(departamento.id)" (click)="removeItemFromDepartamento(departamento, 'compromissos', i)" [disabled]="isPrazoVencido()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer do Card - Ações -->
        <div class="card-footer" *ngIf="isDepartamentoExpanded(departamento.id)" (click)="$event.stopPropagation()">
          <div class="footer-edit">
            <div class="footer-left">
              <div *ngIf="isMatrizPreenchida(departamento)" class="last-update">
                Última atualização: {{ formatDateTime(departamento.matriz?.atualizado_em) }}
              </div>
            </div>
            <div class="footer-actions">
              <button class="btn-export-pdf" (click)="exportarPDF(departamento); $event.stopPropagation()" [disabled]="!isMatrizPreenchida(departamento)">
                <i class="fas fa-file-pdf"></i> Exportar PDF
              </button>
              <button class="btn-save-edit" (click)="toggleEditMode(departamento); $event.stopPropagation()" [disabled]="(isSaving && selectedDepartamento?.id === departamento.id) || isPrazoVencido()">
                <i class="fas" [ngClass]="isEditingDepartamento(departamento.id) ? 'fa-save' : 'fa-edit'"></i>
                {{ isSaving && selectedDepartamento?.id === departamento.id ? 'Salvando...' : (isEditingDepartamento(departamento.id) ? 'Salvar Matriz' : 'Editar Matriz') }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botão Exportar Todas as Matrizes -->
    <div *ngIf="hasAnyMatrizPreenchida()" class="export-all-section">
      <button class="btn-export-all-matrices" (click)="exportarTodasMatrizes()">
        <i class="fas fa-file-pdf"></i> Exportar Todas as Matrizes (PDF)
      </button>
    </div>

    <!-- Footer -->
    <footer class="planejamento-footer">
      <p>© {{ getCurrentYear() }} NAUE Consultoria - Todos os direitos reservados</p>
    </footer>
  </div>
</div>
