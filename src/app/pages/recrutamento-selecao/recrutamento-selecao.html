<div class="page-header">
  <h1 class="page-title">Recrutamento & Seleção</h1>
  <app-breadcrumb></app-breadcrumb>
</div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-header">
        <span class="stat-label">Vagas Abertas</span>
        <div class="stat-icon-wrapper">
          <i class="fas fa-briefcase"></i>
        </div>
      </div>
      <div class="stat-value">{{ totalVagasAbertas }}</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <span class="stat-label">Vagas Fechadas</span>
        <div class="stat-icon-wrapper">
          <i class="fas fa-check-double"></i>
        </div>
      </div>
      <div class="stat-value">{{ totalVagasFechadas }}</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <span class="stat-label">Tempo Médio Fechamento</span>
        <div class="stat-icon-wrapper">
          <i class="fas fa-clock"></i>
        </div>
      </div>
      <div class="stat-value">{{ tempoMedioFechamento }} dias</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab" [class.active]="activeTab === 'geral'" (click)="setActiveTab('geral')">
      <i class="fas fa-eye"></i>
      Visão Geral
      <span class="tab-count">{{ filteredVagas.length }}</span>
    </div>
    <div class="tab" [class.active]="activeTab === 'fechamento'" (click)="setActiveTab('fechamento')">
      <i class="fas fa-check-circle"></i>
      Fechamento
      <span class="tab-count">{{ getVagasFechamento().length }}</span>
    </div>
    <div class="tab" [class.active]="activeTab === 'comissoes'" (click)="setActiveTab('comissoes')">
      <i class="fas fa-coins"></i>
      Comissões
      <span class="tab-count">{{ getVagasComissoes().length }}</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="table-container">
    <!-- Filters and Actions -->
    <div class="table-header">
      <div class="filters-section">
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            [placeholder]="getSearchPlaceholder()"
            [(ngModel)]="searchTerm"
            (input)="onSearch()">
          <button
            *ngIf="searchTerm"
            class="clear-search-btn"
            (click)="clearSearch()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="filter-group">
          <!-- Multi-select dropdown para status -->
          <div class="multi-select-wrapper" *ngIf="activeTab === 'geral'">
            <button
              type="button"
              class="filter-select multi-select-trigger"
              (click)="toggleStatusDropdown()"
              [class.active]="statusFilter.length > 0">
              <span>{{ getStatusFilterLabel() }}</span>
              <i class="fas fa-chevron-down"></i>
            </button>

            <div class="multi-select-dropdown" *ngIf="statusDropdownOpen">
              <div class="multi-select-options">
                <label
                  *ngFor="let status of Object.keys(statusLabels)"
                  class="multi-select-option">
                  <input
                    type="checkbox"
                    [checked]="isStatusSelected(status)"
                    (change)="toggleStatusFilter(status)">
                  <span class="checkbox-custom"></span>
                  <span class="option-label">{{ statusLabels[status] }}</span>
                </label>
              </div>
              <div class="multi-select-footer" *ngIf="statusFilter.length > 0">
                <button
                  type="button"
                  class="btn-clear-selection"
                  (click)="statusFilter = []; applyFilters()">
                  <i class="fas fa-times"></i>
                  Limpar seleção
                </button>
              </div>
            </div>
          </div>

          <select class="filter-select" [(ngModel)]="tipoCargoFilter" (change)="applyFilters()">
            <option value="">Todos os tipos de cargo</option>
            <option *ngFor="let tipo of Object.keys(tipoCargoLabels)" [value]="tipo">
              {{ tipoCargoLabels[tipo] }}
            </option>
          </select>

          <select class="filter-select" [(ngModel)]="fonteRecrutamentoFilter" (change)="applyFilters()">
            <option value="">Todas as fontes</option>
            <option *ngFor="let fonte of Object.keys(fonteRecrutamentoLabels)" [value]="fonte">
              {{ fonteRecrutamentoLabels[fonte] }}
            </option>
          </select>

          <!-- Consultora filter - Only show on Comissões tab -->
          <select class="filter-select" [(ngModel)]="consultoraFilter" (change)="applyFilters()" *ngIf="activeTab === 'comissoes'">
            <option value="">Todas as consultoras</option>
            <option *ngFor="let consultora of getAvailableConsultoras()" [value]="consultora">
              {{ consultora }}
            </option>
          </select>

          <!-- Month/Year filters - Show on all tabs -->
          <select class="filter-select"
                  name="filterMonth"
                  [value]="selectedMonth"
                  (change)="selectedMonth = $any($event.target).value; onMonthYearChange()">
            <option value="">Todos os meses</option>
            <option *ngFor="let month of cachedMonths" [value]="month.value">
              {{ month.label }}
            </option>
          </select>

          <select class="filter-select"
                  name="filterYear"
                  [value]="selectedYear"
                  (change)="selectedYear = $any($event.target).value; onMonthYearChange()">
            <option value="">Todos os anos</option>
            <option *ngFor="let year of cachedYears" [value]="year.value">
              {{ year.label }}
            </option>
          </select>
        </div>

        <button class="btn btn-secondary btn-clear" (click)="clearFilters()" *ngIf="hasFilters()">
          <i class="fas fa-times"></i>
          <span class="btn-text">Limpar filtros</span>
        </button>
      </div>

      <div class="action-buttons btn-group">
        <button class="btn btn-primary btn-new" (click)="openNewModal()">
          <i class="fas fa-plus-circle"></i>
          <span class="btn-text">{{ getNewButtonText() }}</span>
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <i class="fas fa-spinner fa-spin"></i>
      Carregando dados...
    </div>

    <!-- Table - Visão Geral -->
    <div class="table-wrapper" *ngIf="!isLoading && activeTab === 'geral'">
      <div *ngIf="filteredVagas.length === 0" class="empty-state">
        <i class="fas fa-briefcase empty-icon"></i>
        <h3>Nenhuma vaga encontrada</h3>
        <p>Clique em "Nova Vaga" para criar a primeira vaga</p>
      </div>

      <table class="data-table" *ngIf="filteredVagas.length > 0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Cargo</th>
            <th>Tipo Cargo</th>
            <th>Tipo Abertura</th>
            <th>Sigilo</th>
            <th>Salário</th>
            <th>Pretensão Salarial</th>
            <th>Consultora</th>
            <th>Status</th>
            <th>Candidato Aprovado</th>
            <th>Fonte</th>
            <th>Data Abertura</th>
            <th>Data Fechamento</th>
            <th>SLA (dias)</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vaga of filteredVagas" (click)="viewVaga(vaga, $event)" style="cursor: pointer">
            <td>
              <div class="client-info">
                <div class="client-name-container">
                  <span class="client-name">{{ vaga.clienteNome }}</span>
                  <span class="client-company-name" *ngIf="vaga.clienteType === 'PJ' && vaga.clienteCompanyName && vaga.clienteTradeName && vaga.clienteTradeName !== vaga.clienteCompanyName">
                    {{ vaga.clienteCompanyName }}
                  </span>
                </div>
              </div>
            </td>
            <td>
              <div class="vaga-title">
                {{ vaga.cargo }}
              </div>
            </td>
            <td>
              <span class="type-badge">{{ tipoCargoLabels[vaga.tipoCargo] }}</span>
            </td>
            <td>
              <span class="abertura-badge" [ngClass]="vaga.tipoAbertura">
                {{ tipoAberturaLabels[vaga.tipoAbertura] }}
              </span>
            </td>
            <td>
              <span class="sigilo-badge" [class.sigilosa]="vaga.sigilosa">
                {{ vaga.sigilosa ? 'Sigilosa' : 'Não Sigilosa' }}
              </span>
            </td>
            <td>
              <span class="salary-value" *ngIf="vaga.salario">R$ {{ vaga.salario | number:'1.2-2' }}</span>
              <span class="empty-text" *ngIf="!vaga.salario">-</span>
            </td>
            <td>
              <span class="salary-value" *ngIf="vaga.pretensaoSalarial">R$ {{ vaga.pretensaoSalarial | number:'1.2-2' }}</span>
              <span class="empty-text" *ngIf="!vaga.pretensaoSalarial">-</span>
            </td>
            <td>
              <span class="user-name">{{ vaga.usuarioNome }}</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="'status-' + vaga.status">
                {{ statusLabels[vaga.status] }}
              </span>
              <small class="status-interview" *ngIf="vaga.statusEntrevista">
                {{ statusEntrevistaLabels[vaga.statusEntrevista] }}
              </small>
            </td>
            <td>
              <div class="approved-candidate" *ngIf="vaga.candidatoAprovado">
                <span class="candidate-name">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-right: 0.25rem;"></i>
                  {{ vaga.candidatoAprovado }}
                </span>
                <small class="candidate-contact" *ngIf="vaga.contatoCandidato">
                  {{ vaga.contatoCandidato }}
                </small>
              </div>
              <span class="empty-text" *ngIf="!vaga.candidatoAprovado">-</span>
            </td>
            <td>
              <span class="fonte-badge">{{ fonteRecrutamentoLabels[vaga.fonteRecrutamento] }}</span>
            </td>
            <td>
              <span class="date-text">{{ vaga.dataAbertura | date:'dd/MM/yyyy' }}</span>
            </td>
            <td>
              <span class="date-text" *ngIf="vaga.dataFechamentoCancelamento">
                {{ vaga.dataFechamentoCancelamento | date:'dd/MM/yyyy' }}
              </span>
              <span class="date-text empty" *ngIf="!vaga.dataFechamentoCancelamento">-</span>
            </td>
            <td>
              <span class="sla-badge"
                    [ngClass]="getSlaClass(calculateSla(vaga))"
                    *ngIf="vaga.dataFechamentoCancelamento">
                {{ calculateSla(vaga) }} dias
              </span>
              <span class="sla-badge active" *ngIf="!vaga.dataFechamentoCancelamento">
                {{ calculateActiveSla(vaga) }} dias
              </span>
            </td>
            <td>
              <div class="action-buttons-cell">
                <div class="dropdown-container">
                  <button class="action-btn dropdown-toggle" (click)="toggleDropdown(vaga.id, $event)" title="Ações">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" *ngIf="openDropdownId === vaga.id" [class.show]="openDropdownId === vaga.id">
                    <button class="dropdown-item" (click)="viewVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-eye"></i>
                      Visualizar
                    </button>
                    <button class="dropdown-item" (click)="editVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-edit"></i>
                      Editar
                    </button>
                    <button class="dropdown-item" (click)="fecharVaga(vaga); closeDropdown($event)" *ngIf="vaga.status !== 'fechada' && vaga.status !== 'fechada_rep'">
                      <i class="fas fa-check-circle"></i>
                      Fechar Vaga
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item delete" (click)="deleteVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-trash"></i>
                      Excluir
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Table - Fechamento -->
    <div class="table-wrapper" *ngIf="!isLoading && activeTab === 'fechamento'">

      <div *ngIf="getVagasFechamento().length === 0" class="empty-state">
        <i class="fas fa-check-circle empty-icon"></i>
        <h3>Nenhuma vaga fechada encontrada</h3>
        <p>{{ (selectedMonth || selectedYear) ? 'Nenhuma vaga foi fechada no período selecionado' : 'Vagas fechadas aparecerão aqui' }}</p>
      </div>

      <table class="data-table" *ngIf="getVagasFechamento().length > 0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Cargo</th>
            <th>Status</th>
            <th>Candidato Aprovado</th>
            <th>Salário</th>
            <th>% Faturamento</th>
            <th>Valor Faturamento</th>
            <th>Consultora</th>
            <th>Data Abertura</th>
            <th>Data Fechamento</th>
            <th>SLA (dias)</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vaga of getVagasFechamento()" (click)="viewVaga(vaga, $event)" style="cursor: pointer">
            <td>
              <div class="client-info">
                <div class="client-name-container">
                  <span class="client-name">{{ vaga.clienteNome }}</span>
                  <span class="client-company-name" *ngIf="vaga.clienteType === 'PJ' && vaga.clienteCompanyName && vaga.clienteTradeName && vaga.clienteTradeName !== vaga.clienteCompanyName">
                    {{ vaga.clienteCompanyName }}
                  </span>
                </div>
              </div>
            </td>
            <td>
              <div class="vaga-title">
                {{ vaga.cargo }}
              </div>
            </td>
            <td>
              <span class="status-badge" [ngClass]="'status-' + vaga.status">
                {{ statusLabels[vaga.status] }}
              </span>
            </td>
            <td>
              <div class="approved-candidate" *ngIf="vaga.candidatoAprovado">
                <span class="candidate-name">
                  <i class="fas fa-check-circle" style="color: #10b981; margin-right: 0.25rem;"></i>
                  {{ vaga.candidatoAprovado }}
                </span>
                <small class="candidate-contact" *ngIf="vaga.contatoCandidato">
                  {{ vaga.contatoCandidato }}
                </small>
              </div>
              <span class="empty-text" *ngIf="!vaga.candidatoAprovado">-</span>
            </td>
            <td>
              <span class="salary-value">R$ {{ vaga.salario | number:'1.2-2' }}</span>
            </td>
            <td>
              <span class="percentage-value">{{ vaga.porcentagemFaturamento || 100 }}%</span>
            </td>
            <td>
              <span class="billing-value">R$ {{ vaga.valorFaturamento || (vaga.salario * ((vaga.porcentagemFaturamento || 100) / 100)) | number:'1.2-2' }}</span>
            </td>
            <td>
              <span class="consultant-name">{{ vaga.usuarioNome || '-' }}</span>
            </td>
            <td>
              <span class="date-text">{{ vaga.dataAbertura | date:'dd/MM/yyyy' }}</span>
            </td>
            <td>
              <span class="date-text" *ngIf="vaga.dataFechamentoCancelamento">
                {{ vaga.dataFechamentoCancelamento | date:'dd/MM/yyyy' }}
              </span>
              <span class="date-text empty" *ngIf="!vaga.dataFechamentoCancelamento">-</span>
            </td>
            <td>
              <span class="sla-badge"
                    [ngClass]="getSlaClass(calculateSla(vaga))"
                    *ngIf="vaga.dataFechamentoCancelamento">
                {{ calculateSla(vaga) }} dias
              </span>
              <span class="sla-badge active" *ngIf="!vaga.dataFechamentoCancelamento">
                {{ calculateActiveSla(vaga) }} dias
              </span>
            </td>
            <td>
              <div class="action-buttons-cell">
                <div class="dropdown-container">
                  <button class="action-btn dropdown-toggle" (click)="toggleDropdown(vaga.id, $event)" title="Ações">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" *ngIf="openDropdownId === vaga.id" [class.show]="openDropdownId === vaga.id">
                    <button class="dropdown-item" (click)="viewVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-eye"></i>
                      Visualizar
                    </button>
                    <button class="dropdown-item" (click)="editVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-edit"></i>
                      Editar
                    </button>
                    <button class="dropdown-item" (click)="fecharVaga(vaga); closeDropdown($event)" *ngIf="vaga.status !== 'fechada' && vaga.status !== 'fechada_rep'">
                      <i class="fas fa-check-circle"></i>
                      Fechar Vaga
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item delete" (click)="deleteVaga(vaga); closeDropdown($event)">
                      <i class="fas fa-trash"></i>
                      Excluir
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Table - Comissões -->
    <div class="table-wrapper" *ngIf="!isLoading && activeTab === 'comissoes'">
      <div *ngIf="getVagasComissoes().length === 0" class="empty-state">
        <i class="fas fa-coins empty-icon"></i>
        <h3>Nenhuma comissão encontrada</h3>
        <p>Vagas fechadas com comissões aparecerão aqui</p>
      </div>

      <table class="data-table" *ngIf="getVagasComissoes().length > 0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Cargo</th>
            <th>Tipo Cargo</th>
            <th>Salário</th>
            <th>Faturamento</th>
            <th>Valor Faturamento</th>
            <th>Imposto</th>
            <th>Valor Imposto</th>
            <th>Lucro</th>
            <th>Comissão (5%)</th>
            <th>Consultora</th>
            <th>Data Fechamento</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vaga of getVagasComissoes()" (click)="viewVaga(vaga, $event)" style="cursor: pointer">
            <td>
              <div class="client-info">
                <div class="client-name-container">
                  <span class="client-name">{{ vaga.clienteNome }}</span>
                  <span class="client-company-name" *ngIf="vaga.clienteType === 'PJ' && vaga.clienteCompanyName && vaga.clienteTradeName && vaga.clienteTradeName !== vaga.clienteCompanyName">
                    {{ vaga.clienteCompanyName }}
                  </span>
                </div>
              </div>
            </td>
            <td>
              <div class="vaga-title">
                {{ vaga.cargo }}
              </div>
            </td>
            <td>
              <span class="type-badge">{{ tipoCargoLabels[vaga.tipoCargo] }}</span>
            </td>
            <td>
              <span class="salary-value">R$ {{ vaga.salario | number:'1.2-2':'pt-BR' }}</span>
            </td>
            <td>
              <span class="percentage-value">{{ vaga.porcentagemFaturamento || 100 }}%</span>
            </td>
            <td>
              <span class="revenue-value">R$ {{ calcularValorFaturamento(vaga) | number:'1.2-2':'pt-BR' }}</span>
            </td>
            <td>
              <span class="tax-percentage">{{ vaga.impostoEstado || 0 }}%</span>
            </td>
            <td>
              <span class="tax-value">R$ {{ calcularValorImposto(vaga) | number:'1.2-2':'pt-BR' }}</span>
            </td>
            <td>
              <span class="profit-value">R$ {{ calcularLucro(vaga) | number:'1.2-2':'pt-BR' }}</span>
            </td>
            <td>
              <span class="commission-value">R$ {{ calcularComissao(vaga) | number:'1.2-2':'pt-BR' }}</span>
            </td>
            <td>
              <span class="user-name">{{ vaga.usuarioNome }}</span>
            </td>
            <td>
              <span class="date-text" *ngIf="vaga.dataFechamentoCancelamento">
                {{ vaga.dataFechamentoCancelamento | date:'dd/MM/yyyy' }}
              </span>
              <span class="date-text empty" *ngIf="!vaga.dataFechamentoCancelamento">-</span>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="5" class="text-right"><strong>Total:</strong></td>
            <td><strong>R$ {{ calcularTotalFaturamento() | number:'1.2-2':'pt-BR' }}</strong></td>
            <td></td>
            <td><strong>R$ {{ calcularTotalImpostos() | number:'1.2-2':'pt-BR' }}</strong></td>
            <td><strong>R$ {{ calcularTotalLucro() | number:'1.2-2':'pt-BR' }}</strong></td>
            <td><strong>R$ {{ calcularTotalComissao() | number:'1.2-2':'pt-BR' }}</strong></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>

  <!-- Modal de Confirmação de Fechamento -->
  <div class="modal-overlay" *ngIf="showFecharVagaModal" (click)="onModalBackdropClick($event)">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-check-circle"></i>
          Fechar Vaga
        </h2>
        <button class="modal-close-btn" (click)="closeFecharVagaModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="confirmation-message">
          <p>Tem certeza que deseja fechar a vaga?</p>
          <div class="vaga-info">
            <strong>Cargo:</strong> {{ selectedVagaToClose?.cargo }}
          </div>
          <div class="vaga-info">
            <strong>Cliente:</strong> {{ selectedVagaToClose?.clienteNome }}
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeFecharVagaModal()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="confirmFecharVaga()">
          <i class="fas fa-check"></i>
          Confirmar Fechamento
        </button>
      </div>
    </div>
  </div>
