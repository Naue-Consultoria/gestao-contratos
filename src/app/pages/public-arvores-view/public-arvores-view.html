<div class="public-arvores-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando árvores de problemas...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">⚠️</div>
    <h2>Erro ao carregar árvores</h2>
    <p>{{ error }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error && planejamento" class="content-container">

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-background"></div>
      <div class="hero-content">
        <!-- Logos -->
        <div class="logos-container">
          <div class="logo-naue">
            <img src="/logoNaueNeg.png" alt="NAUE Consultoria" />
          </div>
        </div>

        <!-- Title -->
        <div class="hero-title">
          <h1>Planejamento Estratégico</h1>
          <h2 class="client-name">{{ getClientName() }}</h2>
          <h3>Árvore de Problemas</h3>
        </div>

        <!-- Info Cards -->
        <div class="hero-info-cards">
          <div class="info-card" *ngIf="planejamento.data_inicio">
            <div class="info-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Período</span>
              <span class="info-value">
                {{ formatDate(planejamento.data_inicio) }}
                <span *ngIf="planejamento.data_fim"> - {{ formatDate(planejamento.data_fim) }}</span>
              </span>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">
              <i class="fas fa-project-diagram"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Árvores Cadastradas</span>
              <span class="info-value">{{ arvores.length }} árvore{{ arvores.length !== 1 ? 's' : '' }}</span>
            </div>
          </div>

          <div class="info-card" *ngIf="getPilaresDeDor().length > 0">
            <div class="info-icon pilares-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Pilares de Dor</span>
              <span class="info-value">{{ getPilaresDeDor().length }} item{{ getPilaresDeDor().length !== 1 ? 's' : '' }}</span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div *ngIf="planejamento.descricao" class="hero-description">
          <p>{{ planejamento.descricao }}</p>
        </div>

        <!-- Scroll Indicator -->
        <div class="scroll-indicator">
          <i class="fas fa-chevron-down"></i>
          <span>Role para preencher</span>
        </div>
      </div>
    </section>

    <!-- Explicação -->
    <section class="explicacao-section">
      <div class="explicacao-content">
        <div class="explicacao-icon">
          <i class="fas fa-info-circle"></i>
        </div>
        <h3>Sobre a Árvore de Problemas</h3>
        <p>
          A Árvore de Problemas é uma ferramenta estratégica que identifica e analisa os principais desafios
          organizacionais. Cada item é avaliado por <strong>Gravidade (1-5)</strong>, <strong>Urgência (1-5)</strong> e
          <strong>Tendência (1-5)</strong>, gerando uma <strong>Nota de Impacto</strong> (G × U × T) que prioriza as ações necessárias.
        </p>
      </div>
    </section>

    <!-- Success Message -->
    <div *ngIf="successMessage" class="success-banner">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-banner">
      <i class="fas fa-exclamation-circle"></i>
      {{ error }}
    </div>

    <!-- Árvores -->
    <section class="arvores-section">
      <div class="arvores-content">

        <!-- Botão Criar Nova Árvore -->
        <div class="add-arvore-section">
          <button class="btn-add-arvore" (click)="toggleNovaArvoreForm()" *ngIf="!showNovaArvoreForm">
            <i class="fas fa-plus-circle"></i> Adicionar Nova Árvore
          </button>

          <div class="nova-arvore-form" *ngIf="showNovaArvoreForm">
            <input
              type="text"
              [(ngModel)]="novaArvoreNome"
              class="form-control"
              placeholder="Nome da nova árvore (ex: Tecnologia, Marketing...)"
              (keyup.enter)="criarNovaArvore()">
            <button class="btn-confirm" (click)="criarNovaArvore()">
              <i class="fas fa-check"></i> Criar
            </button>
            <button class="btn-cancel" (click)="toggleNovaArvoreForm()">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>

        <!-- Lista de Árvores -->
        <div *ngFor="let arvore of arvores" class="arvore-card">
          <!-- Header da Árvore -->
          <div class="arvore-header" (click)="toggleArvore(arvore.id)">
            <div class="arvore-title-row">
              <i class="fas" [ngClass]="isArvoreExpanded(arvore.id) ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
              <input
                type="text"
                [(ngModel)]="arvore.nome_arvore"
                class="arvore-nome-input"
                placeholder="Nome da árvore"
                (click)="$event.stopPropagation()">
              <span class="badge">{{ arvore.itens?.length || 0 }} itens</span>
            </div>
          </div>

          <!-- Corpo da Árvore -->
          <div class="arvore-body" *ngIf="isArvoreExpanded(arvore.id)">

            <!-- Botão Adicionar Linha -->
            <div class="arvore-body-header">
              <button class="btn-add-linha" (click)="adicionarNovaLinha(arvore)">
                <i class="fas fa-plus"></i> Adicionar Item
              </button>
            </div>

            <div *ngIf="!arvore.itens || arvore.itens.length === 0" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>Nenhum item cadastrado. Clique em "Adicionar Item" para começar.</p>
            </div>

            <div *ngIf="arvore.itens && arvore.itens.length > 0" class="arvore-table-container">
              <table class="arvore-table">
                <thead>
                  <tr>
                    <th style="width: 20%;">
                      <i class="fas fa-tag"></i> Tópico *
                    </th>
                    <th style="width: 30%;">
                      <i class="fas fa-question-circle"></i> Pergunta Norteadora
                    </th>
                    <th style="width: 10%;" class="text-center">
                      <i class="fas fa-exclamation"></i> Gravidade
                    </th>
                    <th style="width: 10%;" class="text-center">
                      <i class="fas fa-clock"></i> Urgência
                    </th>
                    <th style="width: 10%;" class="text-center">
                      <i class="fas fa-chart-line"></i> Tendência
                    </th>
                    <th style="width: 12%;" class="text-center">
                      <i class="fas fa-calculator"></i> Nota
                    </th>
                    <th style="width: 8%;" class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of arvore.itens; let i = index">
                    <td>
                      <input
                        type="text"
                        [(ngModel)]="item.topico"
                        class="form-control"
                        placeholder="Digite o tópico...">
                    </td>
                    <td>
                      <textarea
                        [(ngModel)]="item.pergunta_norteadora"
                        class="form-control textarea-pergunta"
                        placeholder="Digite a pergunta..."
                        rows="2"></textarea>
                    </td>
                    <td class="text-center">
                      <input
                        type="text"
                        [(ngModel)]="item.gravidade"
                        (ngModelChange)="calcularNota(item)"
                        class="form-control text-center"
                        placeholder="1-5"
                        maxlength="3">
                    </td>
                    <td class="text-center">
                      <input
                        type="text"
                        [(ngModel)]="item.urgencia"
                        (ngModelChange)="calcularNota(item)"
                        class="form-control text-center"
                        placeholder="1-5"
                        maxlength="3">
                    </td>
                    <td class="text-center">
                      <input
                        type="text"
                        [(ngModel)]="item.tendencia"
                        (ngModelChange)="calcularNota(item)"
                        class="form-control text-center"
                        placeholder="1-5"
                        maxlength="3">
                    </td>
                    <td class="text-center nota-col" [ngClass]="{'nota-alta': item.nota > 20, 'nota-media': item.nota > 10 && item.nota <= 20}">
                      <span class="nota-badge">{{ formatarNumero(item.nota) }}</span>
                    </td>
                    <td class="text-center">
                      <button class="btn-remove" (click)="removerLinha(arvore, i)" title="Remover item">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Botão Salvar -->
        <div class="card-actions-edit">
          <button class="btn-save" (click)="salvarArvores()" [disabled]="isSaving">
            <i class="fas" [ngClass]="isSaving ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ isSaving ? 'Salvando...' : 'Salvar Todas as Árvores' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Pilares de Dor (apenas visualização) -->
    <section *ngIf="getPilaresDeDor().length > 0" class="pilares-section">
      <div class="pilares-content">
        <div class="pilares-header">
          <h2>Pilares de Dor</h2>
        </div>
        <p class="pilares-subtitle">
          Esses são os principais desafios organizacionais que requerem atenção prioritária.
        </p>
        <div class="pilares-grid">
          <div *ngFor="let pilar of getPilaresDeDor()" class="pilar-card">
            <div class="pilar-header">
              <span class="pilar-arvore">{{ pilar.arvore_nome }}</span>
              <span class="pilar-nota-badge">{{ formatarNumero(pilar.nota) }}</span>
            </div>
            <h3 class="pilar-topico">{{ pilar.topico }}</h3>
            <p *ngIf="pilar.pergunta_norteadora" class="pilar-pergunta">{{ pilar.pergunta_norteadora }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Empty State -->
    <section *ngIf="arvores.length === 0" class="empty-state-section">
      <div class="empty-state-large">
        <i class="fas fa-project-diagram"></i>
        <h3>Nenhuma árvore cadastrada</h3>
        <p>Clique no botão acima para adicionar a primeira árvore de problemas.</p>
      </div>
    </section>

    <!-- Footer -->
    <footer class="public-footer">
      <div class="footer-content">
        <p>&copy; {{ currentYear }} NAUE Consultoria. Todos os direitos reservados.</p>
      </div>
    </footer>
  </div>
</div>
