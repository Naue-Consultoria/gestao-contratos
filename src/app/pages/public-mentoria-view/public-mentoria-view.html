<div class="mentoria-publica-page">

  <!-- LOADING -->
  <div *ngIf="isLoading" class="loading-screen">
    <div class="loading-spinner"></div>
    <p>Carregando mentoria...</p>
  </div>

  <!-- ERROR STATES -->
  <div *ngIf="notFound && !isLoading" class="error-screen">
    <div class="error-container">
      <i class="fa-solid fa-circle-exclamation"></i>
      <h1>Mentoria não encontrada</h1>
      <p>O link que você está tentando acessar não existe ou foi removido.</p>
    </div>
  </div>

  <div *ngIf="expired && !isLoading && !notFound" class="error-screen">
    <div class="error-container">
      <i class="fa-solid fa-clock"></i>
      <h1>Link expirado</h1>
      <p>Este link de acesso expirou. Entre em contato com seu mentor para obter um novo link.</p>
    </div>
  </div>

  <!-- CONTEÚDO PRINCIPAL -->
  <div *ngIf="encontro && !isLoading && !notFound && !expired" class="mentoria-content">

    <!-- Dropdown de Navegação entre Encontros (quando há 2+ encontros publicados) -->
    <div class="encontros-nav-dropdown" *ngIf="shouldShowDropdown()">
      <button
        class="encontros-nav-toggle"
        (click)="toggleEncontrosDropdown()"
        [class.active]="showEncontrosDropdown">
        <i class="fas fa-list"></i>
        <span class="nav-text">Encontro {{ encontro.numero_encontro }}</span>
        <i class="fas fa-chevron-down nav-arrow" [class.rotated]="showEncontrosDropdown"></i>
      </button>

      <div class="encontros-nav-menu" *ngIf="showEncontrosDropdown">
        <div class="nav-menu-header">
          <span>Todos os Encontros</span>
        </div>
        <button
          *ngFor="let outro of getEncontrosPublicados()"
          class="encontro-nav-item"
          [class.current]="outro.is_current"
          (click)="navegarParaEncontro(outro.unique_token)"
          [disabled]="outro.is_current">
          <div class="encontro-nav-numero">#{{ outro.numero_encontro }}</div>
          <div class="encontro-nav-info">
            <span class="encontro-nav-nome">{{ outro.mentorado_nome }}</span>
            <span class="encontro-nav-status" *ngIf="outro.is_current">
              <i class="fas fa-circle"></i> Você está aqui
            </span>
          </div>
          <i class="fas fa-chevron-right" *ngIf="!outro.is_current"></i>
        </button>
      </div>
    </div>

    <!-- Botão Voltar ao Hub (quando há apenas 1 encontro publicado) -->
    <div class="encontros-nav-dropdown" *ngIf="shouldShowBackButton()">
      <button
        class="encontros-nav-toggle"
        (click)="voltarParaHub()">
        <i class="fas fa-arrow-left"></i>
        <span class="nav-text">Voltar ao Hub da Mentoria</span>
      </button>
    </div>

    <!-- Header Hero -->
    <header class="mentoria-hero" [class.has-photo]="encontro.foto_encontro_url">
      <div class="hero-overlay"></div>
      <div class="hero-container">
        <div class="hero-brand">
          <img src="logoNaueNeg.png" alt="NAUE Consultoria" class="hero-logo">
        </div>

        <!-- Layout com foto: side-by-side -->
        <div class="hero-content-wrapper" *ngIf="encontro.foto_encontro_url">
          <div class="hero-text-side">
            <div class="welcome-message">
              <div class="welcome-line-1">
                <span class="welcome-word">Olá,</span>
                <span class="welcome-name">{{ encontro.mentorado_nome }}!</span>
              </div>
              <div class="welcome-line-2">
                <span class="welcome-word">Bem-vindo(a)</span>
                <span class="welcome-word">ao</span>
                <span class="welcome-word">seu</span>
                <span class="welcome-word">PD | Plano Diretivo!</span>
              </div>
            </div>

            <div class="hero-info">
              <div class="meta-info">
                <span class="meta-item">
                  <i class="fa-solid fa-hashtag"></i>
                  Encontro {{ encontro.numero_encontro }}
                </span>
                <span class="meta-item">
                  <i class="fa-solid fa-calendar"></i>
                  {{ formatDate(encontro.data_encontro) }}
                </span>
              </div>
            </div>
          </div>

          <div class="hero-photo-side">
            <img [src]="encontro.foto_encontro_url" [alt]="'Foto do Encontro ' + encontro.numero_encontro" class="encontro-photo">
          </div>
        </div>

        <!-- Layout sem foto: centralizado (layout original) -->
        <ng-container *ngIf="!encontro.foto_encontro_url">
          <div class="welcome-message">
            <div class="welcome-line-1">
              <span class="welcome-word">Olá,</span>
              <span class="welcome-name">{{ encontro.mentorado_nome }}!</span>
            </div>
            <div class="welcome-line-2">
              <span class="welcome-word">Bem-vindo(a)</span>
              <span class="welcome-word">ao</span>
              <span class="welcome-word">seu</span>
              <span class="welcome-word">PD | Plano Diretivo!</span>
            </div>
          </div>

          <div class="hero-info">
            <div class="meta-info">
              <span class="meta-item">
                <i class="fa-solid fa-hashtag"></i>
                Encontro {{ encontro.numero_encontro }}
              </span>
              <span class="meta-item">
                <i class="fa-solid fa-calendar"></i>
                {{ formatDate(encontro.data_encontro) }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>
    </header>

    <!-- Seção de Visão Geral e Mentoria -->
    <section class="intro-section" *ngIf="conteudoEstruturado">
      <div class="intro-container">
        <!-- Visão Geral -->
        <div *ngIf="conteudoEstruturado.visaoGeral?.ativo && conteudoEstruturado.visaoGeral?.conteudo"
             class="intro-block visao-geral-block">
          <div class="intro-header">
            <div class="intro-icon">
              <i class="fa-solid fa-bullseye"></i>
            </div>
            <h2>Visão Geral</h2>
          </div>
          <div class="intro-content">
            <p>{{ conteudoEstruturado.visaoGeral.conteudo }}</p>
          </div>
        </div>

        <!-- Mentoria -->
        <div *ngIf="conteudoEstruturado.mentoria?.ativo && conteudoEstruturado.mentoria?.conteudo"
             class="intro-block mentoria-block">
          <div class="intro-header">
            <div class="intro-icon">
              <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <h2>Conteúdo da Mentoria</h2>
          </div>
          <div class="intro-content">
            <p>{{ conteudoEstruturado.mentoria.conteudo }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- SEÇÕES REORDENÁVEIS -->
    <ng-container *ngFor="let secaoId of secoesOrdenadas">

    <!-- Testes Section -->
    <section *ngIf="secaoId === 'testes'" class="dark-section testes-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.testes?.ativo || !conteudoEstruturado.testes?.itens?.length">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-clipboard-check"></i>
            Testes Realizados
          </h2>
        </div>
        <div class="testes-grid-new">
          <article *ngFor="let teste of conteudoEstruturado.testes.itens" class="teste-card">
            <h3>{{ teste.nome }}</h3>
            <div *ngIf="teste.imagemUrl && !teste.isPdf" class="teste-img-new">
              <img [src]="teste.imagemUrl" [alt]="teste.nome">
            </div>
            <div *ngIf="teste.isPdf && teste.imagemUrl" class="teste-pdf-new">
              <div class="pdf-icon-wrapper">
                <i class="fas fa-file-pdf"></i>
              </div>
              <div class="pdf-info">
                <span class="pdf-label">Arquivo PDF</span>
                <a [href]="teste.imagemUrl" target="_blank" class="btn-download-pdf">
                  <i class="fas fa-download"></i>
                  Baixar / Visualizar PDF
                </a>
              </div>
            </div>
            <p *ngIf="teste.comentario" class="teste-comentario">{{ teste.comentario }}</p>
          </article>
        </div>
      </div>
    </section>

    <!-- Próximos Passos Section -->
    <section *ngIf="secaoId === 'proximosPassos'" class="dark-section proximos-passos-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.proximosPassos?.ativo || !conteudoEstruturado.proximosPassos?.blocos?.length">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-arrow-right"></i>
            Próximos Passos
          </h2>
        </div>
        <div class="passos-container">
          <div *ngFor="let bloco of conteudoEstruturado.proximosPassos.blocos" class="passo-card">

              <!-- Texto -->
              <div *ngIf="bloco.tipo === 'texto'" class="passo-texto-block">
                <div class="texto-indicator"></div>
                <div class="texto-content" [innerHTML]="bloco.conteudo"></div>
              </div>

              <!-- Perguntas -->
              <div *ngIf="bloco.tipo === 'perguntas' && bloco.perguntas?.length > 0" class="passo-perguntas-block">
                <div class="block-title">
                  <i class="fa-solid fa-question-circle"></i>
                  <span>{{ getNomeTemplate(bloco) }}</span>
                </div>
                <div class="perguntas-container">
                  <div *ngFor="let pergunta of bloco.perguntas; let i = index" class="pergunta-item">
                    <div class="pergunta-num">{{ i + 1 }}</div>
                    <div class="pergunta-body">
                      <p class="pergunta-q" style="white-space: pre-wrap;">{{ pergunta.pergunta }}</p>
                      <textarea
                        class="pergunta-input"
                        [(ngModel)]="pergunta.respostaUsuario"
                        (blur)="salvarRespostaAutomaticamente(bloco, i)"
                        placeholder="Digite sua resposta aqui..."
                        rows="4"></textarea>
                    </div>
                  </div>
                </div>
                <div class="perguntas-actions">
                  <button
                    type="button"
                    class="btn-save-respostas"
                    (click)="salvarRespostas(bloco)"
                    [disabled]="savingInteractions">
                    <i class="fa-solid" [ngClass]="savingInteractions ? 'fa-circle-notch fa-spin' : 'fa-save'"></i>
                    {{ savingInteractions ? 'Salvando...' : 'Salvar Respostas' }}
                  </button>
                </div>
              </div>

              <!-- Tarefas -->
              <div *ngIf="bloco.tipo === 'tarefas' && bloco.tarefas?.itens?.length > 0" class="passo-tarefas-block">
                <div class="block-title">
                  <i class="fa-solid fa-list-check"></i>
                  <span>{{ bloco.tarefas.titulo || 'Tarefas' }}</span>
                </div>
                <ul class="tarefas-container">
                  <li *ngFor="let tarefa of bloco.tarefas.itens; let j = index">
                    <label class="tarefa-checkbox">
                      <input
                        type="checkbox"
                        [(ngModel)]="tarefa.checked"
                        (change)="salvarEstadoTarefa(bloco, j)">
                      <span class="checkbox-custom"></span>
                      <span class="tarefa-text">{{ tarefa.texto || tarefa }}</span>
                    </label>
                  </li>
                </ul>
              </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Referências Section -->
    <section *ngIf="secaoId === 'referencias'" class="dark-section referencias-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.referencias?.ativo || !conteudoEstruturado.referencias?.itens?.length">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-book"></i>
            Referências e Inspirações
          </h2>
        </div>
        <div class="referencias-grid">
          <ng-container *ngFor="let ref of conteudoEstruturado.referencias.itens; let refIndex = index">
            <div class="ref-card-container">
              <!-- Vídeo do YouTube incorporado -->
              <div *ngIf="ref.link && isYouTubeUrl(ref.link)" class="youtube-video-container">
                <div class="ref-header">
                  <div class="ref-icon-new">
                    <i class="fa-solid fa-play-circle"></i>
                  </div>
                  <div class="ref-content-new">
                    <span class="ref-type">{{ ref.tipo === 'ted' ? 'TED Talk' : ref.tipo === 'livro' ? 'Livro' : 'Vídeo' }}</span>
                    <h4>{{ ref.titulo }}</h4>
                  </div>
                  <a [href]="ref.link" target="_blank" class="ref-external-link" title="Abrir no YouTube">
                    <i class="fa-solid fa-external-link-alt"></i>
                  </a>
                </div>
                <div class="video-embed">
                  <iframe
                    [src]="getYouTubeEmbedUrl(ref.link)"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                  </iframe>
                </div>
              </div>

              <!-- Com link (não YouTube): elemento clicável -->
              <a *ngIf="ref.link && ref.link.trim() !== '' && !isYouTubeUrl(ref.link)"
                 [href]="ref.link"
                 target="_blank"
                 class="ref-card">
                <div class="ref-icon-new">
                  <i class="fa-solid"
                     [ngClass]="{
                       'fa-play-circle': ref.tipo === 'ted',
                       'fa-book': ref.tipo === 'livro',
                       'fa-newspaper': ref.tipo === 'leitura'
                     }"></i>
                </div>
                <div class="ref-content-new">
                  <span class="ref-type">{{ ref.tipo === 'ted' ? 'TED Talk' : ref.tipo === 'livro' ? 'Livro' : 'Leitura' }}</span>
                  <h4>{{ ref.titulo }}</h4>
                </div>
                <i class="fa-solid fa-external-link-alt ref-external-new"></i>
              </a>

              <!-- Sem link: elemento não clicável -->
              <div *ngIf="!ref.link || ref.link.trim() === ''"
                   class="ref-card ref-card-no-link">
                <div class="ref-icon-new">
                  <i class="fa-solid"
                     [ngClass]="{
                       'fa-play-circle': ref.tipo === 'ted',
                       'fa-book': ref.tipo === 'livro',
                       'fa-newspaper': ref.tipo === 'leitura'
                     }"></i>
                </div>
                <div class="ref-content-new">
                  <span class="ref-type">{{ ref.tipo === 'ted' ? 'TED Talk' : ref.tipo === 'livro' ? 'Livro' : 'Leitura' }}</span>
                  <h4>{{ ref.titulo }}</h4>
                </div>
              </div>

              <!-- Campo de Anotações do Mentorado -->
              <div class="ref-anotacoes">
                <label class="anotacoes-label">
                  <i class="fa-solid fa-pen"></i>
                  Seus Aprendizados:
                </label>
                <textarea
                  class="anotacoes-textarea"
                  [(ngModel)]="ref.anotacaoMentorado"
                  placeholder="Anote aqui seus principais aprendizados desta referência..."
                  rows="3"></textarea>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Botão para salvar todas as anotações -->
        <div class="referencias-actions">
          <button
            type="button"
            class="btn-save-anotacoes"
            (click)="salvarTodasAnotacoesReferencias()"
            [disabled]="salvandoAnotacoes">
            <i class="fa-solid" [ngClass]="salvandoAnotacoes ? 'fa-circle-notch fa-spin' : 'fa-save'"></i>
            {{ salvandoAnotacoes ? 'Salvando...' : 'Salvar Aprendizados' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Modelo ABC Section -->
    <section *ngIf="secaoId === 'modeloABC'" class="dark-section modelo-abc-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.modeloABC?.ativo">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-brain"></i>
            Modelo ABC
          </h2>
          <p class="dark-subtitle">Adversity, Belief, Consequence</p>
        </div>

        <div class="modelo-abc-content">

          <!-- Cabeçalho ABC -->
          <div class="abc-header-grid-public">
            <div class="abc-header-card abc-a">
              <div class="abc-letter-large">A</div>
              <h3 class="abc-card-title">Adversity</h3>
              <p class="abc-card-desc">Adversidade: acontecimento que funciona como "gatilho" para o pensamento/crença irracional</p>
            </div>
            <div class="abc-header-card abc-b">
              <div class="abc-letter-large">B</div>
              <h3 class="abc-card-title">Belief</h3>
              <p class="abc-card-desc">Pensamento: "X" TEM que/ NÃO TEM que (exigência) + "ação" + SENÃO "X" É (rótulo)</p>
            </div>
            <div class="abc-header-card abc-c">
              <div class="abc-letter-large">C</div>
              <h3 class="abc-card-title">Consequence</h3>
              <p class="abc-card-desc">Consequência: emoção, reações fisiológicas e ação/comportamento</p>
            </div>
          </div>

          <!-- Campos ABC -->
          <div class="abc-inputs-grid">
            <div class="abc-input-group">
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.adversidade"
                placeholder="Descreva a adversidade..."
                rows="6"></textarea>
            </div>
            <div class="abc-input-group">
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.pensamento"
                placeholder="Descreva o pensamento/crença..."
                rows="6"></textarea>
            </div>
            <div class="abc-input-group">
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.consequencia"
                placeholder="Descreva as consequências..."
                rows="6"></textarea>
            </div>
          </div>

          <!-- Verificação -->
          <div class="abc-verification-box">
            <h4>Verificação se o pensamento é lógico, realista e produtivo</h4>
          </div>

          <!-- Antídotos -->
          <div class="abc-antidotos-section">
            <div class="abc-field">
              <label>Antídoto para exigência:</label>
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.antidotoExigencia"
                placeholder="Escreva o antídoto para a exigência..."
                rows="3"></textarea>
            </div>

            <div class="abc-field">
              <label>Antídoto para o rótulo:</label>
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.antidotoRotulo"
                placeholder="Escreva o antídoto para o rótulo..."
                rows="3"></textarea>
            </div>

            <div class="abc-field">
              <label>Frase de nocaute:</label>
              <textarea
                class="abc-input"
                [(ngModel)]="modeloABC.fraseNocaute"
                placeholder="Escreva a frase de nocaute..."
                rows="2"></textarea>
            </div>
          </div>

          <!-- Tarefa 1 -->
          <div class="abc-task-info">
            <i class="fa-solid fa-clipboard-list"></i>
            <p><strong>Tarefa:</strong> Ler as frases antídotos 4 vezes por dia por 30 dias, e antes de momentos críticos.</p>
          </div>

          <!-- Plano de Ação -->
          <div class="abc-field">
            <label>Plano de ação para lidar com o tipo de acontecimento que ativa a crença:</label>
            <textarea
              class="abc-input"
              [(ngModel)]="modeloABC.planoAcao"
              placeholder="Descreva o plano de ação..."
              rows="4"></textarea>
          </div>

          <!-- Nível de Disposição -->
          <div class="abc-field">
            <label>De 0 a 10 o quanto você está disposta(o) a colocar este plano em ação?</label>
            <div class="abc-slider-container">
              <input
                type="range"
                min="0"
                max="10"
                [(ngModel)]="modeloABC.nivelDisposicao"
                class="abc-slider">
              <span class="abc-slider-value">{{ modeloABC.nivelDisposicao }}</span>
            </div>
          </div>

          <!-- Impedimentos -->
          <div class="abc-field">
            <label>O que poderia impedir de colocá-lo em ação?</label>
            <textarea
              class="abc-input"
              [(ngModel)]="modeloABC.impedimentos"
              placeholder="Liste os possíveis impedimentos..."
              rows="3"></textarea>
          </div>

          <div class="abc-field">
            <label>O que fará caso os impedimentos apareçam?</label>
            <textarea
              class="abc-input"
              [(ngModel)]="modeloABC.acaoImpedimentos"
              placeholder="Descreva as ações..."
              rows="3"></textarea>
          </div>

          <!-- Tarefa 2 -->
          <div class="abc-task-info">
            <i class="fa-solid fa-clipboard-list"></i>
            <p><strong>Tarefa:</strong> Executar o plano de ação por uma semana e anotar como foi a execução deste plano.</p>
          </div>

          <!-- Botão Salvar -->
          <div class="abc-actions">
            <button
              type="button"
              class="btn-save-abc"
              (click)="salvarModeloABC()"
              [disabled]="salvandoModeloABC">
              <i class="fa-solid" [ngClass]="salvandoModeloABC ? 'fa-spinner fa-spin' : 'fa-save'"></i>
              {{ salvandoModeloABC ? 'Salvando...' : 'Salvar Modelo ABC' }}
            </button>
          </div>

        </div>
      </div>
    </section>

    <!-- Zonas de Aprendizado Section -->
    <section *ngIf="secaoId === 'zonasAprendizado'" class="dark-section zonas-aprendizado-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.zonasAprendizado?.ativo">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-chart-simple"></i>
            Zonas de Aprendizado
          </h2>
          <p class="dark-subtitle">Segurança Psicológica x Motivação e Senso de Dono(a)</p>
        </div>

        <div class="zonas-aprendizado-content">

          <!-- Controles -->
          <div class="zonas-controls">
            <div class="add-palavra-container">
              <input
                type="text"
                class="input-palavra"
                [(ngModel)]="novaPalavra"
                (keyup.enter)="adicionarPalavraZona()"
                placeholder="Digite uma palavra/conceito e pressione Enter...">
              <button
                type="button"
                class="btn-add-palavra"
                (click)="adicionarPalavraZona()">
                <i class="fa-solid fa-plus"></i>
                Adicionar
              </button>
            </div>

            <div class="zonas-actions-container">
              <button
                type="button"
                class="btn-salvar-zonas"
                (click)="salvarZonasAprendizado()"
                [disabled]="salvandoZonas">
                <i class="fa-solid" [ngClass]="salvandoZonas ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                {{ salvandoZonas ? 'Salvando...' : 'Salvar Gráfico' }}
              </button>

              <button
                type="button"
                class="btn-export-zonas"
                (click)="exportarZonasAprendizadoPDF()">
                <i class="fa-solid fa-file-pdf"></i>
                Exportar PDF
              </button>
            </div>
          </div>

          <!-- Gráfico de 4 Quadrantes -->
          <div class="zonas-quadrantes-container">

          <!-- Grid de Quadrantes -->
          <div class="quadrantes-grid">

            <!-- Eixo Y (vertical) - na borda esquerda -->
            <div class="eixo-y">
              <div class="eixo-label">Motivação e Senso de Dono(a)</div>
            </div>

            <!-- Eixo X (horizontal) - na borda inferior -->
            <div class="eixo-x">
              <div class="eixo-label">Segurança Psicológica</div>
            </div>

            <!-- Quadrante: Zona de Ansiedade (superior esquerdo) -->
            <div class="quadrante zona-ansiedade"
                 (drop)="onDropPalavra($event, 'ansiedade')"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)">
              <div class="quadrante-header">
                <h3>Zona de Ansiedade</h3>
              </div>
              <div class="quadrante-content">
                <div
                  *ngFor="let palavra of getPalavrasPorZona('ansiedade')"
                  class="palavra-tag"
                  draggable="true"
                  (dragstart)="onDragStart($event, palavra.id)">
                  <span>{{ palavra.texto }}</span>
                  <button
                    class="btn-remove-palavra"
                    (click)="removerPalavraZona(palavra.id)">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
                <p *ngIf="getPalavrasPorZona('ansiedade').length === 0" class="zona-empty">
                  Arraste palavras aqui
                </p>
              </div>
            </div>

            <!-- Quadrante: Zona de Aprendizado (superior direito) -->
            <div class="quadrante zona-aprendizado"
                 (drop)="onDropPalavra($event, 'aprendizado')"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)">
              <div class="quadrante-header">
                <h3>Zona de Aprendizado</h3>
              </div>
              <div class="quadrante-content">
                <div
                  *ngFor="let palavra of getPalavrasPorZona('aprendizado')"
                  class="palavra-tag"
                  draggable="true"
                  (dragstart)="onDragStart($event, palavra.id)">
                  <span>{{ palavra.texto }}</span>
                  <button
                    class="btn-remove-palavra"
                    (click)="removerPalavraZona(palavra.id)">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
                <p *ngIf="getPalavrasPorZona('aprendizado').length === 0" class="zona-empty">
                  Arraste palavras aqui
                </p>
              </div>
            </div>

            <!-- Quadrante: Zona de Apatia (inferior esquerdo) -->
            <div class="quadrante zona-apatia"
                 (drop)="onDropPalavra($event, 'apatia')"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)">
              <div class="quadrante-header">
                <h3>Zona de Apatia</h3>
              </div>
              <div class="quadrante-content">
                <div
                  *ngFor="let palavra of getPalavrasPorZona('apatia')"
                  class="palavra-tag"
                  draggable="true"
                  (dragstart)="onDragStart($event, palavra.id)">
                  <span>{{ palavra.texto }}</span>
                  <button
                    class="btn-remove-palavra"
                    (click)="removerPalavraZona(palavra.id)">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
                <p *ngIf="getPalavrasPorZona('apatia').length === 0" class="zona-empty">
                  Arraste palavras aqui
                </p>
              </div>
            </div>

            <!-- Quadrante: Zona de Conforto (inferior direito) -->
            <div class="quadrante zona-conforto"
                 (drop)="onDropPalavra($event, 'conforto')"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)">
              <div class="quadrante-header">
                <h3>Zona de Conforto</h3>
              </div>
              <div class="quadrante-content">
                <div
                  *ngFor="let palavra of getPalavrasPorZona('conforto')"
                  class="palavra-tag"
                  draggable="true"
                  (dragstart)="onDragStart($event, palavra.id)">
                  <span>{{ palavra.texto }}</span>
                  <button
                    class="btn-remove-palavra"
                    (click)="removerPalavraZona(palavra.id)">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
                <p *ngIf="getPalavrasPorZona('conforto').length === 0" class="zona-empty">
                  Arraste palavras aqui
                </p>
              </div>
            </div>

          </div>

        </div>

          <!-- Legenda -->
          <div class="zonas-legenda">
            <p class="legenda-fonte">Fonte: The Fearless Organization Flow</p>
          </div>

        </div>
      </div>
    </section>

    <!-- The Golden Circle Section -->
    <section *ngIf="secaoId === 'goldenCircle'" class="dark-section golden-circle-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.goldenCircle?.ativo">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-bullseye"></i>
            The Golden Circle
          </h2>
          <p class="dark-subtitle">Descubra seu propósito, processo e resultado</p>
        </div>

        <div class="golden-circle-content">

          <!-- Layout: Círculos + Perguntas -->
          <div class="golden-circle-layout">

            <!-- Círculos SVG com Setas -->
            <div class="golden-circles-svg">
              <svg viewBox="0 0 700 700" xmlns="http://www.w3.org/2000/svg">
                <!-- Círculo externo (WHAT) -->
                <circle cx="250" cy="350" r="200" fill="none" stroke="#022c22" stroke-width="3"/>
                <text x="250" y="530" text-anchor="middle" font-size="32" font-weight="bold" fill="#022c22">WHAT</text>

                <!-- Círculo médio (HOW) -->
                <circle cx="250" cy="350" r="133" fill="none" stroke="#022c22" stroke-width="3"/>
                <text x="250" y="470" text-anchor="middle" font-size="32" font-weight="bold" fill="#022c22">HOW</text>

                <!-- Círculo interno (WHY) -->
                <circle cx="250" cy="350" r="66" fill="none" stroke="#022c22" stroke-width="3"/>
                <text x="250" y="365" text-anchor="middle" font-size="32" font-weight="bold" fill="#022c22">WHY</text>

                <!-- Seta para WHY (do círculo interno para cima-direita) -->
                <path d="M 316 340 Q 450 80 650 80" stroke="#022c22" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

                <!-- Seta para HOW (horizontal do círculo médio) -->
                <line x1="383" y1="350" x2="650" y2="350" stroke="#022c22" stroke-width="3" marker-end="url(#arrowhead)"/>

                <!-- Seta para WHAT (do círculo externo para baixo-direita) -->
                <path d="M 391 491 Q 500 620 650 620" stroke="#022c22" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

                <!-- Definição da ponta de seta -->
                <defs>
                  <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#022c22"/>
                  </marker>
                </defs>
              </svg>
            </div>

            <!-- Campos de Perguntas -->
            <div class="golden-questions">

              <!-- WHY -->
              <div class="golden-field">
                <div class="golden-question-header">
                  <span class="golden-label">WHY</span>
                  <h3>Por que você faz o que você faz?</h3>
                  <p class="golden-subtitle">Qual o propósito?</p>
                </div>
                <textarea
                  class="golden-input"
                  [(ngModel)]="goldenCircle.why"
                  placeholder="Descreva seu propósito, sua razão de ser..."
                  rows="4"></textarea>
              </div>

              <!-- HOW -->
              <div class="golden-field">
                <div class="golden-question-header">
                  <span class="golden-label">HOW</span>
                  <h3>Como você faz o que você faz?</h3>
                  <p class="golden-subtitle">Seu processo.</p>
                </div>
                <textarea
                  class="golden-input"
                  [(ngModel)]="goldenCircle.how"
                  placeholder="Descreva seu processo, como você opera..."
                  rows="4"></textarea>
              </div>

              <!-- WHAT -->
              <div class="golden-field">
                <div class="golden-question-header">
                  <span class="golden-label">WHAT</span>
                  <h3>O que você faz?</h3>
                  <p class="golden-subtitle">Seu resultado.</p>
                </div>
                <textarea
                  class="golden-input"
                  [(ngModel)]="goldenCircle.what"
                  placeholder="Descreva o que você faz, seus resultados..."
                  rows="4"></textarea>
              </div>

            </div>

          </div>

          <!-- Botões -->
          <div class="golden-circle-actions">
            <button
              type="button"
              class="btn-save-golden"
              (click)="salvarGoldenCircle()"
              [disabled]="salvandoGoldenCircle">
              <i class="fa-solid" [ngClass]="salvandoGoldenCircle ? 'fa-spinner fa-spin' : 'fa-save'"></i>
              {{ salvandoGoldenCircle ? 'Salvando...' : 'Salvar' }}
            </button>

            <button
              type="button"
              class="btn-export-golden"
              (click)="exportarGoldenCirclePDF()">
              <i class="fa-solid fa-file-pdf"></i>
              Exportar PDF
            </button>
          </div>

        </div>
      </div>
    </section>

    <!-- Mapa Mental Section -->
    <section *ngIf="secaoId === 'mapaMental'" class="dark-section mapa-mental-main-section"
             [class.hidden]="!conteudoEstruturado || !conteudoEstruturado.mapaMental?.ativo">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-diagram-project"></i>
            Mapa Mental Estratégico
          </h2>
        </div>

        <!-- Controles -->
        <div class="mapa-mental-controls">
          <div class="controls-left">
            <button
              type="button"
              class="btn-add-nivel"
              (click)="adicionarNivelMapaMental()">
              <i class="fa-solid fa-plus"></i>
              Acrescentar Nível
            </button>
          </div>

          <div class="controls-right">
            <button
              type="button"
              class="btn-salvar-mapa"
              (click)="salvarMapaMentalManual()"
              [disabled]="salvandoMapaMental"
              title="Salvar alterações do mapa mental">
              <i class="fa-solid" [ngClass]="salvandoMapaMental ? 'fa-circle-notch fa-spin' : 'fa-save'"></i>
              {{ salvandoMapaMental ? 'Salvando...' : 'Salvar Mapa' }}
            </button>

            <!-- Dropdown de Exportação -->
            <div class="export-dropdown">
              <button
                type="button"
                class="btn-export-main"
                (click)="toggleExportDropdown()"
                [class.active]="showExportDropdown">
                <i class="fa-solid fa-download"></i>
                Exportar
                <i class="fa-solid fa-chevron-down dropdown-arrow" [class.rotated]="showExportDropdown"></i>
              </button>

              <div class="export-menu" *ngIf="showExportDropdown">
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalPNG()">
                  <i class="fa-solid fa-image"></i>
                  <span>Exportar como PNG</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalPDF()">
                  <i class="fa-solid fa-file-pdf"></i>
                  <span>Exportar como PDF</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalICS()">
                  <i class="fa-solid fa-calendar-plus"></i>
                  <span>Exportar para Agenda (.ics)</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalMarkdown()">
                  <i class="fa-brands fa-markdown"></i>
                  <span>Exportar para Notion (Markdown)</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Colunas e Cards -->
        <div class="mapa-mental-container">
          <div *ngFor="let coluna of conteudoEstruturado.mapaMental.data.colunas; trackBy: trackByFn" class="mapa-mental-coluna">
            <!-- Cabeçalho da Coluna -->
            <div class="coluna-header" [ngClass]="coluna.corBg">
              <h3>{{ coluna.nome }}</h3>
              <div class="coluna-header-actions">
                <button
                  type="button"
                  class="btn-add-card"
                  (click)="adicionarCardMapaMental(coluna.id)"
                  title="Adicionar card">
                  <i class="fa-solid fa-plus"></i>
                </button>
                <button
                  *ngIf="podeRemoverNivel(coluna.id)"
                  type="button"
                  class="btn-remove-nivel"
                  (click)="removerNivelMapaMental(coluna.id)"
                  title="Remover nível">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>

            <!-- Cards -->
            <div
              class="coluna-cards"
              cdkDropList
              [cdkDropListData]="conteudoEstruturado.mapaMental.data.cards[coluna.id]"
              (cdkDropListDropped)="onCardDrop($event, coluna.id)">
              <div
                *ngFor="let card of conteudoEstruturado.mapaMental.data.cards[coluna.id]; trackBy: trackByFn"
                cdkDrag
                class="mapa-mental-card"
                [class.conectando]="mapaMentalConectando === card.id"
                [ngClass]="coluna.corBorda"
                [attr.id]="'card-' + card.id">

                <div class="card-body">
                  <!-- Meta -->
                  <div class="form-group">
                    <label>Meta</label>
                    <textarea
                      class="form-textarea"
                      [value]="card.meta"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'meta', $any($event.target).value)"
                      placeholder="Descreva a meta"
                      rows="2"></textarea>
                  </div>

                  <!-- Indicador de Sucesso -->
                  <div class="form-group">
                    <label>IS</label>
                    <textarea
                      class="form-textarea"
                      [value]="card.indicador"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'indicador', $any($event.target).value)"
                      placeholder="Indicador de sucesso"
                      rows="2"></textarea>
                  </div>

                  <!-- Prazo -->
                  <div class="form-group">
                    <label>Prazo</label>
                    <input
                      type="date"
                      class="form-input"
                      [value]="card.prazo"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'prazo', $any($event.target).value)">
                  </div>

                  <!-- Ações do Card -->
                  <div class="card-actions">
                    <button
                      type="button"
                      class="btn-conectar"
                      [class.active]="mapaMentalConectando === card.id"
                      (click)="iniciarConexaoMapaMental(card.id)">
                      <i class="fa-solid fa-arrow-right"></i>
                      {{ mapaMentalConectando === card.id ? 'Conectando...' : 'Conectar' }}
                    </button>
                    <button
                      type="button"
                      class="btn-remove"
                      (click)="removerCardMapaMental(coluna.id, card.id)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>

                  <!-- Conexões -->
                  <div *ngIf="obterConexoesDoCard(card.id).length > 0" class="card-conexoes">
                    <p class="conexoes-label">CONEXÕES:</p>
                    <div class="conexoes-badges">
                      <span
                        *ngFor="let conexao of obterConexoesDoCard(card.id); let i = index"
                        class="conexao-badge">
                        → {{ obterNomeColunaDoCard(conexao.para) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <p *ngIf="!conteudoEstruturado.mapaMental.data.cards[coluna.id] || conteudoEstruturado.mapaMental.data.cards[coluna.id].length === 0"
                 class="empty-state-small">
                Clique em + para adicionar um card
              </p>
            </div>
          </div>
        </div>

        <!-- Lista de Conexões -->
        <div *ngIf="conteudoEstruturado.mapaMental.data.conexoes.length > 0" class="conexoes-lista">
          <h3>Conexões Criadas</h3>
          <div
            *ngFor="let conexao of conteudoEstruturado.mapaMental.data.conexoes; let i = index"
            class="conexao-item">
            <div class="conexao-content">
              <div class="conexao-card-info">
                <strong class="conexao-meta">{{ obterCardPorId(conexao.de)?.meta || 'Card origem' }}</strong>
                <small class="conexao-nivel">{{ obterNomeColunaDoCard(conexao.de) }}</small>
              </div>
              <span class="conexao-arrow">→</span>
              <div class="conexao-card-info">
                <strong class="conexao-meta">{{ obterCardPorId(conexao.para)?.meta || 'Card destino' }}</strong>
                <small class="conexao-nivel">{{ obterNomeColunaDoCard(conexao.para) }}</small>
              </div>
            </div>
            <button
              type="button"
              class="btn-remove-conexao"
              (click)="removerConexaoMapaMental(i)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>

      </div>
    </section>

    </ng-container>
    <!-- FIM DAS SEÇÕES REORDENÁVEIS -->

    <!-- Encerramento Section -->
    <section class="encerramento-final-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.encerramento?.ativo && conteudoEstruturado.encerramento?.conteudo">
      <div class="encerramento-container">
        <div class="encerramento-content-new">
          <p>{{ conteudoEstruturado.encerramento.conteudo }}</p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mentoria-footer">
      <p *ngIf="savingInteractions" class="saving-indicator">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        Salvando...
      </p>
      <p class="footer-info">
        <i class="fa-solid fa-shield-halved"></i>
        Suas informações são mantidas em sigilo
      </p>
      <p class="footer-copy">© {{ getCurrentYear() }} NAUE Consultoria - Todos os direitos reservados</p>
    </footer>

  </div>

  <!-- MODAL DE VISUALIZAÇÃO DE IMAGEM -->
  <div class="image-modal" *ngIf="modalImageSrc" (click)="closeImageModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <button class="image-modal-close" (click)="closeImageModal()">
        <i class="fas fa-times"></i>
      </button>
      <img [src]="modalImageSrc" alt="Imagem expandida">
    </div>
  </div>
</div>
