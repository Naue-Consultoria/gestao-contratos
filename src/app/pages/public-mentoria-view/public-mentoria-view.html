<div class="mentoria-publica-page">

  <!-- LOADING -->
  <div *ngIf="isLoading" class="loading-screen">
    <div class="loading-spinner"></div>
    <p>Carregando mentoria...</p>
  </div>

  <!-- ERROR STATES -->
  <div *ngIf="notFound && !isLoading" class="error-screen">
    <div class="error-container">
      <i class="fa-solid fa-circle-exclamation"></i>
      <h1>Mentoria não encontrada</h1>
      <p>O link que você está tentando acessar não existe ou foi removido.</p>
    </div>
  </div>

  <div *ngIf="expired && !isLoading && !notFound" class="error-screen">
    <div class="error-container">
      <i class="fa-solid fa-clock"></i>
      <h1>Link expirado</h1>
      <p>Este link de acesso expirou. Entre em contato com seu mentor para obter um novo link.</p>
    </div>
  </div>

  <!-- CONTEÚDO PRINCIPAL -->
  <div *ngIf="encontro && !isLoading && !notFound && !expired" class="mentoria-content">

    <!-- Dropdown de Navegação entre Encontros -->
    <div class="encontros-nav-dropdown" *ngIf="outrosEncontros && outrosEncontros.length > 1">
      <button
        class="encontros-nav-toggle"
        (click)="toggleEncontrosDropdown()"
        [class.active]="showEncontrosDropdown">
        <i class="fas fa-list"></i>
        <span class="nav-text">Encontro {{ encontro.numero_encontro }}</span>
        <i class="fas fa-chevron-down nav-arrow" [class.rotated]="showEncontrosDropdown"></i>
      </button>

      <div class="encontros-nav-menu" *ngIf="showEncontrosDropdown">
        <div class="nav-menu-header">
          <span>Todos os Encontros</span>
        </div>
        <button
          *ngFor="let outro of outrosEncontros"
          class="encontro-nav-item"
          [class.current]="outro.is_current"
          (click)="navegarParaEncontro(outro.unique_token)"
          [disabled]="outro.is_current">
          <div class="encontro-nav-numero">#{{ outro.numero_encontro }}</div>
          <div class="encontro-nav-info">
            <span class="encontro-nav-nome">{{ outro.mentorado_nome }}</span>
            <span class="encontro-nav-status" *ngIf="outro.is_current">
              <i class="fas fa-circle"></i> Você está aqui
            </span>
          </div>
          <i class="fas fa-chevron-right" *ngIf="!outro.is_current"></i>
        </button>
      </div>
    </div>

    <!-- Header Hero -->
    <header class="mentoria-hero" [class.has-photo]="encontro.foto_encontro_url">
      <div class="hero-overlay"></div>
      <div class="hero-container">
        <div class="hero-brand">
          <img src="logoNaueNeg.png" alt="NAUE Consultoria" class="hero-logo">
        </div>

        <!-- Layout com foto: side-by-side -->
        <div class="hero-content-wrapper" *ngIf="encontro.foto_encontro_url">
          <div class="hero-text-side">
            <div class="welcome-message">
              <div class="welcome-line-1">
                <span class="welcome-word">Olá,</span>
                <span class="welcome-name">{{ encontro.mentorado_nome }}!</span>
              </div>
              <div class="welcome-line-2">
                <span class="welcome-word">Bem-vindo(a)</span>
                <span class="welcome-word">ao</span>
                <span class="welcome-word">nosso</span>
                <span class="welcome-word">encontro!</span>
              </div>
            </div>

            <div class="hero-info">
              <div class="meta-info">
                <span class="meta-item">
                  <i class="fa-solid fa-hashtag"></i>
                  Encontro {{ encontro.numero_encontro }}
                </span>
                <span class="meta-item">
                  <i class="fa-solid fa-calendar"></i>
                  {{ formatDate(encontro.data_encontro) }}
                </span>
              </div>
            </div>
          </div>

          <div class="hero-photo-side">
            <img [src]="encontro.foto_encontro_url" [alt]="'Foto do Encontro ' + encontro.numero_encontro" class="encontro-photo">
          </div>
        </div>

        <!-- Layout sem foto: centralizado (layout original) -->
        <ng-container *ngIf="!encontro.foto_encontro_url">
          <div class="welcome-message">
            <div class="welcome-line-1">
              <span class="welcome-word">Olá,</span>
              <span class="welcome-name">{{ encontro.mentorado_nome }}!</span>
            </div>
            <div class="welcome-line-2">
              <span class="welcome-word">Bem-vindo(a)</span>
              <span class="welcome-word">ao</span>
              <span class="welcome-word">nosso</span>
              <span class="welcome-word">encontro!</span>
            </div>
          </div>

          <div class="hero-info">
            <div class="meta-info">
              <span class="meta-item">
                <i class="fa-solid fa-hashtag"></i>
                Encontro {{ encontro.numero_encontro }}
              </span>
              <span class="meta-item">
                <i class="fa-solid fa-calendar"></i>
                {{ formatDate(encontro.data_encontro) }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>
    </header>

    <!-- Seção de Visão Geral e Mentoria -->
    <section class="intro-section" *ngIf="conteudoEstruturado">
      <div class="intro-container">
        <!-- Visão Geral -->
        <div *ngIf="conteudoEstruturado.visaoGeral?.ativo && conteudoEstruturado.visaoGeral?.conteudo"
             class="intro-block visao-geral-block">
          <div class="intro-header">
            <div class="intro-icon">
              <i class="fa-solid fa-bullseye"></i>
            </div>
            <h2>Visão Geral</h2>
          </div>
          <div class="intro-content">
            <p>{{ conteudoEstruturado.visaoGeral.conteudo }}</p>
          </div>
        </div>

        <!-- Mentoria -->
        <div *ngIf="conteudoEstruturado.mentoria?.ativo && conteudoEstruturado.mentoria?.conteudo"
             class="intro-block mentoria-block">
          <div class="intro-header">
            <div class="intro-icon">
              <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <h2>Conteúdo da Mentoria</h2>
          </div>
          <div class="intro-content">
            <p>{{ conteudoEstruturado.mentoria.conteudo }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Testes Section -->
    <section class="dark-section testes-main-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.testes?.ativo && conteudoEstruturado.testes?.itens?.length > 0">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-clipboard-check"></i>
            Testes Realizados
          </h2>
        </div>
        <div class="testes-grid-new">
          <article *ngFor="let teste of conteudoEstruturado.testes.itens" class="teste-card">
            <h3>{{ teste.nome }}</h3>
            <div *ngIf="teste.imagemUrl" class="teste-img-new">
              <img [src]="teste.imagemUrl" [alt]="teste.nome">
            </div>
            <p *ngIf="teste.comentario">{{ teste.comentario }}</p>
          </article>
        </div>
      </div>
    </section>

    <!-- Próximos Passos Section -->
    <section class="dark-section proximos-passos-main-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.proximosPassos?.ativo && conteudoEstruturado.proximosPassos?.blocos?.length > 0">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-arrow-right"></i>
            Próximos Passos
          </h2>
        </div>
        <div class="passos-container">
          <div *ngFor="let bloco of conteudoEstruturado.proximosPassos.blocos" class="passo-card">

              <!-- Texto -->
              <div *ngIf="bloco.tipo === 'texto'" class="passo-texto-block">
                <div class="texto-indicator"></div>
                <div class="texto-content" [innerHTML]="bloco.conteudo"></div>
              </div>

              <!-- Perguntas -->
              <div *ngIf="bloco.tipo === 'perguntas' && bloco.perguntas?.length > 0" class="passo-perguntas-block">
                <div class="block-title">
                  <i class="fa-solid fa-question-circle"></i>
                  <span>Perguntas para Reflexão</span>
                </div>
                <div class="perguntas-container">
                  <div *ngFor="let pergunta of bloco.perguntas; let i = index" class="pergunta-item">
                    <div class="pergunta-num">{{ i + 1 }}</div>
                    <div class="pergunta-body">
                      <p class="pergunta-q" style="white-space: pre-wrap;">{{ pergunta.pergunta }}</p>
                      <textarea
                        class="pergunta-input"
                        [(ngModel)]="pergunta.respostaUsuario"
                        (blur)="salvarRespostaAutomaticamente(bloco, i)"
                        placeholder="Digite sua resposta aqui..."
                        rows="4"></textarea>
                    </div>
                  </div>
                </div>
                <div class="perguntas-actions">
                  <button
                    type="button"
                    class="btn-save-respostas"
                    (click)="salvarRespostas(bloco)"
                    [disabled]="savingInteractions">
                    <i class="fa-solid" [ngClass]="savingInteractions ? 'fa-circle-notch fa-spin' : 'fa-save'"></i>
                    {{ savingInteractions ? 'Salvando...' : 'Salvar Respostas' }}
                  </button>
                </div>
              </div>

              <!-- Tarefas -->
              <div *ngIf="bloco.tipo === 'tarefas' && bloco.tarefas?.itens?.length > 0" class="passo-tarefas-block">
                <div class="block-title">
                  <i class="fa-solid fa-list-check"></i>
                  <span>{{ bloco.tarefas.titulo || 'Tarefas' }}</span>
                </div>
                <ul class="tarefas-container">
                  <li *ngFor="let tarefa of bloco.tarefas.itens; let j = index">
                    <label class="tarefa-checkbox">
                      <input
                        type="checkbox"
                        [(ngModel)]="tarefa.checked"
                        (change)="salvarEstadoTarefa(bloco, j)">
                      <span class="checkbox-custom"></span>
                      <span class="tarefa-text">{{ tarefa.texto || tarefa }}</span>
                    </label>
                  </li>
                </ul>
              </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Referências Section -->
    <section class="dark-section referencias-main-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.referencias?.ativo && conteudoEstruturado.referencias?.itens?.length > 0">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-book"></i>
            Referências e Inspirações
          </h2>
        </div>
        <div class="referencias-grid">
          <a *ngFor="let ref of conteudoEstruturado.referencias.itens"
             [href]="ref.link"
             target="_blank"
             class="ref-card">
            <div class="ref-icon-new">
              <i class="fa-solid"
                 [ngClass]="{
                   'fa-play-circle': ref.tipo === 'ted',
                   'fa-book': ref.tipo === 'livro',
                   'fa-newspaper': ref.tipo === 'leitura'
                 }"></i>
            </div>
            <div class="ref-content-new">
              <span class="ref-type">{{ ref.tipo === 'ted' ? 'TED Talk' : ref.tipo === 'livro' ? 'Livro' : 'Leitura' }}</span>
              <h4>{{ ref.titulo }}</h4>
            </div>
            <i class="fa-solid fa-external-link-alt ref-external-new"></i>
          </a>
        </div>
      </div>
    </section>

    <!-- Mapa Mental Section -->
    <section class="dark-section mapa-mental-main-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.mapaMental?.ativo">
      <div class="dark-container">
        <div class="dark-header">
          <h2 class="dark-title">
            <i class="fa-solid fa-diagram-project"></i>
            Mapa Mental Estratégico
          </h2>
        </div>

        <!-- Controles -->
        <div class="mapa-mental-controls">
          <div class="controls-left">
            <button
              type="button"
              class="btn-add-nivel"
              (click)="adicionarNivelMapaMental()">
              <i class="fa-solid fa-plus"></i>
              Acrescentar Nível
            </button>
          </div>

          <div class="controls-right">
            <button
              type="button"
              class="btn-salvar-mapa"
              (click)="salvarMapaMentalManual()"
              [disabled]="salvandoMapaMental"
              title="Salvar alterações do mapa mental">
              <i class="fa-solid" [ngClass]="salvandoMapaMental ? 'fa-circle-notch fa-spin' : 'fa-save'"></i>
              {{ salvandoMapaMental ? 'Salvando...' : 'Salvar Mapa' }}
            </button>

            <!-- Dropdown de Exportação -->
            <div class="export-dropdown">
              <button
                type="button"
                class="btn-export-main"
                (click)="toggleExportDropdown()"
                [class.active]="showExportDropdown">
                <i class="fa-solid fa-download"></i>
                Exportar
                <i class="fa-solid fa-chevron-down dropdown-arrow" [class.rotated]="showExportDropdown"></i>
              </button>

              <div class="export-menu" *ngIf="showExportDropdown">
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalPNG()">
                  <i class="fa-solid fa-image"></i>
                  <span>Exportar como PNG</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalPDF()">
                  <i class="fa-solid fa-file-pdf"></i>
                  <span>Exportar como PDF</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalICS()">
                  <i class="fa-solid fa-calendar-plus"></i>
                  <span>Exportar para Agenda (.ics)</span>
                </button>
                <button
                  type="button"
                  class="export-option"
                  (click)="exportarMapaMentalMarkdown()">
                  <i class="fa-brands fa-markdown"></i>
                  <span>Exportar para Notion (Markdown)</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Colunas e Cards -->
        <div class="mapa-mental-container">
          <div *ngFor="let coluna of conteudoEstruturado.mapaMental.data.colunas; trackBy: trackByFn" class="mapa-mental-coluna">
            <!-- Cabeçalho da Coluna -->
            <div class="coluna-header" [ngClass]="coluna.corBg">
              <h3>{{ coluna.nome }}</h3>
              <div class="coluna-header-actions">
                <button
                  type="button"
                  class="btn-add-card"
                  (click)="adicionarCardMapaMental(coluna.id)"
                  title="Adicionar card">
                  <i class="fa-solid fa-plus"></i>
                </button>
                <button
                  *ngIf="podeRemoverNivel(coluna.id)"
                  type="button"
                  class="btn-remove-nivel"
                  (click)="removerNivelMapaMental(coluna.id)"
                  title="Remover nível">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>

            <!-- Cards -->
            <div
              class="coluna-cards"
              cdkDropList
              [cdkDropListData]="conteudoEstruturado.mapaMental.data.cards[coluna.id]"
              (cdkDropListDropped)="onCardDrop($event, coluna.id)">
              <div
                *ngFor="let card of conteudoEstruturado.mapaMental.data.cards[coluna.id]; trackBy: trackByFn"
                cdkDrag
                class="mapa-mental-card"
                [class.conectando]="mapaMentalConectando === card.id"
                [ngClass]="coluna.corBorda"
                [attr.id]="'card-' + card.id">

                <div class="card-body">
                  <!-- Meta -->
                  <div class="form-group">
                    <label>Meta</label>
                    <textarea
                      class="form-textarea"
                      [value]="card.meta"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'meta', $any($event.target).value)"
                      placeholder="Descreva a meta"
                      rows="2"></textarea>
                  </div>

                  <!-- Indicador de Sucesso -->
                  <div class="form-group">
                    <label>IS</label>
                    <textarea
                      class="form-textarea"
                      [value]="card.indicador"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'indicador', $any($event.target).value)"
                      placeholder="Indicador de sucesso"
                      rows="2"></textarea>
                  </div>

                  <!-- Prazo -->
                  <div class="form-group">
                    <label>Prazo</label>
                    <input
                      type="date"
                      class="form-input"
                      [value]="card.prazo"
                      (input)="atualizarCardMapaMental(coluna.id, card.id, 'prazo', $any($event.target).value)">
                  </div>

                  <!-- Ações do Card -->
                  <div class="card-actions">
                    <button
                      type="button"
                      class="btn-conectar"
                      [class.active]="mapaMentalConectando === card.id"
                      (click)="iniciarConexaoMapaMental(card.id)">
                      <i class="fa-solid fa-arrow-right"></i>
                      {{ mapaMentalConectando === card.id ? 'Conectando...' : 'Conectar' }}
                    </button>
                    <button
                      type="button"
                      class="btn-remove"
                      (click)="removerCardMapaMental(coluna.id, card.id)">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>

                  <!-- Conexões -->
                  <div *ngIf="obterConexoesDoCard(card.id).length > 0" class="card-conexoes">
                    <p class="conexoes-label">CONEXÕES:</p>
                    <div class="conexoes-badges">
                      <span
                        *ngFor="let conexao of obterConexoesDoCard(card.id); let i = index"
                        class="conexao-badge">
                        → {{ obterNomeColunaDoCard(conexao.para) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <p *ngIf="!conteudoEstruturado.mapaMental.data.cards[coluna.id] || conteudoEstruturado.mapaMental.data.cards[coluna.id].length === 0"
                 class="empty-state-small">
                Clique em + para adicionar um card
              </p>
            </div>
          </div>
        </div>

        <!-- Lista de Conexões -->
        <div *ngIf="conteudoEstruturado.mapaMental.data.conexoes.length > 0" class="conexoes-lista">
          <h3>Conexões Criadas</h3>
          <div
            *ngFor="let conexao of conteudoEstruturado.mapaMental.data.conexoes; let i = index"
            class="conexao-item">
            <div class="conexao-content">
              <div class="conexao-card-info">
                <strong class="conexao-meta">{{ obterCardPorId(conexao.de)?.meta || 'Card origem' }}</strong>
                <small class="conexao-nivel">{{ obterNomeColunaDoCard(conexao.de) }}</small>
              </div>
              <span class="conexao-arrow">→</span>
              <div class="conexao-card-info">
                <strong class="conexao-meta">{{ obterCardPorId(conexao.para)?.meta || 'Card destino' }}</strong>
                <small class="conexao-nivel">{{ obterNomeColunaDoCard(conexao.para) }}</small>
              </div>
            </div>
            <button
              type="button"
              class="btn-remove-conexao"
              (click)="removerConexaoMapaMental(i)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>

      </div>
    </section>

    <!-- Encerramento Section -->
    <section class="encerramento-final-section"
             *ngIf="conteudoEstruturado && conteudoEstruturado.encerramento?.ativo && conteudoEstruturado.encerramento?.conteudo">
      <div class="encerramento-container">
        <div class="encerramento-content-new">
          <p>{{ conteudoEstruturado.encerramento.conteudo }}</p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mentoria-footer">
      <p *ngIf="savingInteractions" class="saving-indicator">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        Salvando...
      </p>
      <p class="footer-info">
        <i class="fa-solid fa-shield-halved"></i>
        Suas informações são mantidas em sigilo
      </p>
      <p class="footer-copy">© {{ getCurrentYear() }} NAUE Consultoria - Todos os direitos reservados</p>
    </footer>

  </div>

  <!-- MODAL DE VISUALIZAÇÃO DE IMAGEM -->
  <div class="image-modal" *ngIf="modalImageSrc" (click)="closeImageModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <button class="image-modal-close" (click)="closeImageModal()">
        <i class="fas fa-times"></i>
      </button>
      <img [src]="modalImageSrc" alt="Imagem expandida">
    </div>
  </div>
</div>
