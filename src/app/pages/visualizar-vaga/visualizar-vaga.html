<div class="page-header">
  <h1 class="page-title">Acompanhamento R&S - {{ vaga?.clienteNome || 'Carregando...' }}</h1>
  <app-breadcrumb></app-breadcrumb>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="!isLoading && !vaga">
  <div class="error-icon">
    <i class="fas fa-exclamation-triangle"></i>
  </div>
  <h3>Vaga não encontrada</h3>
  <p>Não foi possível carregar os dados da vaga.</p>
  <button class="btn btn-primary" (click)="goBack()">
    <i class="fas fa-arrow-left"></i> Voltar para Recrutamento
  </button>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Carregando dados da vaga...</p>
</div>

<!-- Main Content -->
<div class="content" *ngIf="!isLoading && vaga">

  <!-- Unified Vaga Details Section -->
  <div class="vaga-details-unified">
    <!-- Vaga Overview Header -->
    <div class="vaga-overview-header">
      <!-- Action Buttons -->
      <div class="vaga-actions">
        <button class="btn-action-header" (click)="editVaga()" title="Editar Vaga">
          <i class="fas fa-edit"></i>
          Editar
        </button>
        <button class="btn-action-header" (click)="printVaga()" title="Imprimir Vaga">
          <i class="fas fa-print"></i>
          Imprimir
        </button>
        <button class="btn-action-header delete" (click)="deleteVaga()" title="Excluir Vaga">
          <i class="fas fa-trash"></i>
        </button>
      </div>

      <!-- Primary Info -->
      <div class="primary-info">
        <div class="vaga-header">
          <div class="vaga-logo-section">
            <div class="company-logo-wrapper">
              <img src="logoNaue.png" alt="NAUE Consultoria" class="company-logo">
            </div>
          </div>
          <div class="vaga-info">
            <h2 class="vaga-cargo">{{ vaga.cargo }}</h2>
            <div class="vaga-badges">
              <span class="type-badge">{{ tipoCargoLabels[vaga.tipoCargo] }}</span>
              <span class="status-badge" [attr.data-status]="vaga.status">
                {{ statusLabels[vaga.status] }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Meta Information -->
      <div class="meta-info">
        <div class="info-group">
          <span class="info-label">Cliente</span>
          <span class="info-value">{{ vaga.clienteNome || 'Não informado' }}</span>
        </div>
        <div class="info-group" *ngIf="vaga.contratoNumero">
          <span class="info-label">Contrato</span>
          <span class="info-value">{{ vaga.contratoNumero }}</span>
        </div>
        <div class="info-group">
          <span class="info-label">Consultora</span>
          <span class="info-value">{{ vaga.usuarioNome || 'Não informado' }}</span>
        </div>
        <div class="info-group">
          <span class="info-label">Tipo Abertura</span>
          <span class="info-value">{{ tipoAberturaLabels[vaga.tipoAbertura] }}</span>
        </div>
        <div class="info-group">
          <span class="info-label">Salário</span>
          <span class="info-value salary">{{ vaga.salario | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
        </div>
        <div class="info-group" *ngIf="vaga.pretensaoSalarial">
          <span class="info-label">Pretensão Salarial</span>
          <span class="info-value salary">{{ vaga.pretensaoSalarial | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
        </div>
        <div class="info-group" *ngIf="vaga.candidatoAprovado">
          <span class="info-label">Candidato Aprovado</span>
          <span class="info-value"><i class="fas fa-check-circle"></i> {{ vaga.candidatoAprovado }}</span>
        </div>
        <div class="info-group" *ngIf="vaga.sigilosa">
          <span class="info-label">Sigilo</span>
          <span class="info-value"><i class="fas fa-lock"></i> Vaga Sigilosa</span>
        </div>
        <div class="info-group">
          <span class="info-label">Data de Abertura</span>
          <span class="info-value">{{ vaga.dataAbertura | dateNoTimezone }}</span>
        </div>
        <div class="info-group" *ngIf="vaga.dataFechamentoCancelamento">
          <span class="info-label">Data de Fechamento</span>
          <span class="info-value">{{ vaga.dataFechamentoCancelamento | dateNoTimezone }}</span>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="vaga-content">


      <!-- Candidates Management Section -->
      <section class="content-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="fas fa-users"></i>
            Candidatos
          </h3>
          <button class="btn btn-primary btn-sm" (click)="openCandidatoModal()">
            <i class="fas fa-plus"></i> Adicionar Candidato
          </button>
        </div>

        <!-- Candidates List -->
        <div class="table-wrapper" *ngIf="candidatos.length > 0; else noCandidates">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>Data Inscrição</th>
                <th>Data Entrevista</th>
                <th>Horário</th>
                <th>Status Entrevista</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let vagaCandidato of candidatos">
                <td>
                  <div class="candidate-info">
                    <span class="candidate-name">{{ vagaCandidato.candidato.nome }}</span>
                  </div>
                </td>
                <td>
                  <a *ngIf="vagaCandidato.candidato.email"
                     href="mailto:{{ vagaCandidato.candidato.email }}"
                     class="email-link">
                    {{ vagaCandidato.candidato.email }}
                  </a>
                  <span *ngIf="!vagaCandidato.candidato.email" class="empty-text">-</span>
                </td>
                <td>
                  <span class="phone-text">{{ vagaCandidato.candidato.telefone || '-' }}</span>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="'status-' + (vagaCandidato.candidato.status || 'pendente')">
                    {{ (vagaCandidato.candidato.status || 'pendente') | titlecase }}
                  </span>
                </td>
                <td>
                  <span class="date-text">{{ vagaCandidato.data_inscricao | dateNoTimezone }}</span>
                </td>
                <td>
                  <span class="date-text" *ngIf="getLatestInterview(vagaCandidato)">
                    {{ getLatestInterview(vagaCandidato).data_entrevista | dateNoTimezone }}
                  </span>
                  <span class="empty-text" *ngIf="!getLatestInterview(vagaCandidato)">-</span>
                </td>
                <td>
                  <span class="time-text" *ngIf="getLatestInterview(vagaCandidato)">
                    {{ getLatestInterview(vagaCandidato).hora_entrevista | slice:0:5 }}
                  </span>
                  <span class="empty-text" *ngIf="!getLatestInterview(vagaCandidato)">-</span>
                </td>
                <td>
                  <select class="status-select"
                          *ngIf="getLatestInterview(vagaCandidato)"
                          [value]="getLatestInterview(vagaCandidato).status"
                          (change)="onInterviewStatusChange(vagaCandidato, $event)"
                          [ngClass]="'status-' + getLatestInterview(vagaCandidato).status">
                    <option value="agendada">Agendada</option>
                    <option value="realizada">Realizada</option>
                    <option value="cancelada">Cancelada</option>
                    <option value="nao_compareceu">Não Compareceu</option>
                    <option value="remarcada">Remarcada</option>
                  </select>
                  <span class="empty-text" *ngIf="!getLatestInterview(vagaCandidato)">-</span>
                </td>
                <td>
                  <div class="action-buttons-cell">
                    <div class="dropdown-menu-container">
                      <button class="action-btn menu-btn"
                              (click)="toggleCandidatoMenu(vagaCandidato.id, $event)"
                              title="Menu de Ações">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <div class="dropdown-menu"
                           *ngIf="openMenuId === vagaCandidato.id"
                           [style.top.px]="menuPosition.top"
                           [style.left.px]="menuPosition.left">
                        <button class="dropdown-item" (click)="openCandidatoModal(vagaCandidato.candidato); closeMenu()">
                          <i class="fas fa-edit"></i> Editar Candidato
                        </button>
                        <button class="dropdown-item" (click)="openObservacoesModal(vagaCandidato.candidato); closeMenu()">
                          <i class="fas fa-sticky-note"></i> Observações
                        </button>
                        <button class="dropdown-item" (click)="openEntrevistaModal(vagaCandidato); closeMenu()">
                          <i class="fas fa-calendar-plus"></i> Agendar Entrevista
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item delete" (click)="deleteCandidato(vagaCandidato); closeMenu()">
                          <i class="fas fa-trash"></i> Excluir Candidato
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noCandidates>
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <h4>Nenhum candidato cadastrado</h4>
            <p>Clique em "Adicionar Candidato" para começar a gerenciar candidatos para esta vaga.</p>
          </div>
        </ng-template>
      </section>


<!-- Observations Section -->
      <section class="content-section" *ngIf="vaga.observacoes">
        <h3 class="section-title">
          <i class="fas fa-comment-alt"></i>
          Observações
        </h3>

        <div class="notes-card">
          <p>{{ vaga.observacoes }}</p>
        </div>
      </section>

    </div>
  </div>

  <!-- Candidato Modal -->
  <app-candidato-modal
    [isOpen]="isCandidatoModalVisible"
    [candidato]="selectedCandidato"
    (modalClosed)="closeCandidatoModal()"
    (candidatoSaved)="onCandidatoSaved($event)">
  </app-candidato-modal>

  <!-- Entrevista Modal -->
  <app-entrevista-modal
    [isOpen]="isEntrevistaModalVisible"
    [entrevista]="selectedEntrevista"
    [vagaCandidatoId]="selectedVagaCandidato?.id || null"
    [candidatoNome]="selectedVagaCandidato?.candidato?.nome || ''"
    (modalClosed)="closeEntrevistaModal()"
    (entrevistaSaved)="onEntrevistaSaved($event)">
  </app-entrevista-modal>

  <!-- Observações Modal -->
  <app-observacoes-modal
    [isOpen]="isObservacoesModalVisible"
    [candidato]="selectedCandidatoForObservacoes"
    (modalClosed)="closeObservacoesModal()"
    (observacoesSaved)="onObservacoesSaved($event)">
  </app-observacoes-modal>

</div>