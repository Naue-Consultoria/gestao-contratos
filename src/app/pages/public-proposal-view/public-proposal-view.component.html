<div class="public-proposal-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Carregando proposta...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && proposal" class="proposal-content">
    
    <!-- Header -->
    <div class="proposal-header">
      <div class="client-info">
        <h1 class="client-name">{{ proposal.client.name }}</h1>
        <p class="client-details">
          <span *ngIf="proposal.client.headquarters">{{ proposal.client.headquarters }}</span>
          <span *ngIf="proposal.client.market_sector"> • {{ proposal.client.market_sector }}</span>
        </p>
      </div>
      
      <div class="proposal-status">
        <div class="status-badge" [ngClass]="'status-' + proposal.status">
          {{ getStatusText(proposal.status) }}
        </div>
        
        <div *ngIf="!proposalExpired && daysUntilExpiration !== null" class="validity-info">
          <i class="fas fa-clock"></i>
          <span *ngIf="daysUntilExpiration > 0">Válida por {{ daysUntilExpiration }} dias</span>
          <span *ngIf="daysUntilExpiration === 0" class="expiring-today">Expira hoje</span>
        </div>
        
        <div *ngIf="proposalExpired" class="validity-info expired">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Proposta expirada</span>
        </div>
      </div>
    </div>

    <!-- Proposal Info -->
    <div class="proposal-info">
      <h2 class="proposal-title">{{ proposal.title }}</h2>
      <p *ngIf="proposal.description" class="proposal-description">{{ proposal.description }}</p>
      
      <div class="proposal-meta">
        <div class="meta-item">
          <i class="fas fa-calendar"></i>
          <span>Enviada em {{ formatDate(proposal.sent_at) }}</span>
        </div>
        <div *ngIf="proposal.valid_until" class="meta-item">
          <i class="fas fa-hourglass-end"></i>
          <span>Válida até {{ formatDate(proposal.valid_until) }}</span>
        </div>
      </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step" [ngClass]="{'active': currentStep === 'view', 'completed': ['selecting', 'signing', 'confirming', 'completed'].includes(currentStep)}">
        <div class="step-number">1</div>
        <div class="step-label">Visualizar</div>
      </div>
      <div class="step" [ngClass]="{'active': currentStep === 'selecting', 'completed': ['signing', 'confirming', 'completed'].includes(currentStep)}">
        <div class="step-number">2</div>
        <div class="step-label">Selecionar</div>
      </div>
      <div class="step" [ngClass]="{'active': currentStep === 'signing', 'completed': ['confirming', 'completed'].includes(currentStep)}">
        <div class="step-number">3</div>
        <div class="step-label">Assinar</div>
      </div>
      <div class="step" [ngClass]="{'active': currentStep === 'confirming', 'completed': currentStep === 'completed'}">
        <div class="step-number">4</div>
        <div class="step-label">Confirmar</div>
      </div>
    </div>

    <!-- Total Value Summary -->
    <div class="total-summary">
      <div class="summary-card">
        <div class="summary-left">
          <h3 class="total-label">Valor Total da Proposta</h3>
          <p class="total-original">{{ formatCurrency(proposal.total_value) }}</p>
        </div>
        <div *ngIf="currentStep === 'selecting' || (currentStep !== 'view' && hasSelectedServices())" class="summary-right">
          <h3 class="selected-label">Valor Selecionado</h3>
          <p class="total-selected">{{ formatCurrency(getSelectedTotal()) }}</p>
        </div>
      </div>
    </div>

    <!-- Services List -->
    <div class="services-section">
      <h3 class="section-title">
        <i class="fas fa-briefcase"></i>
        Serviços da Proposta
        <span *ngIf="currentStep === 'selecting'" class="section-subtitle">
          Selecione os serviços que deseja contratar
        </span>
      </h3>
      
      <div class="services-list">
        <div *ngFor="let service of proposal.services" class="service-card" 
             [ngClass]="{'selected': isServiceSelected(service.service_id), 'selectable': currentStep === 'selecting'}">
          
          <!-- Service Selection Checkbox (only in selecting step) -->
          <div *ngIf="currentStep === 'selecting'" class="service-checkbox">
            <label class="checkbox-container">
              <input type="checkbox" 
                     [checked]="isServiceSelected(service.service_id)"
                     (change)="toggleService(service.service_id)">
              <span class="checkmark"></span>
            </label>
          </div>

          <!-- Service Details -->
          <div class="service-details">
            <div class="service-header">
              <h4 class="service-name">{{ service.service.name }}</h4>
              <div class="service-price">
                <span class="unit-price">{{ formatCurrency(getServiceValue(service)) }}</span>
                <span class="quantity">x{{ service.quantity }}</span>
                <span class="total-price">= {{ formatCurrency(getServiceTotal(service)) }}</span>
              </div>
            </div>
            
            <p *ngIf="service.service.description" class="service-description">
              {{ service.service.description }}
            </p>
            
            <div class="service-meta">
              <span *ngIf="service.service.duration_amount" class="duration">
                <i class="fas fa-clock"></i>
                {{ service.service.duration_amount }} {{ service.service.duration_unit }}
              </span>
              <span class="category">
                <i class="fas fa-tag"></i>
                {{ service.service.category }}
              </span>
            </div>

            <!-- Client Notes (only in selecting step) -->
            <div *ngIf="currentStep === 'selecting'" class="service-notes">
              <label>Observações sobre este serviço (opcional):</label>
              <textarea [ngModel]="getServiceNote(service.service_id)" 
                        (ngModelChange)="updateServiceNote(service.service_id, $event)"
                        placeholder="Adicione observações específicas sobre este serviço..."></textarea>
            </div>

            <!-- Show existing notes in other steps -->
            <div *ngIf="currentStep !== 'selecting' && getServiceNote(service.service_id)" class="existing-notes">
              <strong>Suas observações:</strong>
              <p>{{ getServiceNote(service.service_id) }}</p>
            </div>
          </div>

          <!-- Selection Indicator -->
          <div *ngIf="currentStep !== 'selecting' && isServiceSelected(service.service_id)" class="selected-indicator">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Observations -->
    <div *ngIf="proposal.observations" class="observations-section">
      <h3 class="section-title">
        <i class="fas fa-info-circle"></i>
        Observações e Termos
      </h3>
      <div class="observations-content">
        <p>{{ proposal.observations }}</p>
      </div>
    </div>

    <!-- Step Content -->
    <div class="step-content">
      
      <!-- View Step -->
      <div *ngIf="currentStep === 'view'" class="step-view">
        <div class="step-actions">
          <button class="btn btn-primary btn-lg" 
                  (click)="startServiceSelection()"
                  [disabled]="proposalExpired">
            <i class="fas fa-hand-pointer"></i>
            Selecionar Serviços
          </button>
          <button class="btn btn-outline-danger" 
                  (click)="rejectProposal()">
            <i class="fas fa-times"></i>
            Rejeitar Proposta
          </button>
        </div>
      </div>

      <!-- Selecting Step -->
      <div *ngIf="currentStep === 'selecting'" class="step-selecting">
        <div class="selecting-notes">
          <label>Observações gerais (opcional):</label>
          <textarea [(ngModel)]="clientObservations" 
                    placeholder="Adicione observações gerais sobre a proposta..." 
                    rows="3"></textarea>
        </div>
        
        <div class="step-actions">
          <button class="btn btn-secondary" 
                  (click)="currentStep = 'view'">
            <i class="fas fa-arrow-left"></i>
            Voltar
          </button>
          <button class="btn btn-primary btn-lg" 
                  (click)="saveServiceSelection()"
                  [disabled]="!hasSelectedServices() || isSubmitting">
            <i *ngIf="!isSubmitting" class="fas fa-check"></i>
            <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
            {{ isSubmitting ? 'Salvando...' : 'Continuar' }}
          </button>
        </div>
      </div>

      <!-- Signing Step -->
      <div *ngIf="currentStep === 'signing'" class="step-signing">
        <h3>Dados para Assinatura</h3>
        
        <form [formGroup]="signatureForm" class="signature-form">
          <div class="form-row">
            <div class="form-group">
              <label for="client_name" class="required">Nome Completo</label>
              <input id="client_name" 
                     type="text" 
                     formControlName="client_name" 
                     class="form-control"
                     [class.error]="isFieldInvalid(signatureForm, 'client_name')"
                     placeholder="Seu nome completo">
              <span class="error-message" *ngIf="isFieldInvalid(signatureForm, 'client_name')">
                Nome é obrigatório
              </span>
            </div>

            <div class="form-group">
              <label for="client_email" class="required">E-mail</label>
              <input id="client_email" 
                     type="email" 
                     formControlName="client_email" 
                     class="form-control"
                     [class.error]="isFieldInvalid(signatureForm, 'client_email')"
                     placeholder="seu@email.com">
              <span class="error-message" *ngIf="isFieldInvalid(signatureForm, 'client_email')">
                Email válido é obrigatório
              </span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="client_phone">Telefone</label>
              <input id="client_phone" 
                     type="tel" 
                     formControlName="client_phone" 
                     class="form-control"
                     placeholder="(00) 00000-0000">
            </div>

            <div class="form-group">
              <label for="client_document">CPF/CNPJ</label>
              <input id="client_document" 
                     type="text" 
                     formControlName="client_document" 
                     class="form-control"
                     placeholder="000.000.000-00">
            </div>
          </div>
        </form>

        <div class="signature-section">
          <h4>Assinatura Eletrônica</h4>
          <p class="signature-instruction">
            Desenhe sua assinatura no campo abaixo:
          </p>
          
          <div class="signature-canvas-container">
            <canvas #signatureCanvas 
                    class="signature-canvas"
                    (mousedown)="startDrawing($event)"
                    (mousemove)="draw($event)"
                    (mouseup)="stopDrawing()"
                    (mouseleave)="stopDrawing()"
                    (touchstart)="startTouchDrawing($event)"
                    (touchmove)="touchDraw($event)"
                    (touchend)="stopTouchDrawing($event)">
            </canvas>
            <div *ngIf="!signatureDrawn" class="signature-placeholder">
              Clique e arraste para assinar
            </div>
          </div>
          
          <div class="signature-actions">
            <button type="button" 
                    class="btn btn-outline-secondary" 
                    (click)="clearSignature()">
              <i class="fas fa-eraser"></i>
              Limpar
            </button>
          </div>
        </div>
        
        <div class="step-actions">
          <button class="btn btn-secondary" 
                  (click)="currentStep = 'selecting'">
            <i class="fas fa-arrow-left"></i>
            Voltar
          </button>
          <button class="btn btn-success btn-lg" 
                  (click)="signProposal()"
                  [disabled]="isSubmitting || !signatureDrawn">
            <i *ngIf="!isSubmitting" class="fas fa-signature"></i>
            <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
            {{ isSubmitting ? 'Assinando...' : 'Assinar Proposta' }}
          </button>
        </div>
      </div>

      <!-- Confirming Step -->
      <div *ngIf="currentStep === 'confirming'" class="step-confirming">
        <div class="confirmation-summary">
          <h3>Confirmação Final</h3>
          <p>Revise os dados antes de finalizar:</p>
          
          <!-- Selected Services Summary -->
          <div class="final-summary">
            <h4>Serviços Selecionados:</h4>
            <div class="final-services">
              <ng-container *ngFor="let service of proposal.services">
                <div class="final-service" *ngIf="isServiceSelected(service.service_id)">
                  <span class="service-name">{{ service.service.name }}</span>
                  <span class="service-quantity">{{ service.quantity }}x</span>
                  <span class="service-value">{{ formatCurrency(getServiceTotal(service)) }}</span>
                </div>
              </ng-container>
            </div>
            <div class="final-total">
              <strong>Total: {{ formatCurrency(getSelectedTotal()) }}</strong>
            </div>
          </div>
        </div>
        
        <form [formGroup]="confirmationForm" class="confirmation-form">
          <div class="form-group">
            <label>Observações Finais (opcional):</label>
            <textarea formControlName="client_observations" 
                      placeholder="Alguma observação adicional..." 
                      rows="3"></textarea>
          </div>
        </form>
        
        <div class="step-actions">
          <button class="btn btn-outline-danger" 
                  (click)="rejectProposal()">
            <i class="fas fa-times"></i>
            Rejeitar
          </button>
          <button class="btn btn-success btn-lg" 
                  (click)="confirmProposal()"
                  [disabled]="isSubmitting">
            <i *ngIf="!isSubmitting" class="fas fa-check-circle"></i>
            <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
            {{ isSubmitting ? 'Finalizando...' : 'Confirmar Proposta' }}
          </button>
        </div>
      </div>

      <!-- Completed Step -->
      <div *ngIf="currentStep === 'completed'" class="step-completed">
        <div class="success-message">
          <i class="fas fa-check-circle success-icon"></i>
          <h3>Proposta Confirmada com Sucesso!</h3>
          <p>Sua confirmação foi registrada e o administrador foi notificado.</p>
          <p>Em breve entraremos em contato para dar continuidade ao processo.</p>
        </div>
      </div>

      <!-- Rejected Step -->
      <div *ngIf="currentStep === 'rejected'" class="step-rejected">
        <div class="rejection-message">
          <i class="fas fa-times-circle rejection-icon"></i>
          <h3>Proposta Rejeitada</h3>
          <p>Sua rejeição foi registrada.</p>
          <p>Obrigado pelo tempo dedicado à análise de nossa proposta.</p>
        </div>
      </div>
      
    </div>

    <!-- Footer -->
    <footer class="proposal-footer">
      <p>&copy; {{ currentYear }} NAUE Consultoria. Todos os direitos reservados.</p>
      <p class="footer-info">
        Esta é uma proposta comercial confidencial. 
        Não compartilhe o link de acesso.
      </p>
    </footer>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !proposal" class="error-container">
    <i class="fas fa-exclamation-triangle"></i>
    <h2>Proposta não encontrada</h2>
    <p>O link que você acessou é inválido ou expirou.</p>
  </div>
</div>