<div class="page">
  <div class="page-header">
    <h1 class="page-title">Propostas</h1>
    <app-breadcrumb></app-breadcrumb>
  </div>

  <!-- Stats Cards -->
  <app-proposal-stats-cards></app-proposal-stats-cards>

  <div class="table-container">
    <div class="table-header">
      <h2 class="table-title">Lista de Propostas</h2>
      <button class="btn btn-primary" (click)="openNewProposalPage()">
        <i class="fas fa-plus"></i>
        Nova Proposta
      </button>
    </div>

    <!-- Mensagem de erro -->
    <div *ngIf="error" class="error-message">
      <i class="fas fa-exclamation-circle"></i>
      {{ error }}
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <i class="fas fa-spinner fa-spin"></i>
      Carregando propostas...
    </div>

    <!-- Tabela -->
    <div class="table-wrapper" *ngIf="!isLoading">
      <!-- Mensagem quando não há propostas -->
      <div *ngIf="proposals.length === 0 && !error" class="empty-state">
        <i class="fas fa-file-alt empty-icon"></i>
        <h3>Nenhuma proposta cadastrada</h3>
        <p>Clique no botão "Nova Proposta" para adicionar a primeira proposta.</p>
      </div>

      <!-- Tabela de propostas -->
      <table class="custom-table" *ngIf="proposals.length > 0">
        <thead>
          <tr>
            <th>Número da Proposta</th>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Valor Total</th>
            <th>Validade</th>
            <th>Criada em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let proposal of proposals"
            class="clickable"
            [class.expired]="proposal.isExpired"
            (click)="viewProposal(proposal.id)"
          >
            <td>
              <div class="proposal-info">
                <div class="proposal-icon" [class.expired]="proposal.isExpired">
                  <i class="fas fa-file-alt"></i>
                </div>
                <span class="proposal-number" [class.expired]="proposal.isExpired">
                  {{ proposal.proposalNumber }}
                </span>
              </div>
            </td>

            <td>
              <span class="client-name">{{ proposal.clientName }}</span>
            </td>

            <td>
              <span class="type-badge">{{ getProposalTypeText(proposal.raw.type) }}</span>
            </td>

            <td>
              <span
                class="status-badge"
                [style.background-color]="getStatusColor(proposal.status)"
              >
                {{ proposal.statusText }}
              </span>
            </td>
            <td>
              <span class="value-amount">{{ proposal.totalValue }}</span>
            </td>
            <td>
              <span class="validity-date">{{ proposal.validUntil }}</span>
            </td>
            <td>
              <span class="created-date">{{ proposal.createdAt }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <!-- Botão de Link Público/Gerar Link - condicional -->
                <button
                  *ngIf="proposal.raw.status === 'draft'"
                  class="action-btn generate-link-btn"
                  (click)="generatePublicLink(proposal, $event)"
                  title="Gerar Link Público"
                >
                  <i class="fas fa-external-link-alt"></i>
                </button>
                <button
                  *ngIf="proposal.raw.status === 'sent' || proposal.raw.status === 'signed' || proposal.raw.status === 'rejected' || proposal.raw.status === 'converted'"
                  class="action-btn link-btn"
                  (click)="copyPublicLink(proposal, $event)"
                  title="Copiar Link Público"
                >
                  <i class="fas fa-link"></i>
                </button>

                <!-- Botão Converter em Contrato - para propostas assinadas ou contrapropostas -->
                <button
                  *ngIf="proposal.raw.status === 'signed' || proposal.raw.status === 'contraproposta'"
                  class="action-btn convert-btn"
                  (click)="convertToContract(proposal, $event)"
                  title="Converter em Contrato"
                >
                  <i class="fas fa-file-contract"></i>
                </button>

                <!-- Dropdown Menu com 3 pontos -->
                <div class="dropdown" [class.open]="proposal.id === activeDropdownId">
                  <button
                    class="action-btn dropdown-btn"
                    (click)="toggleDropdown(proposal.id, $event)"
                    title="Mais ações"
                  >
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" *ngIf="proposal.id === activeDropdownId">
                    <!-- Editar - só se não estiver assinada -->
                    <button
                      *ngIf="proposal.raw.status !== 'signed' && proposal.raw.status !== 'converted'"
                      class="dropdown-item"
                      (click)="editProposal(proposal.id); closeDropdown()"
                    >
                      <i class="fas fa-edit"></i>
                      <span>Editar</span>
                    </button>
                    
                    <!-- Gerar PDF -->
                    <button
                      class="dropdown-item"
                      (click)="generatePDF(proposal, $event); closeDropdown()"
                    >
                      <i class="fas fa-file-pdf"></i>
                      <span>Gerar PDF</span>
                    </button>
                    
                    <!-- Excluir -->
                    <button
                      class="dropdown-item delete-item"
                      (click)="deleteProposal(proposal, $event); closeDropdown()"
                    >
                      <i class="fas fa-trash"></i>
                      <span>Excluir</span>
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Send Proposal Modal -->
<app-send-proposal-modal
  [proposal]="selectedProposalForSending"
  [isVisible]="showSendModal"
  (onClose)="onSendModalClose()"
  (onProposalSent)="onProposalSent($event)">
</app-send-proposal-modal>

<!-- Delete Confirmation Modal -->
<app-delete-confirmation-modal
  [isVisible]="showDeleteModal"
  [title]="'Confirmar Exclusão de Proposta'"
  [message]="'Tem certeza que deseja excluir esta proposta? Esta ação não pode ser desfeita.'"
  [itemName]="selectedProposalForDeletion ? selectedProposalForDeletion.proposalNumber + ' - ' + selectedProposalForDeletion.clientName : ''"
  [isDeleting]="isDeleting"
  [deleteButtonText]="'Excluir Proposta'"
  (onConfirm)="confirmDeleteProposal()"
  (onCancel)="cancelDeleteProposal()">
</app-delete-confirmation-modal>

<!-- Convert to Contract Modal -->
<app-proposal-to-contract-modal
  [isOpen]="showConvertModal"
  [proposal]="selectedProposalForConversion"
  (close)="closeConvertModal()"
  (converted)="onConversionCompleted($event)">
</app-proposal-to-contract-modal>