<!-- Page Header with Breadcrumb -->
<div class="page-header">
  <h1 class="page-title">Planejamento Estratégico</h1>
  <app-breadcrumb></app-breadcrumb>
</div>

<!-- Table Container -->
<div class="table-container">
  <div class="table-header">
    <h2 class="table-title">Planejamentos Estratégicos</h2>

    <!-- Filters -->
    <div class="filters-row">
      <!-- Search Input -->
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          class="search-input"
          placeholder="Buscar por título, cliente, contrato..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        />
        <button
          *ngIf="searchTerm"
          class="clear-search-btn"
          (click)="clearSearch()"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Status Filter -->
      <select
        class="status-filter"
        [(ngModel)]="statusFilter"
        (change)="onStatusFilterChange()"
      >
        <option value="todos">Todos os Status</option>
        <option value="ativo">Ativo</option>
        <option value="concluido">Concluído</option>
        <option value="cancelado">Cancelado</option>
      </select>
    </div>

    <!-- Action Button -->
    <button class="btn btn-primary" (click)="novoPlanejamento()">
      <i class="fas fa-plus"></i>
      Novo Planejamento
    </button>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-message">
    <i class="fas fa-exclamation-circle"></i>
    {{ error }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>
    Carregando planejamentos...
  </div>

  <!-- Table -->
  <div class="table-wrapper" *ngIf="!isLoading">
    <!-- Empty State -->
    <div *ngIf="filteredPlanejamentos.length === 0" class="empty-state">
      <i class="fas fa-chess empty-icon"></i>
      <h3>{{ searchTerm || statusFilter !== 'todos' ? 'Nenhum planejamento encontrado' : 'Nenhum planejamento cadastrado' }}</h3>
      <p *ngIf="!searchTerm && statusFilter === 'todos'">Clique em "Novo Planejamento" para começar.</p>
      <p *ngIf="searchTerm || statusFilter !== 'todos'">Tente ajustar os filtros de busca.</p>
    </div>

    <!-- Table -->
    <table class="data-table" *ngIf="filteredPlanejamentos.length > 0">
      <thead>
        <tr>
          <th>Título</th>
          <th>Cliente</th>
          <th>Contrato</th>
          <th>Prazo Preenchimento</th>
          <th>Status</th>
          <th class="actions-column">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let planejamento of filteredPlanejamentos"
          (click)="visualizarPlanejamento(planejamento.id)"
          class="table-row-clickable"
        >
          <td class="titulo-cell" data-label="Título">
            <strong>{{ planejamento.titulo }}</strong>
          </td>
          <td data-label="Cliente">{{ getClientName(planejamento) }}</td>
          <td data-label="Contrato">{{ planejamento.contract?.contract_number || 'N/A' }}</td>
          <td data-label="Prazo Preenchimento">
            <span
              [class.prazo-vencido]="isPrazoVencido(planejamento.prazo_preenchimento)"
            >
              {{ planejamento.prazo_preenchimento ? formatDate(planejamento.prazo_preenchimento) : '-' }}
              <span *ngIf="isPrazoVencido(planejamento.prazo_preenchimento)" class="badge-danger small-badge">Vencido</span>
            </span>
          </td>
          <td data-label="Status">
            <span
              class="status-badge"
              [ngClass]="getStatusBadgeClass(planejamento.status)"
            >
              {{ getStatusLabel(planejamento.status) }}
            </span>
          </td>
          <td class="actions-cell" data-label="Ações">
            <div class="action-menu">
              <button
                class="btn-menu"
                (click)="toggleMenu(planejamento.id); $event.stopPropagation()"
                title="Mais opções"
              >
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="dropdown-menu" *ngIf="openMenuId === planejamento.id" (click)="$event.stopPropagation()">
                <button class="dropdown-item" (click)="editarPlanejamento(planejamento.id); closeMenu()">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <button class="dropdown-item" (click)="copiarLinkPublico(planejamento, $event); closeMenu()">
                  <i class="fas fa-link"></i> Copiar Link Público
                </button>
                <button class="dropdown-item dropdown-item-danger" (click)="openDeleteModal(planejamento, $event); closeMenu()">
                  <i class="fas fa-trash"></i> Excluir
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o planejamento estratégico <strong>{{ planejamentoToDelete?.titulo }}</strong>?</p>
      <p class="warning-text">
        <i class="fas fa-exclamation-triangle"></i>
        Esta ação também excluirá todos os departamentos e matrizes associadas. Esta ação não pode ser desfeita.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDelete()">Excluir</button>
    </div>
  </div>
</div>
