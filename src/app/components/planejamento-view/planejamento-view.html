<div class="page-header">
  <h1 class="page-title">Detalhes do Planejamento Estratégico</h1>
  <app-breadcrumb></app-breadcrumb>
</div>

<div *ngIf="error" class="error-message">
  <i class="fas fa-exclamation-circle"></i>
  {{ error }}
</div>

<div *ngIf="isLoading" class="loading-container">
  <i class="fas fa-spinner fa-spin"></i>
  Carregando...
</div>

<div *ngIf="!isLoading && planejamento" class="content">
  <!-- Info Card -->
  <div class="info-card">
    <div class="card-header">
      <div>
        <h2>{{ planejamento.titulo }}</h2>
        <span class="status-badge" [ngClass]="getStatusBadgeClass(planejamento.status)">
          {{ getStatusLabel(planejamento.status) }}
        </span>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" (click)="editarPlanejamento()">
          <i class="fas fa-edit"></i> Editar
        </button>
      </div>
    </div>

    <div class="card-body">
      <div class="info-row">
        <strong>Cliente:</strong> {{ getClientName() }}
      </div>
      <div class="info-row">
        <strong>Contrato:</strong> {{ planejamento.contract?.contract_number }}
      </div>
      <div class="info-row" *ngIf="planejamento.descricao">
        <strong>Descrição:</strong> {{ planejamento.descricao }}
      </div>
      <div class="info-row" *ngIf="planejamento.data_inicio">
        <strong>Período:</strong> {{ formatDate(planejamento.data_inicio) }}
        <span *ngIf="planejamento.data_fim">- {{ formatDate(planejamento.data_fim) }}</span>
      </div>
      <div class="info-row" *ngIf="planejamento.prazo_preenchimento">
        <strong>Prazo Preenchimento:</strong>
        <span [class.text-danger]="isPrazoVencido()">
          {{ formatDate(planejamento.prazo_preenchimento) }}
          <span *ngIf="isPrazoVencido()" class="badge-danger">Vencido</span>
        </span>
      </div>
      <div class="info-row">
        <strong>Progresso de Preenchimento:</strong>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getMatrizPreenchimentoPercentage()"></div>
        </div>
        <span>{{ getMatrizPreenchimentoPercentage() }}% ({{ getMatrizesPreenchidas() }}/{{ departamentos.length }})</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button
      class="tab-button"
      [class.active]="activeTab === 'arvore-problemas'"
      (click)="activeTab = 'arvore-problemas'; loadArvores()">
      <i class="fas fa-project-diagram"></i> Árvore de Problemas
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'departamentos'"
      (click)="activeTab = 'departamentos'">
      <i class="fas fa-building"></i> Departamentos (Matriz Consciente)
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'grupos'"
      (click)="activeTab = 'grupos'; loadGrupos()">
      <i class="fas fa-users"></i> Grupos (Matriz SWOT)
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'okrs'"
      (click)="activeTab = 'okrs'; loadOkrs()">
      <i class="fas fa-bullseye"></i> Objetivos Estratégicos
    </button>
  </div>

  <!-- Departamentos -->
  <div class="section" *ngIf="activeTab === 'departamentos'">
    <div class="section-header">
      <h3>Departamentos</h3>
      <div class="section-actions">
        <button class="btn btn-primary btn-sm" (click)="visualizarPlanejamento()">
          <i class="fas fa-eye"></i> Visualizar Público
        </button>
        <button class="btn btn-primary btn-sm" (click)="copiarLinkPublico()">
          <i class="fas fa-link"></i> Copiar Link
        </button>
        <button class="btn btn-primary" (click)="openNovoDepartamentoModal()">
          <i class="fas fa-plus"></i> Novo Departamento
        </button>
      </div>
    </div>

    <div *ngIf="departamentos.length === 0" class="empty-state">
      <i class="fas fa-building"></i>
      <p>Nenhum departamento cadastrado</p>
    </div>

    <div class="departamentos-grid" *ngIf="departamentos.length > 0">
      <div *ngFor="let dep of departamentos" class="dep-card">
        <div class="dep-header">
          <h4>{{ dep.nome_departamento }}</h4>
          <div class="dep-actions">
            <button class="btn-menu" (click)="toggleMenu(dep.id)" title="Mais opções">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="dropdown-menu" *ngIf="openMenuId === dep.id">
              <button class="dropdown-item" (click)="openEditarDepartamentoModal(dep); closeMenu()">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button class="dropdown-item dropdown-item-danger" (click)="openDeleteModal(dep); closeMenu()">
                <i class="fas fa-trash"></i> Excluir
              </button>
            </div>
          </div>
        </div>
        <div class="dep-body">
          <div *ngIf="dep.responsavel_nome">
            <i class="fas fa-user"></i> {{ dep.responsavel_nome }}
          </div>
          <div *ngIf="dep.responsavel_email">
            <i class="fas fa-envelope"></i> {{ dep.responsavel_email }}
          </div>
          <div class="matriz-status">
            <span *ngIf="isMatrizPreenchida(dep)" class="badge-success">
              <i class="fas fa-check-circle"></i> Matriz Preenchida
            </span>
            <span *ngIf="!isMatrizPreenchida(dep)" class="badge-warning">
              <i class="fas fa-clock"></i> Aguardando Preenchimento
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Grupos (Matriz SWOT) -->
  <div class="section" *ngIf="activeTab === 'grupos'">
    <div class="section-header">
      <h3>Grupos</h3>
      <div class="section-actions">
        <button class="btn btn-primary btn-sm" (click)="visualizarConsolidado()" *ngIf="grupos.length > 0">
          <i class="fas fa-th"></i> Ver Consolidado
        </button>
        <button class="btn btn-primary btn-sm" (click)="visualizarCruzamento()" *ngIf="grupos.length > 0">
          <i class="fas fa-project-diagram"></i> Definição de Impacto
        </button>
        <button class="btn btn-primary" (click)="openNovoGrupoModal()">
          <i class="fas fa-plus"></i> Novo Grupo
        </button>
      </div>
    </div>

    <div *ngIf="grupos.length === 0" class="empty-state">
      <i class="fas fa-users"></i>
      <p>Nenhum grupo cadastrado</p>
    </div>

    <div class="departamentos-grid" *ngIf="grupos.length > 0">
      <div *ngFor="let grupo of grupos" class="dep-card">
        <div class="dep-header">
          <h4>{{ grupo.nome_grupo }}</h4>
          <div class="dep-actions">
            <button class="btn-menu" (click)="toggleGrupoMenu(grupo.id)" title="Mais opções">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="dropdown-menu" *ngIf="openGrupoMenuId === grupo.id">
              <button class="dropdown-item" (click)="visualizarGrupo(grupo); closeGrupoMenu()">
                <i class="fas fa-eye"></i> Visualizar
              </button>
              <button class="dropdown-item" (click)="copiarLinkGrupo(grupo); closeGrupoMenu()">
                <i class="fas fa-link"></i> Copiar Link do Grupo
              </button>
              <button class="dropdown-item" (click)="openEditarGrupoModal(grupo); closeGrupoMenu()">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button class="dropdown-item dropdown-item-danger" (click)="openDeleteGrupoModal(grupo); closeGrupoMenu()">
                <i class="fas fa-trash"></i> Excluir
              </button>
            </div>
          </div>
        </div>
        <div class="dep-body">
          <div *ngIf="grupo.integrantes" class="integrantes-row">
            <i class="fas fa-users"></i> {{ grupo.integrantes }}
          </div>
          <div class="matriz-status">
            <span *ngIf="isMatrizSwotPreenchida(grupo)" class="badge-success">
              <i class="fas fa-check-circle"></i> Matriz Preenchida
            </span>
            <span *ngIf="!isMatrizSwotPreenchida(grupo)" class="badge-warning">
              <i class="fas fa-clock"></i> Aguardando Preenchimento
            </span>
          </div>
          <div class="grupo-actions">
            <button class="btn btn-sm btn-primary" (click)="visualizarGrupo(grupo)">
              <i class="fas fa-eye"></i> Visualizar
            </button>
            <button class="btn btn-sm btn-primary" (click)="copiarLinkGrupo(grupo)">
              <i class="fas fa-link"></i> Copiar Link
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Objetivos Estratégicos -->
  <div class="section" *ngIf="activeTab === 'okrs'">
    <div class="section-header">
      <h3>Objetivos Estratégicos</h3>
    </div>

    <!-- Formulário inline para adicionar objetivo -->
    <div class="add-okr-inline">
      <input
        type="text"
        [(ngModel)]="novoObjetivo"
        class="form-control"
        placeholder="Digite um novo objetivo..."
        (keyup.enter)="adicionarNovoOkr()">
      <button class="btn btn-primary" (click)="adicionarNovoOkr()">
        <i class="fas fa-plus"></i> Adicionar
      </button>
    </div>

    <div *ngIf="okrs.length === 0" class="empty-state">
      <i class="fas fa-bullseye"></i>
      <p>Nenhum objetivo cadastrado</p>
    </div>

    <div *ngIf="okrs.length > 0" class="okrs-table-container">
      <table class="okrs-table">
        <thead>
          <tr>
            <th style="width: 10%;">#</th>
            <th style="width: 65%;">Objetivo</th>
            <th style="width: 25%;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let okr of okrs; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <div *ngIf="editingOkrId !== okr.id">{{ okr.objetivo }}</div>
              <div *ngIf="editingOkrId === okr.id" class="editing-row">
                <input
                  type="text"
                  [(ngModel)]="editingOkrText"
                  class="form-control form-control-sm"
                  (keyup.enter)="salvarEdicaoOkr(okr.id)"
                  (keyup.escape)="cancelarEdicaoOkr()">
                <button class="btn btn-sm btn-primary" (click)="salvarEdicaoOkr(okr.id)" title="Salvar">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="cancelarEdicaoOkr()" title="Cancelar">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </td>
            <td>
              <div class="okr-actions" *ngIf="editingOkrId !== okr.id">
                <button class="btn btn-sm btn-white" (click)="iniciarEdicaoOkr(okr)" title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="openDeleteOkrModal(okr)" title="Excluir">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Árvore de Problemas -->
  <div class="section" *ngIf="activeTab === 'arvore-problemas'">
    <div class="section-header">
      <h3>Árvore de Problemas</h3>
    </div>

    <!-- Formulário inline para criar nova árvore -->
    <div class="add-arvore-inline">
      <input
        type="text"
        [(ngModel)]="novaArvoreNome"
        class="form-control"
        placeholder="Digite o nome da nova árvore..."
        (keyup.enter)="criarNovaArvore()">
      <button class="btn btn-primary" (click)="criarNovaArvore()">
        <i class="fas fa-plus"></i> Criar Árvore
      </button>
    </div>

    <div *ngIf="arvores.length === 0" class="empty-state">
      <i class="fas fa-project-diagram"></i>
      <p>Nenhuma árvore cadastrada</p>
    </div>

    <!-- Lista de Árvores -->
    <div *ngIf="arvores.length > 0" class="arvores-container">
      <div *ngFor="let arvore of arvores" class="arvore-card">
        <!-- Cabeçalho da Árvore -->
        <div class="arvore-header">
          <div class="arvore-title-row" (click)="toggleArvore(arvore.id)">
            <i class="fas" [ngClass]="isArvoreExpanded(arvore.id) ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
            <h4>{{ arvore.nome_arvore }}</h4>
            <span class="badge badge-info">{{ getItensArvore(arvore.id).length }} itens</span>
          </div>
          <div class="arvore-header-actions">
            <button class="btn-menu" (click)="toggleArvoreMenu(arvore.id)" title="Mais opções">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="dropdown-menu" *ngIf="openArvoreMenuId === arvore.id">
              <button class="dropdown-item dropdown-item-danger" (click)="openDeleteArvoreModal(arvore); closeArvoreMenu()">
                <i class="fas fa-trash"></i> Excluir Árvore
              </button>
            </div>
          </div>
        </div>

        <!-- Conteúdo da Árvore -->
        <div class="arvore-body" *ngIf="isArvoreExpanded(arvore.id)">
          <div class="arvore-body-header">
            <button class="btn btn-sm btn-primary" (click)="adicionarNovaLinha(arvore.id)">
              <i class="fas fa-plus"></i> Adicionar Linha
            </button>
          </div>

          <div *ngIf="getItensArvore(arvore.id).length === 0" class="empty-state-small">
            <p>Nenhum item adicionado nesta árvore</p>
          </div>

          <div *ngIf="getItensArvore(arvore.id).length > 0" class="arvore-table-container">
            <table class="arvore-table">
              <thead>
                <tr>
                  <th style="width: 30%;">Tópico</th>
                  <th style="width: 35%;">Pergunta Norteadora</th>
                  <th style="width: 7%;">Gravidade</th>
                  <th style="width: 7%;">Urgência</th>
                  <th style="width: 7%;">Tendência</th>
                  <th style="width: 7%;">Nota</th>
                  <th style="width: 7%;">Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of getItensArvore(arvore.id); let i = index">
                  <ng-container *ngIf="!isItemEditing(arvore.id, i)">
                    <td>{{ item.topico }}</td>
                    <td>{{ item.pergunta_norteadora || '-' }}</td>
                    <td class="text-center">{{ formatarNumero(item.gravidade) }}</td>
                    <td class="text-center">{{ formatarNumero(item.urgencia) }}</td>
                    <td class="text-center">{{ formatarNumero(item.tendencia) }}</td>
                    <td class="text-center" [ngClass]="{'nota-alta': item.nota > 20}">{{ formatarNumero(item.nota) }}</td>
                    <td>
                      <button class="btn btn-sm btn-danger" (click)="openDeleteItemModal(item, arvore.id)" title="Excluir">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </ng-container>
                  <ng-container *ngIf="isItemEditing(arvore.id, i)">
                    <td>
                      <input type="text" [(ngModel)]="getEditingItem(arvore.id).topico" class="form-control form-control-sm" placeholder="Tópico">
                    </td>
                    <td>
                      <input type="text" [(ngModel)]="getEditingItem(arvore.id).pergunta_norteadora" class="form-control form-control-sm" placeholder="Pergunta norteadora">
                    </td>
                    <td>
                      <input type="text" [(ngModel)]="getEditingItem(arvore.id).gravidade" class="form-control form-control-sm text-center" placeholder="1-5">
                    </td>
                    <td>
                      <input type="text" [(ngModel)]="getEditingItem(arvore.id).urgencia" class="form-control form-control-sm text-center" placeholder="1-5">
                    </td>
                    <td>
                      <input type="text" [(ngModel)]="getEditingItem(arvore.id).tendencia" class="form-control form-control-sm text-center" placeholder="1-5">
                    </td>
                    <td class="text-center">-</td>
                    <td>
                      <div class="arvore-actions">
                        <button class="btn btn-sm btn-primary" (click)="salvarItem(arvore.id, i)" title="Salvar">
                          <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" (click)="cancelarEdicaoItem(arvore.id)" title="Cancelar">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </td>
                  </ng-container>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Pilares de Dor -->
    <div *ngIf="arvores.length > 0 && getPilaresDeDor().length > 0" class="pilares-dor-section">
      <h3 class="pilares-title">
        <i class="fas fa-exclamation-triangle"></i> Pilares de Dor
      </h3>

      <ul class="pilares-list">
        <li *ngFor="let pilar of getPilaresDeDor()">{{ pilar.topico }}</li>
      </ul>
    </div>
  </div>
</div>

<!-- Modal Departamento -->
<div class="modal-overlay" *ngIf="showDepartamentoModal" (click)="closeDepartamentoModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditingDepartamento ? 'Editar' : 'Novo' }} Departamento</h2>
      <button class="modal-close" (click)="closeDepartamentoModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome do Departamento *</label>
        <input type="text" [(ngModel)]="departamentoForm.nome_departamento" class="form-control" placeholder="Ex: Financeiro">
      </div>
      <div class="form-group">
        <label>Responsável</label>
        <input type="text" [(ngModel)]="departamentoForm.responsavel_nome" class="form-control" placeholder="Nome do responsável">
      </div>
      <div class="form-group">
        <label>E-mail do Responsável</label>
        <input type="email" [(ngModel)]="departamentoForm.responsavel_email" class="form-control" placeholder="email@exemplo.com">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDepartamentoModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveDepartamento()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Delete Departamento -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o departamento <strong>{{ departamentoToDelete?.nome_departamento }}</strong>?</p>
      <p class="text-warning">A matriz associada também será excluída.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDeleteDepartamento()">Excluir</button>
    </div>
  </div>
</div>

<!-- Modal Grupo -->
<div class="modal-overlay" *ngIf="showGrupoModal" (click)="closeGrupoModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditingGrupo ? 'Editar' : 'Novo' }} Grupo</h2>
      <button class="modal-close" (click)="closeGrupoModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome do Grupo *</label>
        <input type="text" [(ngModel)]="grupoForm.nome_grupo" class="form-control" placeholder="Ex: Grupo 1">
      </div>
      <div class="form-group">
        <label>Integrantes</label>
        <textarea [(ngModel)]="grupoForm.integrantes" class="form-control" placeholder="Nome dos integrantes (separados por vírgula ou quebra de linha)" rows="4"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeGrupoModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveGrupo()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Delete Grupo -->
<div class="modal-overlay" *ngIf="showDeleteGrupoModal" (click)="closeDeleteGrupoModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteGrupoModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o grupo <strong>{{ grupoToDelete?.nome_grupo }}</strong>?</p>
      <p class="text-warning">A matriz SWOT associada também será excluída.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteGrupoModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDeleteGrupo()">Excluir</button>
    </div>
  </div>
</div>

<!-- Modal Delete Objetivo Estratégico -->
<div class="modal-overlay" *ngIf="showDeleteOkrModal" (click)="closeDeleteOkrModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteOkrModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o objetivo estratégico <strong>{{ okrToDelete?.objetivo }}</strong>?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteOkrModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDeleteOkr()">Excluir</button>
    </div>
  </div>
</div>

<!-- Modal Delete Árvore -->
<div class="modal-overlay" *ngIf="showDeleteArvoreModal" (click)="closeDeleteArvoreModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteArvoreModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir a árvore <strong>{{ arvoreToDelete?.nome_arvore }}</strong>?</p>
      <p class="text-warning">Todos os itens desta árvore também serão excluídos.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteArvoreModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDeleteArvore()">Excluir</button>
    </div>
  </div>
</div>

<!-- Modal Delete Item Árvore de Problemas -->
<div class="modal-overlay" *ngIf="showDeleteItemModal" (click)="closeDeleteItemModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmar Exclusão</h2>
      <button class="modal-close" (click)="closeDeleteItemModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o item <strong>{{ itemToDelete?.topico }}</strong>?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteItemModal()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmDeleteItem()">Excluir</button>
    </div>
  </div>
</div>
