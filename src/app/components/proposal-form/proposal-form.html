  <div class="page-header">
    <h1 class="page-title">{{ isEditMode ? 'Editar Proposta' : 'Nova Proposta' }}</h1>
    <div class="breadcrumb">
      <a routerLink="/home" class="breadcrumb-link">Home</a>
      <span class="breadcrumb-separator">/</span>
      <a routerLink="/proposals" class="breadcrumb-link" (click)="cancel()">Propostas</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">{{ isEditMode ? 'Editar' : 'Nova' }}</span>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Carregando dados...</span>
  </div>

  <div class="form-container" *ngIf="!isLoading">
    <form [formGroup]="proposalForm" (ngSubmit)="onSubmit()">
      
      <!-- Client Information Section - FIRST -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-user-tie"></i>Informações do Cliente</h2>
        <p class="section-description">Dados da pessoa ou empresa que receberá a proposta.</p>
        <div class="form-grid">
          <div class="form-group">
            <label for="client_name" class="form-label required">Nome / Razão Social</label>
            <input id="client_name" type="text" formControlName="client_name" class="form-control" placeholder="Nome completo ou razão social" [class.error]="isFieldInvalid('client_name')">
            <div *ngIf="isFieldInvalid('client_name')" class="error-message">Nome é obrigatório (mínimo 3 caracteres).</div>
          </div>
          <div class="form-group">
            <label for="client_email" class="form-label required">Email</label>
            <input id="client_email" type="email" formControlName="client_email" class="form-control" placeholder="email@exemplo.com" [class.error]="isFieldInvalid('client_email')">
            <div *ngIf="isFieldInvalid('client_email')" class="error-message">Email válido é obrigatório.</div>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="client_phone" class="form-label">Telefone</label>
            <input id="client_phone" type="tel" formControlName="client_phone" class="form-control" placeholder="(11) 99999-9999">
          </div>
          <div class="form-group">
            <label for="client_document" class="form-label required">CPF / CNPJ</label>
            <input id="client_document" type="text" formControlName="client_document" class="form-control" placeholder="000.000.000-00 ou 00.000.000/0001-00" [class.error]="isFieldInvalid('client_document')">
            <div *ngIf="isFieldInvalid('client_document')" class="error-message">Documento é obrigatório.</div>
          </div>
        </div>
      </div>

      <!-- Client Address Section -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-map-marker-alt"></i>Endereço do Cliente</h2>
        <p class="section-description">Endereço completo para correspondência e contrato.</p>
        <div class="form-grid">
          <div class="form-group col-3">
            <label for="client_street" class="form-label required">Logradouro</label>
            <input id="client_street" type="text" formControlName="client_street" class="form-control" placeholder="Rua, Avenida, etc." [class.error]="isFieldInvalid('client_street')">
            <div *ngIf="isFieldInvalid('client_street')" class="error-message">Logradouro é obrigatório.</div>
          </div>
          <div class="form-group col-1">
            <label for="client_number" class="form-label required">Número</label>
            <input id="client_number" type="text" formControlName="client_number" class="form-control" placeholder="123" [class.error]="isFieldInvalid('client_number')">
            <div *ngIf="isFieldInvalid('client_number')" class="error-message">Número é obrigatório.</div>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="client_complement" class="form-label">Complemento</label>
            <input id="client_complement" type="text" formControlName="client_complement" class="form-control" placeholder="Apto, Sala, etc.">
          </div>
          <div class="form-group">
            <label for="client_neighborhood" class="form-label required">Bairro</label>
            <input id="client_neighborhood" type="text" formControlName="client_neighborhood" class="form-control" placeholder="Nome do bairro" [class.error]="isFieldInvalid('client_neighborhood')">
            <div *ngIf="isFieldInvalid('client_neighborhood')" class="error-message">Bairro é obrigatório.</div>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="client_city" class="form-label required">Cidade</label>
            <input id="client_city" type="text" formControlName="client_city" class="form-control" placeholder="Nome da cidade" [class.error]="isFieldInvalid('client_city')">
            <div *ngIf="isFieldInvalid('client_city')" class="error-message">Cidade é obrigatória.</div>
          </div>
          <div class="form-group">
            <label for="client_zipcode" class="form-label required">CEP</label>
            <input id="client_zipcode" type="text" formControlName="client_zipcode" class="form-control" placeholder="00000-000" [class.error]="isFieldInvalid('client_zipcode')">
            <div *ngIf="isFieldInvalid('client_zipcode')" class="error-message">CEP é obrigatório (mínimo 8 caracteres).</div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-building"></i>Empresa</h2>
        <div class="form-group">
          <label for="company_id" class="form-label required">Empresa</label>
          <div class="input-group">
            <select id="company_id" formControlName="company_id" class="form-control" [class.error]="isFieldInvalid('company_id')">
              <option value="" disabled>Selecione uma empresa</option>
              <option *ngFor="let company of companies" [value]="company.id">
                {{ company.name }} <span *ngIf="company.headquarters" class="company-details">- {{ company.headquarters }}</span>
              </option>
            </select>
            <button type="button" class="btn btn-outline btn-sm" (click)="toggleNewCompanyForm()">
              <i class="fas fa-plus"></i> Nova Empresa
            </button>
          </div>
          <div *ngIf="isFieldInvalid('company_id')" class="error-message">A seleção da empresa é obrigatória.</div>
        </div>

        <div *ngIf="showNewCompanyForm" class="sub-form" @slideInOut>
          <h3 class="sub-form-title">Cadastrar Nova Empresa</h3>
          <div [formGroup]="newCompanyForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="company_name" class="form-label required">Nome</label>
                <input id="company_name" type="text" formControlName="name" class="form-control" placeholder="Nome da empresa">
              </div>
              <div class="form-group">
                <label for="company_headquarters" class="form-label">Sede</label>
                <input id="company_headquarters" type="text" formControlName="headquarters" class="form-control" placeholder="Cidade/Estado">
              </div>
            </div>
            <div class="form-group">
              <label for="company_sector" class="form-label">Setor</label>
              <input id="company_sector" type="text" formControlName="market_sector" class="form-control" placeholder="Setor de mercado">
            </div>
            <div class="sub-form-actions">
              <button type="button" class="btn btn-secondary btn-sm" (click)="toggleNewCompanyForm()">Cancelar</button>
              <button type="button" class="btn btn-primary btn-sm" (click)="createNewCompany()" [disabled]="newCompanyForm.invalid">
                <i class="fas fa-save"></i> Salvar Empresa
              </button>
            </div>
          </div>
        </div>
        
        <!-- Validity Fields -->
        <div class="form-group">
          <label for="end_date" class="form-label">Válida Até</label>
          <input id="end_date" type="date" formControlName="end_date" class="form-control">
        </div>
      </div>

      <!-- Services Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title no-border"><i class="fas fa-briefcase"></i>Serviços da Proposta</h2>
          <button type="button" class="btn btn-primary" (click)="addService()">
            <i class="fas fa-plus"></i> Adicionar Serviço
          </button>
        </div>
        <div formArrayName="services" class="services-list">
          <div *ngFor="let service of servicesArray.controls; let i = index" [formGroupName]="i" class="service-card" @slideInOut>
            <div class="service-card-header">
              <h3 class="service-title">Serviço #{{ i + 1 }}</h3>
              <button *ngIf="servicesArray.length > 1" type="button" class="btn-remove" (click)="removeService(i)" title="Remover Serviço">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            <div class="service-card-body">
              <div class="form-group full-width">
                <label [for]="'service_id_' + i" class="form-label required">Serviço</label>
                <select [id]="'service_id_' + i" formControlName="service_id" class="form-control" [class.error]="isServiceFieldInvalid(i, 'service_id')" (change)="onServiceChange(i)">
                  <option value="" disabled>Selecione um serviço da lista</option>
                  <option *ngFor="let s of services" [value]="s.id">
                    {{ s.name }} ({{ formatCurrency(s.value) }})
                  </option>
                </select>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label [for]="'quantity_' + i" class="form-label required">Quantidade</label>
                  <input [id]="'quantity_' + i" type="number" formControlName="quantity" class="form-control" [class.error]="isServiceFieldInvalid(i, 'quantity')" min="1">
                </div>
                <div class="form-group">
                  <label [for]="'unit_value_' + i" class="form-label">Valor Unitário</label>
                  <input [id]="'unit_value_' + i" type="text" formControlName="unit_value" class="form-control" placeholder="Ex: 1.500,00" appCurrencyMask>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="servicesArray.length === 0" class="empty-state">
          <i class="fas fa-box-open"></i>
          <p>Nenhum serviço adicionado.</p>
          <span>Clique em "Adicionar Serviço" para começar a montar a proposta.</span>
        </div>
      </div>

      <!-- Observations Section -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-sticky-note"></i>Observações e Termos</h2>
        <div class="form-group">
          <label for="observations" class="form-label">Termos e Condições</label>
          <textarea id="observations" formControlName="observations" class="form-control" rows="4" placeholder="Inclua informações sobre pagamento, prazos, ou outras condições importantes."></textarea>
        </div>
      </div>

      <!-- Preview Card -->
      <div class="preview-card">
        <h3 class="preview-title"><i class="fas fa-receipt"></i>Resumo da Proposta</h3>
        <div class="preview-content">
          <div *ngFor="let service of servicesArray.controls; let i = index" class="summary-item">
            <div class="item-details">
              <span class="item-name">{{ getServiceById(service.get('service_id')?.value)?.name || 'Serviço não selecionado' }}</span>
              <span class="item-calculation">{{ formatCurrency(getServiceValue(i)) }} x {{ service.get('quantity')?.value || 1 }}</span>
            </div>
            <span class="item-total">{{ formatCurrency(getServiceTotal(i)) }}</span>
          </div>
          <div *ngIf="servicesArray.length === 0" class="summary-empty">
            <p>O resumo aparecerá aqui.</p>
          </div>
        </div>
        <div class="summary-total">
          <span class="total-label">Valor Total da Proposta</span>
          <span class="total-amount">{{ formatCurrency(getTotalValue()) }}</span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="isSubmitting">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="proposalForm.invalid || isSubmitting">
          <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!isSubmitting" class="fas fa-paper-plane"></i>
          <span>{{ isEditMode ? 'Atualizar Proposta' : 'Criar Proposta' }}</span>
        </button>
      </div>
    </form>
  </div>
