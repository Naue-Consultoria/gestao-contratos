<div class="proposal-page-content">
  <div class="page-header">
    <h1 class="page-title">{{ isEditMode ? 'Editar Proposta' : 'Nova Proposta' }}</h1>
    <app-breadcrumb></app-breadcrumb>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>
    Carregando...
  </div>

  <div class="form-container" *ngIf="!isLoading">
    <form [formGroup]="proposalForm" (ngSubmit)="onSubmit()" class="proposal-form">
      <div class="form-layout">
        
        <!-- COLUNA ESQUERDA - Informações Básicas -->
        <div class="left-column">
          
          <!-- Seção Cliente -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-users"></i>
              Cliente
            </h3>
            
            <div class="form-group">
              <label for="client_id" class="form-label">Cliente <span class="required">*</span></label>
              <div class="client-selection-row">
                <select id="client_id" formControlName="client_id" class="form-control" [class.error]="isFieldInvalid('client_id')">
                  <option value="" disabled>Selecione um cliente</option>
                  <option *ngFor="let client of clients" [value]="client.id">
                    {{ client.name }} <span *ngIf="client.headquarters" class="client-details">- {{ client.headquarters }}</span>
                  </option>
                </select>
                <button type="button" class="btn btn-secondary btn-sm new-client-btn" (click)="toggleNewClientForm()">
                  <i class="fas fa-plus"></i> 
                  {{ showNewClientForm ? 'Cancelar' : 'Novo Cliente' }}
                </button>
              </div>
              <div *ngIf="isFieldInvalid('client_id')" class="error-message">A seleção do cliente é obrigatória.</div>
            </div>

            <!-- Novo Cliente Form (collapsed by default) -->
            <div *ngIf="showNewClientForm" class="sub-form" @slideInOut>
              <h3 class="sub-form-title">
                <i class="fas fa-user-plus"></i>
                Cadastrar Novo Cliente
              </h3>
              <div [formGroup]="newClientForm" class="new-client-content">
                
                <!-- Tipo de Cliente -->
                <div class="form-group">
                  <label for="new_client_type" class="form-label">Tipo de Cliente <span class="required">*</span></label>
                  <select id="new_client_type" formControlName="client_type" class="form-control" [class.error]="isNewClientFieldInvalid('client_type')">
                    <option value="" disabled>Selecione o tipo</option>
                    <option value="pf">Pessoa Física</option>
                    <option value="pj">Pessoa Jurídica</option>
                  </select>
                  <div *ngIf="isNewClientFieldInvalid('client_type')" class="error-message">Tipo de cliente é obrigatório.</div>
                </div>

                <!-- Email -->
                <div class="form-group">
                  <label for="new_client_email" class="form-label">Email <span class="required">*</span></label>
                  <input id="new_client_email" type="email" formControlName="email" class="form-control" 
                         placeholder="cliente@exemplo.com" 
                         [class.error]="isNewClientFieldInvalid('email')">
                  <div *ngIf="isNewClientFieldInvalid('email')" class="error-message">Email válido é obrigatório.</div>
                </div>

                <!-- Nome/Razão Social baseado no tipo -->
                <div class="form-group">
                  <label for="new_client_name" class="form-label">
                    <span *ngIf="newClientForm.get('client_type')?.value === 'pf'">Nome Completo</span>
                    <span *ngIf="newClientForm.get('client_type')?.value === 'pj'">Razão Social</span>
                    <span *ngIf="!newClientForm.get('client_type')?.value">Nome / Razão Social</span>
                    <span class="required">*</span>
                  </label>
                  <input id="new_client_name" type="text" formControlName="name" class="form-control" 
                         [placeholder]="getNewClientNamePlaceholder()" 
                         [class.error]="isNewClientFieldInvalid('name')">
                  <div *ngIf="isNewClientFieldInvalid('name')" class="error-message">{{ getNewClientNameLabel() }} é obrigatório.</div>
                </div>

                <!-- Nome Fantasia (apenas para PJ) -->
                <div class="form-group" *ngIf="newClientForm.get('client_type')?.value === 'pj'">
                  <label for="new_client_trade_name" class="form-label">Nome Fantasia</label>
                  <input id="new_client_trade_name" type="text" formControlName="trade_name" class="form-control" 
                         placeholder="Nome como é conhecido no mercado">
                  <div class="help-text">Opcional - Como a empresa é conhecida no mercado</div>
                </div>

                <!-- Botões de ação -->
                <div class="new-client-actions">
                  <button type="button" class="btn btn-secondary btn-sm" (click)="cancelNewClient()">
                    <i class="fas fa-times"></i>
                    Cancelar
                  </button>
                  <button type="button" class="btn btn-primary btn-sm" (click)="createNewClient()" 
                          [disabled]="newClientForm.invalid || isCreatingClient">
                    <i *ngIf="!isCreatingClient" class="fas fa-save"></i>
                    <i *ngIf="isCreatingClient" class="fas fa-spinner fa-spin"></i>
                    {{ isCreatingClient ? 'Criando...' : 'Salvar Cliente' }}
                  </button>
                </div>

              </div>
            </div>
          </div>

          <!-- Seção Informações Básicas da Proposta -->
          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-info-circle"></i>
              Informações da Proposta
            </h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="type" class="form-label">Tipo de Proposta <span class="required">*</span></label>
                <select id="type" formControlName="type" class="form-control" [class.error]="isFieldInvalid('type')">
                  <option value="Full">Full</option>
                  <option value="Pontual">Pontual</option>
                  <option value="Individual">Individual</option>
                </select>
                <div *ngIf="isFieldInvalid('type')" class="error-message">Tipo de proposta é obrigatório.</div>
              </div>
              <div class="form-group">
                <label for="end_date" class="form-label">Válida Até</label>
                <input id="end_date" type="date" formControlName="end_date" class="form-control">
              </div>
            </div>
            
            <div class="form-group">
              <label for="observations" class="form-label">Observações</label>
              <textarea id="observations" formControlName="observations" class="form-control" rows="3" 
                        placeholder="Adicione observações sobre esta proposta..."></textarea>
            </div>
          </div>
        </div>

        <!-- COLUNA DIREITA - Serviços -->
        <div class="right-column">
          <div class="form-section">
            <div class="section-header">
              <h3 class="section-title">
                <i class="fas fa-briefcase"></i>
                Serviços da Proposta
              </h3>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="openServiceModal()"
                [disabled]="isSubmitting"
              >
                <i class="fas fa-plus"></i>
                Adicionar Serviço
              </button>
            </div>

            <!-- Estado vazio -->
            <div class="empty-services" *ngIf="selectedServices.length === 0">
              <div class="empty-icon">
                <i class="fas fa-briefcase"></i>
              </div>
              <h4 class="empty-title">Nenhum serviço adicionado</h4>
              <p class="empty-description">Adicione serviços para começar a montar sua proposta</p>
              <button
                type="button"
                class="btn btn-primary"
                (click)="openServiceModal()"
                [disabled]="isSubmitting"
              >
                <i class="fas fa-plus"></i>
                Adicionar Primeiro Serviço
              </button>
            </div>
            
            <!-- Lista de serviços -->
            <div class="services-list" *ngIf="selectedServices.length > 0">
              <div class="selected-services">
                <div
                  class="service-card"
                  *ngFor="let service of selectedServices; let i = index"
                >
                  <div class="service-header">
                    <div class="service-info">
                      <h4 class="service-name">{{ service.name }}</h4>
                      <div class="service-meta">
                        <span class="service-category">
                          <i class="fas fa-tag"></i>
                          {{ service.category }}
                        </span>
                        <span class="service-duration" *ngIf="service.duration_unit && (service.duration || service.duration_unit === 'Projeto')">
                          <i class="fas fa-clock"></i>
                          <span *ngIf="service.duration_unit === 'Projeto'">{{ service.duration_unit }}</span>
                          <span *ngIf="service.duration_unit !== 'Projeto'">{{ service.duration }} {{ service.duration_unit }}</span>
                        </span>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="remove-service-btn"
                      (click)="removeService(i)"
                      title="Remover serviço"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <div class="service-pricing">
                    <div class="price-input-group">
                      <label class="price-label">Valor do Serviço</label>
                      <div class="price-input-wrapper">
                        <input
                          type="text"
                          class="price-input"
                          [(ngModel)]="service.unit_value"
                          [ngModelOptions]="{standalone: true}"
                          (ngModelChange)="onPriceChange(i, $event)"
                          (input)="onPriceInput(i, $event)"
                          (keyup)="onPriceKeyup(i, $event)"
                          [name]="'price_' + i"
                          placeholder="0,00"
                          appCurrencyMask
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Resumo total da proposta -->
            <div class="proposal-total-summary" *ngIf="selectedServices.length > 0">
              <div class="summary-row">
                <span class="summary-label">Total da Proposta</span>
                <span class="summary-value">{{ getTotalValueFormatted() }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="isSubmitting">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="proposalForm.invalid || isSubmitting">
          <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!isSubmitting" class="fas fa-paper-plane"></i>
          <span>{{ isEditMode ? 'Atualizar Proposta' : 'Criar Proposta' }}</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Modal de Seleção de Serviços (igual ao contrato) -->
  <div class="modal-overlay" *ngIf="showServiceModal" (click)="closeServiceModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Selecionar Serviços</h2>
        <button type="button" class="modal-close" (click)="closeServiceModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-filters">
        <div class="filter-row">
          <div class="search-filter">
            <input
              type="text"
              [(ngModel)]="serviceSearchTerm"
              [ngModelOptions]="{standalone: true}"
              placeholder="Buscar serviços..."
              class="search-input"
            >
          </div>
          <div class="category-filter">
            <select [(ngModel)]="serviceCategoryFilter" [ngModelOptions]="{standalone: true}" class="category-select">
              <option value="">Todas as categorias</option>
              <option *ngFor="let category of serviceCategories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="service-options">
          <div
            class="service-option"
            *ngFor="let service of filteredServices"
            (click)="addService(service)"
          >
            <div class="service-option-info">
              <h4>{{ service.name }}</h4>
              <div class="service-option-details">
                <span><i class="fas fa-tag"></i> {{ service.category }}</span>
                <span *ngIf="service.duration_unit && (service.duration_amount || service.duration_unit === 'Projeto')">
                  <i class="fas fa-clock"></i> 
                  <span *ngIf="service.duration_unit === 'Projeto'">{{ service.duration_unit }}</span>
                  <span *ngIf="service.duration_unit !== 'Projeto'">{{ service.duration_amount }} {{ service.duration_unit }}</span>
                </span>
              </div>
              <p *ngIf="service.description">{{ service.description }}</p>
            </div>
          </div>
          
          <div *ngIf="filteredServices.length === 0" class="no-services">
            <i class="fas fa-search"></i>
            <p>Nenhum serviço encontrado</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>