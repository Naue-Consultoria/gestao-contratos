  <div class="page-header">
    <h1 class="page-title">{{ isEditMode ? 'Editar Proposta' : 'Nova Proposta' }}</h1>
    <app-breadcrumb></app-breadcrumb>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Carregando dados...</span>
  </div>

  <div class="form-container" *ngIf="!isLoading">
    <form [formGroup]="proposalForm" (ngSubmit)="onSubmit()">
      

      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-users"></i>Cliente</h2>
        <div class="form-group">
          <label for="client_id" class="form-label required">Cliente</label>
          <div class="input-group">
            <select id="client_id" formControlName="client_id" class="form-control" [class.error]="isFieldInvalid('client_id')">
              <option value="" disabled>Selecione um cliente</option>
              <option *ngFor="let client of clients" [value]="client.id">
                {{ client.name }} <span *ngIf="client.headquarters" class="client-details">- {{ client.headquarters }}</span>
              </option>
            </select>
            <button type="button" class="btn btn-outline btn-sm" (click)="toggleNewClientForm()">
              <i class="fas fa-plus"></i> Novo Cliente
            </button>
          </div>
          <div *ngIf="isFieldInvalid('client_id')" class="error-message">A seleção do cliente é obrigatória.</div>
        </div>

        <div *ngIf="showNewClientForm" class="sub-form" @slideInOut>
          <h3 class="sub-form-title">Cadastrar Novo Cliente</h3>
          <div [formGroup]="newClientForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_type" class="form-label required">Tipo de Cliente</label>
                <select id="new_client_type" formControlName="client_type" class="form-control" [class.error]="isNewClientFieldInvalid('client_type')">
                  <option value="" disabled>Selecione o tipo</option>
                  <option value="pf">Pessoa Física</option>
                  <option value="pj">Pessoa Jurídica</option>
                </select>
                <div *ngIf="isNewClientFieldInvalid('client_type')" class="error-message">Tipo de cliente é obrigatório.</div>
              </div>
              <div class="form-group">
                <label for="new_client_name" class="form-label required">
                  <span *ngIf="newClientForm.get('client_type')?.value === 'pf'">Nome Completo</span>
                  <span *ngIf="newClientForm.get('client_type')?.value === 'pj'">Razão Social</span>
                  <span *ngIf="!newClientForm.get('client_type')?.value">Nome / Razão Social</span>
                </label>
                <input id="new_client_name" type="text" formControlName="name" class="form-control" 
                       [placeholder]="getNewClientNamePlaceholder()" 
                       [class.error]="isNewClientFieldInvalid('name')">
                <div *ngIf="isNewClientFieldInvalid('name')" class="error-message">Nome é obrigatório.</div>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_document" class="form-label required">
                  <span *ngIf="newClientForm.get('client_type')?.value === 'pf'">CPF</span>
                  <span *ngIf="newClientForm.get('client_type')?.value === 'pj'">CNPJ</span>
                  <span *ngIf="!newClientForm.get('client_type')?.value">CPF / CNPJ</span>
                </label>
                <input id="new_client_document" type="text" formControlName="document" class="form-control" 
                       [placeholder]="getNewClientDocumentPlaceholder()" 
                       [class.error]="isNewClientFieldInvalid('document')"
                       [appDocumentMask]="newClientForm.get('client_type')?.value === 'pf' ? 'cpf' : 'cnpj'">
                <div *ngIf="isNewClientFieldInvalid('document')" class="error-message">Documento é obrigatório.</div>
              </div>
              <div class="form-group" *ngIf="newClientForm.get('client_type')?.value === 'pj'">
                <label for="new_client_trade_name" class="form-label">Nome Fantasia</label>
                <input id="new_client_trade_name" type="text" formControlName="trade_name" class="form-control" 
                       placeholder="Digite o nome fantasia">
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_email" class="form-label required">Email</label>
                <input id="new_client_email" type="email" formControlName="email" class="form-control" 
                       placeholder="email@exemplo.com" 
                       [class.error]="isNewClientFieldInvalid('email')">
                <div *ngIf="isNewClientFieldInvalid('email')" class="error-message">Email válido é obrigatório.</div>
              </div>
              <div class="form-group">
                <label for="new_client_phone" class="form-label">Telefone</label>
                <input id="new_client_phone" type="tel" formControlName="phone" class="form-control" placeholder="(11) 99999-9999"
                       appDocumentMask="phone">
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_zipcode" class="form-label required">CEP</label>
                <input id="new_client_zipcode" type="text" formControlName="zipcode" class="form-control" 
                       placeholder="00000-000" 
                       [class.error]="isNewClientFieldInvalid('zipcode')"
                       appDocumentMask="cep">
                <div *ngIf="isNewClientFieldInvalid('zipcode')" class="error-message">CEP é obrigatório.</div>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group col-3">
                <label for="new_client_street" class="form-label required">Logradouro</label>
                <input id="new_client_street" type="text" formControlName="street" class="form-control" 
                       placeholder="Rua, Avenida, etc." 
                       [class.error]="isNewClientFieldInvalid('street')">
                <div *ngIf="isNewClientFieldInvalid('street')" class="error-message">Logradouro é obrigatório.</div>
              </div>
              <div class="form-group col-1">
                <label for="new_client_number" class="form-label required">Número</label>
                <input id="new_client_number" type="text" formControlName="number" class="form-control" 
                       placeholder="123" 
                       [class.error]="isNewClientFieldInvalid('number')">
                <div *ngIf="isNewClientFieldInvalid('number')" class="error-message">Número é obrigatório.</div>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_neighborhood" class="form-label required">Setor</label>
                <input id="new_client_neighborhood" type="text" formControlName="neighborhood" class="form-control" 
                       placeholder="Nome do setor" 
                       [class.error]="isNewClientFieldInvalid('neighborhood')">
                <div *ngIf="isNewClientFieldInvalid('neighborhood')" class="error-message">Setor é obrigatório.</div>
              </div>
              <div class="form-group">
                <label for="new_client_complement" class="form-label">Complemento</label>
                <input id="new_client_complement" type="text" formControlName="complement" class="form-control" placeholder="Apto, Sala, etc.">
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="new_client_city" class="form-label required">Cidade</label>
                <input id="new_client_city" type="text" formControlName="city" class="form-control" 
                       placeholder="Nome da cidade" 
                       [class.error]="isNewClientFieldInvalid('city')">
                <div *ngIf="isNewClientFieldInvalid('city')" class="error-message">Cidade é obrigatória.</div>
              </div>
              <div class="form-group">
                <label for="new_client_state" class="form-label required">Estado</label>
                <select id="new_client_state" formControlName="state" class="form-control" [class.error]="isNewClientFieldInvalid('state')">
                  <option value="">Selecione...</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amapá</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Ceará</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Espírito Santo</option>
                  <option value="GO">Goiás</option>
                  <option value="MA">Maranhão</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Pará</option>
                  <option value="PB">Paraíba</option>
                  <option value="PR">Paraná</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piauí</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rondônia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">São Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
                <div *ngIf="isNewClientFieldInvalid('state')" class="error-message">Estado é obrigatório.</div>
              </div>
            </div>
            <div class="sub-form-actions">
              <button type="button" class="btn btn-secondary btn-sm" (click)="toggleNewClientForm()">Cancelar</button>
              <button type="button" class="btn btn-primary btn-sm" (click)="createNewClient()" [disabled]="newClientForm.invalid">
                <i class="fas fa-save"></i> Salvar Cliente
              </button>
            </div>
          </div>
        </div>
        
        <!-- Validity Fields -->
        <div class="form-group">
          <label for="end_date" class="form-label">Válida Até</label>
          <input id="end_date" type="date" formControlName="end_date" class="form-control">
        </div>
      </div>

      <!-- Services Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title no-border"><i class="fas fa-briefcase"></i>Serviços da Proposta</h2>
          <button type="button" class="btn btn-primary" (click)="addService()">
            <i class="fas fa-plus"></i> Adicionar Serviço
          </button>
        </div>
        <div formArrayName="services" class="services-list">
          <div *ngFor="let service of servicesArray.controls; let i = index" [formGroupName]="i" class="service-card" @slideInOut>
            <div class="service-card-header">
              <h3 class="service-title">Serviço #{{ i + 1 }}</h3>
              <button *ngIf="servicesArray.length > 1" type="button" class="btn-remove" (click)="removeService(i)" title="Remover Serviço">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            <div class="service-card-body">
              <div class="form-group full-width">
                <label [for]="'service_id_' + i" class="form-label required">Serviço</label>
                <select [id]="'service_id_' + i" formControlName="service_id" class="form-control" [class.error]="isServiceFieldInvalid(i, 'service_id')" (change)="onServiceChange(i)">
                  <option value="" disabled>Selecione um serviço da lista</option>
                  <option *ngFor="let s of services" [value]="s.id">
                    {{ s.name }}
                  </option>
                </select>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label [for]="'quantity_' + i" class="form-label required">Quantidade</label>
                  <input [id]="'quantity_' + i" type="number" formControlName="quantity" class="form-control" [class.error]="isServiceFieldInvalid(i, 'quantity')" min="1">
                </div>
                <div class="form-group">
                  <label [for]="'unit_value_' + i" class="form-label">Valor Unitário</label>
                  <input [id]="'unit_value_' + i" type="text" formControlName="unit_value" class="form-control" placeholder="R$ 1.500,00" appCurrencyMask>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="servicesArray.length === 0" class="empty-state">
          <i class="fas fa-box-open"></i>
          <p>Nenhum serviço adicionado.</p>
          <span>Clique em "Adicionar Serviço" para começar a montar a proposta.</span>
        </div>
      </div>

      <!-- Observations Section -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-sticky-note"></i>Observações e Termos</h2>
        <div class="form-group">
          <label for="observations" class="form-label">Termos e Condições</label>
          <textarea id="observations" formControlName="observations" class="form-control" rows="4" placeholder="Inclua informações sobre pagamento, prazos, ou outras condições importantes."></textarea>
        </div>
      </div>

      <!-- Preview Card -->
      <div class="preview-card">
        <h3 class="preview-title"><i class="fas fa-receipt"></i>Resumo da Proposta</h3>
        <div class="preview-content">
          <div *ngFor="let service of servicesArray.controls; let i = index" class="summary-item">
            <div class="item-details">
              <span class="item-name">{{ getServiceById(service.get('service_id')?.value)?.name || 'Serviço não selecionado' }}</span>
              <span class="item-calculation">{{ formatCurrency(getServiceValue(i)) }} x {{ service.get('quantity')?.value || 1 }}</span>
            </div>
            <span class="item-total">{{ formatCurrency(getServiceTotal(i)) }}</span>
          </div>
          <div *ngIf="servicesArray.length === 0" class="summary-empty">
            <p>O resumo aparecerá aqui.</p>
          </div>
        </div>
        <div class="summary-total">
          <span class="total-label">Valor Total da Proposta</span>
          <span class="total-amount">{{ formatCurrency(getTotalValue()) }}</span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="isSubmitting">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="proposalForm.invalid || isSubmitting">
          <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!isSubmitting" class="fas fa-paper-plane"></i>
          <span>{{ isEditMode ? 'Atualizar Proposta' : 'Criar Proposta' }}</span>
        </button>
      </div>
    </form>
  </div>
