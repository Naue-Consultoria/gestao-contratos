<div class="page">
  <div class="page-header">
    <h1 class="page-title">
      {{ isViewMode ? 'Visualizar Contrato' : (isEditMode ? 'Editar Contrato' :
      'Novo Contrato') }}
    </h1>
    <div class="breadcrumb">
      <span>Home</span><span class="breadcrumb-separator">/</span>
      <span class="clickable" (click)="cancel()">Contratos</span
      ><span class="breadcrumb-separator">/</span>
      <span
        >{{ isViewMode ? 'Visualizar' : (isEditMode ? 'Editar' : 'Novo')
        }}</span
      >
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>Carregando...
  </div>

  <div class="form-container" *ngIf="!isLoading">
    <form (ngSubmit)="save()" *ngIf="!isViewMode">
      <div class="form-grid">
        <div class="form-section">
          <h2 class="section-title">
            <i class="fas fa-info-circle"></i>Informações Básicas
          </h2>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Número</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="formData.contract_number"
                name="contract_number"
                [readonly]="isEditMode"
                [class.error]="errors.contract_number"
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Tipo</label>
              <select class="form-control" [(ngModel)]="formData.type" name="type">
                <option *ngFor="let type of contractTypes" [value]="type">
                  {{ type }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label required">Status</label>
              <select class="form-control" [(ngModel)]="formData.status" name="status">
                <option *ngFor="let status of contractStatuses" [value]="status.value">
                  {{ status.label }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label required">Cliente</label>
            <select
              class="form-control"
              [(ngModel)]="formData.client_id"
              name="client_id"
              [class.error]="errors.client_id"
            >
              <option [value]="null" disabled>Selecione</option>
              <option *ngFor="let client of clients" [value]="client.id">
                {{ client.name }}
              </option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Data de Início</label>
              <input
                type="date"
                class="form-control"
                [(ngModel)]="formData.start_date"
                name="start_date"
                [class.error]="errors.start_date"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Data de Término</label>
              <input
                type="date"
                class="form-control"
                [(ngModel)]="formData.end_date"
                name="end_date"
                [min]="formData.start_date"
              />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Atribuir Usuários</label>
            <div class="user-assignment-box">
              <div class="selected-users-display">
                <i class="fas fa-users"></i>
                <span>{{ getSelectedUserNames() }}</span>
              </div>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="openUserModal()"
              >
                <i class="fas fa-edit"></i>Selecionar
              </button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Observações</label>
            <textarea
              class="form-control"
              [(ngModel)]="formData.notes"
              name="notes"
              rows="3"
              placeholder="..."
            ></textarea>
          </div>
        </div>

        <div class="view-mode" *ngIf="isViewMode">
          <div class="view-grid">
            <div class="view-section">
              <div class="detail-item">
                <span class="detail-label">Status:</span>
                <span class="detail-value">
                  <span class="status-badge" [ngClass]="'status-' + formData.status">
                    {{ getStatusText(formData.status) }}
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">
            <i class="fas fa-briefcase"></i>Serviços do Contrato
          </h2>
          <div class="services-header">
            <button
              type="button"
              class="btn btn-primary"
              (click)="openServiceModal()"
            >
              <i class="fas fa-plus"></i>Adicionar Serviço
            </button>
          </div>
          <div class="selected-services" *ngIf="selectedServices.length > 0">
            <div
              class="service-item"
              *ngFor="let service of selectedServices; let i = index"
            >
              <div class="service-info">
                <h4 class="service-name">{{ service.name }}</h4>
              </div>
              <div class="service-controls">
                <div class="price-control">
                  <label>Valor Unit.:</label>
                  <div class="input-with-prefix">
                    <span>R$</span>
                    <input
                      type="number"
                      class="price-input"
                      [ngModel]="service.unit_value / 100"
                      (ngModelChange)="updateServicePrice(i, $event)"
                      [name]="'price_' + i"
                    />
                  </div>
                </div>
                <div class="quantity-control">
                  <label>Qtd.:</label>
                  <input
                    type="number"
                    class="quantity-input"
                    [(ngModel)]="service.quantity"
                    [name]="'quantity_' + i"
                    (ngModelChange)="updateServiceQuantity(i, service.quantity)"
                  />
                </div>
                <div class="service-total">
                  <label>Total:</label>
                  <span class="total-value"
                    >{{ formatCurrency(service.total_value) }}</span
                  >
                </div>
                <button
                  type="button"
                  class="remove-btn"
                  (click)="removeService(i)"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="contract-summary" *ngIf="selectedServices.length > 0">
            <div class="summary-item total">
              <span class="summary-label">Valor Total:</span>
              <span class="summary-value">{{ getFormattedTotalValue() }}</span>
            </div>
          </div>
        </div>
        <div class="form-section" *ngIf="isEditMode && assignedUsers.length > 0">
          <h2 class="section-title">
              <i class="fas fa-users-cog"></i>Gerenciar Acessos
          </h2>
          <div class="assigned-users-management">
            <div *ngFor="let assignedUser of assignedUsers" class="user-management-row">
              <div class="user-details">
                  <span class="user-name">{{ assignedUser.user.name }}</span>
                  <span class="user-email">{{ assignedUser.user.email }}</span>
              </div>
              <div class="role-selector">
                <select 
                  class="form-control"
                  [ngModel]="assignedUser.role"
                  (ngModelChange)="onRoleChange(assignedUser, $event)"
                  [name]="'role_' + assignedUser.user.id">
                  <option *ngFor="let role of availableRoles" [value]="role.value">
                    {{ role.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSaving">
          <i
            class="fas"
            [ngClass]="isSaving ? 'fa-spinner fa-spin' : 'fa-save'"
          ></i
          >{{ isEditMode ? 'Atualizar' : 'Criar' }}
        </button>
      </div>
    </form>

    <div class="view-mode" *ngIf="isViewMode">
      <div class="view-grid">
        <div class="view-section">
          <h2 class="section-title">
            <i class="fas fa-file-contract"></i>Detalhes do Contrato
          </h2>
          <div class="detail-item">
            <span class="detail-label">Número:</span
            ><span class="detail-value">{{ formData.contract_number }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Tipo:</span
            ><span class="type-badge" [attr.data-type]="formData.type"
              >{{ formData.type }}</span
            >
          </div>
          <div class="detail-item">
            <span class="detail-label">Cliente:</span
            ><span class="detail-value"
              >{{ getClientName(formData.client_id) }}</span
            >
          </div>
          <div class="detail-item">
            <span class="detail-label">Início:</span
            ><span class="detail-value"
              >{{ formatDate(formData.start_date) }}</span
            >
          </div>
          <div class="detail-item">
            <span class="detail-label">Término:</span
            ><span class="detail-value"
              >{{ formatDate(formData.end_date) }}</span
            >
          </div>
          <div class="detail-item" *ngIf="formData.notes">
            <span class="detail-label">Obs:</span>
            <p class="detail-value notes">{{ formData.notes }}</p>
          </div>
        </div>
        <div class="view-section">
          <h2 class="section-title">
            <i class="fas fa-briefcase"></i>Serviços Contratados
          </h2>
          <div class="services-table">
            <table>
              <thead>
                <tr>
                  <th>Serviço</th>
                  <th>Qtd</th>
                  <th>Valor Unit.</th>
                  <th>Valor Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let service of selectedServices">
                  <td>{{ service.name }}</td>
                  <td>{{ service.quantity }}</td>
                  <td>{{ formatCurrency(service.unit_value) }}</td>
                  <td class="value-highlight">
                    {{ formatCurrency(service.total_value) }}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>Total:</strong>
                  </td>
                  <td class="total-value">
                    <strong>{{ getFormattedTotalValue() }}</strong>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="view-section" *ngIf="isViewMode && assignedUsers.length > 0">
          <h2 class="section-title">
              <i class="fas fa-users"></i>Usuários Atribuídos
          </h2>
          <div class="assigned-users-list">
            <div *ngFor="let assignedUser of assignedUsers" class="user-item">
              <span class="user-name">{{ assignedUser.user.name }}</span>
              <span class="user-role-badge">{{ getRoleLabel(assignedUser.role) }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">
          <i class="fas fa-arrow-left"></i>Voltar
        </button>
        <button type="button" class="btn btn-primary" (click)="enableEdit()">
          <i class="fas fa-edit"></i>Editar
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal"
  [class.active]="showServiceModal"
  (click)="closeServiceModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Adicionar Serviço</h3>
      <button class="close-btn" (click)="closeServiceModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-search">
        <i class="fas fa-search"></i>
        <input
          type="text"
          class="modal-search-input"
          placeholder="Buscar serviço..."
          [(ngModel)]="serviceSearchTerm"
          name="serviceSearch"
        />
      </div>
      <div class="services-list">
        <div
          class="service-option"
          *ngFor="let service of filteredServices"
          (click)="addService(service)"
          [class.disabled]="isServiceSelected(service.id)"
        >
          <div class="service-option-info">
            <h4>{{ service.name }}</h4>
            <div class="service-option-details">
              <span><i class="fas fa-tag"></i> {{ service.category }}</span>
              <span
                ><i class="fas fa-clock"></i> {{ formatServiceDuration(service)
                }}</span
              >
              <span class="service-value"
                >{{ formatCurrency(service.value) }}</span
              >
            </div>
          </div>
          <div class="service-option-action">
            <i
              class="fas fa-plus-circle"
              *ngIf="!isServiceSelected(service.id)"
            ></i>
            <i
              class="fas fa-check-circle"
              *ngIf="isServiceSelected(service.id)"
            ></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<app-user-selection-modal
  [isOpen]="isUserModalOpen"
  [allUsers]="allUsers"
  [initialSelectedIds]="formData.assigned_users"
  (close)="closeUserModal()"
  (selectionConfirmed)="updateAssignedUsers($event)"
>
</app-user-selection-modal>
