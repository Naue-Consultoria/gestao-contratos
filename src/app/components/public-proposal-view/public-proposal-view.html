<div class="public-proposal-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Carregando proposta...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">⚠️</div>
    <h2>Proposta não encontrada</h2>
    <p>{{ error }}</p>
    <button class="btn-secondary" (click)="goHome()">Voltar ao início</button>
  </div>

  <!-- Proposal Content -->
  <div *ngIf="proposal && !isLoading && !error" class="proposal-content">
    <!-- Header -->
    <div class="proposal-header">
      <div class="company-info">
        <h1>{{ proposal.company.name }}</h1>
        <p *ngIf="proposal.company.headquarters" class="company-details">{{ proposal.company.headquarters }}</p>
        <p *ngIf="proposal.company.market_sector" class="company-details">{{ proposal.company.market_sector }}</p>
      </div>
      <div class="proposal-meta">
        <div class="proposal-number">
          <small>Proposta</small>
          <strong>#{{ proposal.id }}</strong>
        </div>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step" [class.active]="currentStep === 'view'" [class.completed]="currentStep !== 'view'">
        <div class="step-number">1</div>
        <span>Revisar Proposta</span>
      </div>
      <div class="step" [class.active]="currentStep === 'services'" [class.completed]="currentStep === 'signature' || currentStep === 'completed'">
        <div class="step-number">2</div>
        <span>Selecionar Serviços</span>
      </div>
      <div class="step" [class.active]="currentStep === 'signature'" [class.completed]="currentStep === 'completed'">
        <div class="step-number">3</div>
        <span>Assinatura</span>
      </div>
      <div class="step" [class.active]="currentStep === 'completed'">
        <div class="step-number">✓</div>
        <span>Concluído</span>
      </div>
    </div>

    <!-- Step 1: View Proposal -->
    <div *ngIf="currentStep === 'view'" class="step-content">
      <div class="proposal-details">
        <h2>{{ proposal.title }}</h2>
        
        <div class="proposal-info">
          <div class="info-row" *ngIf="proposal.description">
            <strong>Descrição:</strong>
            <p>{{ proposal.description }}</p>
          </div>
          
          <div class="info-row" *ngIf="proposal.valid_until">
            <strong>Válida até:</strong>
            <span class="date-badge">{{ formatDate(proposal.valid_until) }}</span>
          </div>
          
          <div class="info-row" *ngIf="proposal.sent_at">
            <strong>Enviada em:</strong>
            <span class="date-badge">{{ formatDate(proposal.sent_at) }}</span>
          </div>
        </div>

        <div class="services-section">
          <h3>Serviços Oferecidos</h3>
          <div class="services-list">
            <div *ngFor="let service of proposal.services" class="service-item">
              <div class="service-info">
                <h4>{{ service.service.name }}</h4>
                <p *ngIf="service.service.description" class="service-description">
                  {{ service.service.description }}
                </p>
                <div class="service-details">
                  <span class="service-category">{{ service.service.category }}</span>
                  <span *ngIf="service.service.duration_amount" class="service-duration">
                    {{ service.service.duration_amount }} {{ service.service.duration_unit }}
                  </span>
                </div>
              </div>
              <div class="service-pricing">
                <div class="quantity">
                  <small>Quantidade</small>
                  <strong>{{ service.quantity }}</strong>
                </div>
                <div class="unit-price">
                  <small>Valor unitário</small>
                  <strong>{{ formatCurrency(getServiceValue(service)) }}</strong>
                </div>
                <div class="total-price">
                  <small>Total</small>
                  <strong>{{ formatCurrency(getServiceTotal(service)) }}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="total-section">
          <div class="total-value">
            <span>Valor Total da Proposta:</span>
            <strong>{{ formatCurrency(proposal.total_value) }}</strong>
          </div>
        </div>

        <div *ngIf="proposal.observations" class="observations-section">
          <h3>Observações</h3>
          <p>{{ proposal.observations }}</p>
        </div>

        <div class="action-buttons">
          <button class="btn-primary" (click)="proceedToServiceSelection()">
            Continuar - Selecionar Serviços
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Service Selection -->
    <div *ngIf="currentStep === 'services'" class="step-content">
      <div class="service-selection">
        <h2>Selecione os Serviços Desejados</h2>
        <p class="step-description">
          Escolha quais serviços você gostaria de contratar desta proposta:
        </p>

        <div class="services-checklist">
          <div *ngFor="let service of proposal.services" class="service-checkbox-item">
            <div class="checkbox-container">
              <input 
                type="checkbox" 
                [id]="'service-' + service.service_id"
                [(ngModel)]="selectedServices[service.service_id]"
                class="service-checkbox">
              <label [for]="'service-' + service.service_id" class="checkbox-label">
                <div class="service-header">
                  <h4>{{ service.service.name }}</h4>
                  <span class="service-price">{{ formatCurrency(getServiceTotal(service)) }}</span>
                </div>
                <p *ngIf="service.service.description" class="service-description">
                  {{ service.service.description }}
                </p>
                <div class="service-details">
                  <span>Quantidade: {{ service.quantity }}</span>
                  <span>Valor unitário: {{ formatCurrency(getServiceValue(service)) }}</span>
                </div>
              </label>
            </div>
            
            <div *ngIf="selectedServices[service.service_id]" class="service-notes">
              <label [for]="'notes-' + service.service_id">Observações para este serviço:</label>
              <textarea 
                [id]="'notes-' + service.service_id"
                [(ngModel)]="serviceNotes[service.service_id]"
                placeholder="Adicione observações específicas para este serviço..."
                class="notes-textarea">
              </textarea>
            </div>
          </div>
        </div>

        <div class="selected-summary" *ngIf="hasSelectedServices()">
          <div class="summary-header">
            <h3>Resumo da Seleção</h3>
          </div>
          <div class="selected-total">
            <span>Total dos serviços selecionados:</span>
            <strong>{{ formatCurrency(getSelectedTotal()) }}</strong>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-secondary" (click)="backToView()">Voltar</button>
          <button 
            class="btn-primary" 
            [disabled]="!hasSelectedServices()"
            (click)="proceedToSignature()">
            Continuar - Assinar Proposta
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Signature -->
    <div *ngIf="currentStep === 'signature'" class="step-content">
      <div class="signature-section">
        <h2>Assinatura Digital</h2>
        <p class="step-description">
          Preencha seus dados e assine digitalmente para finalizar a contratação:
        </p>

        <form [formGroup]="signatureForm" class="signature-form">
          <div class="form-row">
            <div class="form-group">
              <label for="client_name">Nome Completo *</label>
              <input 
                type="text" 
                id="client_name"
                formControlName="client_name"
                [class.error]="isFieldInvalid('client_name')"
                placeholder="Seu nome completo">
              <div *ngIf="isFieldInvalid('client_name')" class="error-message">
                Nome é obrigatório
              </div>
            </div>

            <div class="form-group">
              <label for="client_email">E-mail *</label>
              <input 
                type="email" 
                id="client_email"
                formControlName="client_email"
                [class.error]="isFieldInvalid('client_email')"
                placeholder="seu@email.com">
              <div *ngIf="isFieldInvalid('client_email')" class="error-message">
                E-mail válido é obrigatório
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="client_phone">Telefone</label>
              <input 
                type="tel" 
                id="client_phone"
                formControlName="client_phone"
                placeholder="(11) 99999-9999">
            </div>

            <div class="form-group">
              <label for="client_document">CPF/CNPJ</label>
              <input 
                type="text" 
                id="client_document"
                formControlName="client_document"
                placeholder="000.000.000-00">
            </div>
          </div>

          <div class="form-group">
            <label for="client_observations">Observações Adicionais</label>
            <textarea 
              id="client_observations"
              formControlName="client_observations"
              placeholder="Observações adicionais sobre a contratação..."
              rows="3">
            </textarea>
          </div>
        </form>

        <div class="signature-pad-section">
          <h3>Assinatura Digital</h3>
          <div class="signature-pad-container">
            <!-- Simulação de signature pad -->
            <div class="signature-simulation">
              <div *ngIf="!signatureImage" class="signature-placeholder">
                <p>Clique no botão abaixo para simular sua assinatura digital</p>
                <button class="btn-secondary" (click)="simulateSignature()">
                  Simular Assinatura
                </button>
              </div>
              <div *ngIf="signatureImage" class="signature-preview">
                <p>✓ Assinatura digital adicionada</p>
                <button class="btn-link" (click)="clearSignature()">Limpar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="final-summary">
          <h3>Resumo Final</h3>
          <div class="summary-details">
            <div class="summary-row">
              <span>Serviços selecionados:</span>
              <span>{{ getSelectedServicesCount() }}</span>
            </div>
            <div class="summary-row">
              <span>Valor total:</span>
              <strong>{{ formatCurrency(getSelectedTotal()) }}</strong>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-secondary" (click)="backToServices()">Voltar</button>
          <button 
            class="btn-primary btn-sign" 
            [disabled]="!isFormValid()"
            (click)="signProposal()">
            Assinar e Finalizar Contratação
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Completed -->
    <div *ngIf="currentStep === 'completed'" class="step-content">
      <div class="completion-section">
        <div class="success-icon">✅</div>
        <h2>Proposta Assinada com Sucesso!</h2>
        
        <div class="completion-details">
          <p>Parabéns! Sua proposta foi assinada digitalmente e está sendo processada.</p>
          
          <div class="completion-summary">
            <div class="summary-item">
              <strong>Cliente:</strong>
              <span>{{ proposal.client_name }}</span>
            </div>
            <div class="summary-item">
              <strong>E-mail:</strong>
              <span>{{ proposal.client_email }}</span>
            </div>
            <div class="summary-item">
              <strong>Valor contratado:</strong>
              <span>{{ formatCurrency(proposal.accepted_value || 0) }}</span>
            </div>
            <div class="summary-item">
              <strong>Data da assinatura:</strong>
              <span>{{ proposal.signed_at ? formatDate(proposal.signed_at) : 'Agora' }}</span>
            </div>
          </div>

          <div class="next-steps">
            <h3>Próximos Passos</h3>
            <ul>
              <li>Você receberá um e-mail de confirmação em breve</li>
              <li>Nossa equipe entrará em contato para agendar o início dos serviços</li>
              <li>Um contrato formal será enviado para assinatura</li>
            </ul>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-secondary" (click)="printReceipt()">
            Imprimir Comprovante
          </button>
        </div>
      </div>
    </div>
  </div>
</div>