<div class="page" *ngIf="!isLoading">
  <div class="page-header">
    <div class="header-title-section">
      <h1 class="page-title">
        {{ isEditMode ? 'Editar Encontro de Mentoria' : 'Criar Nova Mentoria' }}
      </h1>
      <app-breadcrumb></app-breadcrumb>
    </div>
    <div class="header-actions">
      <!-- Modo Criaﾃｧﾃ｣o: Botﾃ｣o de Criar Mentoria -->
      <button
        type="button"
        class="btn-primary"
        (click)="salvarEncontro()"
        [disabled]="isSaving || encontroForm.invalid"
        *ngIf="!isEditMode">
        <i class="fas fa-plus-circle"></i>
        {{ isSaving ? 'Criando...' : 'Criar Mentoria' }}
      </button>

      <!-- Modo Ediﾃｧﾃ｣o: Botﾃｵes de Salvar e Publicar -->
      <button
        type="button"
        class="btn-primary"
        (click)="salvarEncontro()"
        [disabled]="isSaving"
        *ngIf="isEditMode">
        <i class="fas fa-save"></i>
        {{ isSaving ? 'Salvando...' : 'Salvar Alteraﾃｧﾃｵes' }}
      </button>

      <button
        type="button"
        class="btn-success"
        (click)="publicarEncontro()"
        [disabled]="!isEditMode || isSaving"
        *ngIf="isEditMode">
        <i class="fas fa-paper-plane"></i>
        Publicar
      </button>
    </div>
  </div>

  <!-- Container Principal com Duas Colunas -->
  <div class="two-column-layout">

    <!-- Coluna Esquerda - Informaﾃｧﾃｵes Principais -->
    <div class="column-left">

      <!-- Seﾃｧﾃ｣o de Informaﾃｧﾃｵes Bﾃ｡sicas -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-header-left">
            <i class="fas fa-info-circle section-icon"></i>
            <div>
              <h3 class="section-title">
                {{ isEditMode ? 'Informaﾃｧﾃｵes do Encontro' : 'Informaﾃｧﾃｵes Bﾃ｡sicas' }}
              </h3>
              <p class="section-subtitle">
                {{ isEditMode ? 'Configure os dados bﾃ｡sicos deste encontro' : 'Dados principais da mentoria' }}
              </p>
            </div>
          </div>
        </div>

        <form [formGroup]="encontroForm">
          <!-- MODO CRIAﾃﾃグ -->
          <ng-container *ngIf="!isEditMode">
            <!-- Linha 1: Cliente e Contrato -->
            <div class="form-row">
              <!-- Cliente -->
              <div class="form-field">
                <label for="client_id">
                  <i class="fas fa-building"></i>
                  Cliente *
                </label>
                <select
                  id="client_id"
                  formControlName="client_id"
                  (change)="onClienteChange(+$any($event.target).value)">
                  <option value="">{{ loadingClientes ? 'Carregando...' : 'Selecione um cliente' }}</option>
                  <option *ngFor="let cliente of clientes" [value]="cliente.id">
                    {{ getClienteNome(cliente) }}
                  </option>
                </select>
              </div>

              <!-- Contrato -->
              <div class="form-field">
                <label for="contract_id">
                  <i class="fas fa-file-contract"></i>
                  Contrato *
                </label>
                <select
                  id="contract_id"
                  formControlName="contract_id">
                  <option value="">{{ loadingContratos ? 'Carregando...' : 'Selecione um contrato' }}</option>
                  <option *ngFor="let contrato of contratosFiltrados" [value]="contrato.id">
                    #{{ contrato.contract_number }} - {{ contrato.type }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Linha 2: Nome do Mentorado e Data de Nascimento -->
            <div class="form-row">
              <!-- Nome do Mentorado -->
              <div class="form-field">
                <label for="mentorado_nome">
                  <i class="fas fa-user-graduate"></i>
                  Nome do Mentorado *
                </label>
                <input
                  type="text"
                  id="mentorado_nome"
                  formControlName="mentorado_nome"
                  placeholder="Ex: Joﾃ｣o Silva">
              </div>

              <!-- Data de Nascimento do Mentorado -->
              <div class="form-field">
                <label for="mentorado_data_nascimento">
                  <i class="fas fa-birthday-cake"></i>
                  Data de Nascimento
                </label>
                <input
                  type="date"
                  id="mentorado_data_nascimento"
                  formControlName="mentorado_data_nascimento">
              </div>
            </div>

            <!-- Linha 3: Profissﾃ｣o e Email -->
            <div class="form-row">
              <!-- Profissﾃ｣o do Mentorado -->
              <div class="form-field">
                <label for="mentorado_profissao">
                  <i class="fas fa-briefcase"></i>
                  Profissﾃ｣o do Mentorado
                </label>
                <input
                  type="text"
                  id="mentorado_profissao"
                  formControlName="mentorado_profissao"
                  placeholder="Ex: Empresﾃ｡rio">
              </div>

              <!-- Email do Mentorado -->
              <div class="form-field">
                <label for="mentorado_email">
                  <i class="fas fa-envelope"></i>
                  Email do Mentorado
                </label>
                <input
                  type="email"
                  id="mentorado_email"
                  formControlName="mentorado_email"
                  placeholder="Ex: joao@email.com">
                <small class="field-error" *ngIf="encontroForm.get('mentorado_email')?.invalid && encontroForm.get('mentorado_email')?.touched">
                  <i class="fas fa-exclamation-circle"></i>
                  Email invﾃ｡lido
                </small>
              </div>
            </div>

            <!-- Quantidade de Encontros (linha inteira) -->
            <div class="form-field highlight-field">
              <label for="numero_encontros">
                <i class="fas fa-calendar-check"></i>
                Quantidade de Encontros *
              </label>
              <input
                type="number"
                id="numero_encontros"
                formControlName="numero_encontros"
                min="1"
                max="50"
                placeholder="Ex: 5">
              <small class="field-hint">
                <i class="fas fa-info-circle"></i>
                Serﾃ｣o criados {{ encontroForm.get('numero_encontros')?.value || 5 }} encontros espaﾃｧados em 30 dias
              </small>
            </div>
          </ng-container>

          <!-- MODO EDIﾃﾃグ -->
          <ng-container *ngIf="isEditMode">
            <!-- Nome do Mentorado -->
            <div class="form-field">
              <label for="mentorado_nome">
                <i class="fas fa-user-graduate"></i>
                Nome do Mentorado *
              </label>
              <div class="input-with-action">
                <input
                  type="text"
                  id="mentorado_nome"
                  formControlName="mentorado_nome"
                  placeholder="Ex: Joﾃ｣o Silva">
                <button
                  type="button"
                  class="btn-secondary btn-small"
                  (click)="atualizarNomeEmTodosEncontros()"
                  [disabled]="isAtualizandoNome || !encontroForm.get('mentorado_nome')?.value"
                  title="Atualizar nome em todos os encontros desta mentoria">
                  <i class="fas" [ngClass]="isAtualizandoNome ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                  {{ isAtualizandoNome ? 'Atualizando...' : 'Aplicar em todos' }}
                </button>
              </div>
              <small class="field-hint">
                <i class="fas fa-info-circle"></i>
                Use "Aplicar em todos" para atualizar o nome em todos os encontros desta mentoria
              </small>
            </div>

            <!-- Nﾃｺmero do Encontro -->
            <div class="form-field">
              <label for="numero_encontro">
                <i class="fas fa-hashtag"></i>
                Nﾃｺmero do Encontro
              </label>
              <input
                type="number"
                id="numero_encontro"
                formControlName="numero_encontro"
                placeholder="1, 2, 3...">
            </div>

            <!-- Data do Encontro -->
            <div class="form-field">
              <label for="data_encontro">
                <i class="fas fa-calendar-alt"></i>
                Data do Encontro *
              </label>
              <input
                type="date"
                id="data_encontro"
                formControlName="data_encontro">
            </div>

            <!-- Status do Encontro -->
            <div class="form-field">
              <label for="encontro_status">
                <i class="fas fa-check-circle"></i>
                Status do Encontro
              </label>
              <select
                id="encontro_status"
                formControlName="encontro_status"
                class="status-select">
                <option value="em_andamento">泯 Em andamento</option>
                <option value="finalizado">笨 Finalizado</option>
              </select>
            </div>
          </ng-container>
        </form>
      </div>
    </div>

    <!-- Coluna Direita - Mﾃｭdia e Testes -->
    <div class="column-right">

      <!-- Seﾃｧﾃ｣o de Mﾃｭdia -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-header-left">
            <i class="fas fa-image section-icon"></i>
            <div>
              <h3 class="section-title">
                {{ isEditMode ? 'Foto do Encontro' : 'Foto da Mentoria' }}
              </h3>
              <p class="section-subtitle">
                {{ isEditMode ? 'Imagem para este encontro especﾃｭfico' : 'Esta foto serﾃ｡ exibida no hub da mentoria' }}
              </p>
            </div>
          </div>
        </div>

        <!-- MODO CRIAﾃﾃグ - Foto da Mentoria -->
        <div *ngIf="!isEditMode" class="foto-upload-container">
          <!-- Prﾃｩvia da foto selecionada -->
          <div class="foto-preview-container" *ngIf="fotoSelecionadaPreview">
            <div class="foto-preview">
              <img [src]="fotoSelecionadaPreview" alt="Prﾃｩvia da foto" class="foto-preview-image">
            </div>
            <div class="foto-preview-actions">
              <span class="foto-preview-label">
                <i class="fas fa-check-circle"></i>
                Foto selecionada
              </span>
              <button type="button" class="btn-remove-foto" (click)="removerFotoSelecionada()" title="Remover foto">
                <i class="fas fa-times"></i>
                Remover
              </button>
            </div>
          </div>

          <div class="foto-upload-input" *ngIf="!fotoSelecionadaPreview">
            <input
              type="file"
              id="foto_mentoria"
              accept="image/*"
              (change)="onFotoSelecionadaCriacao($event)"
              #fotoInputCriacao>
            <label for="foto_mentoria" class="foto-upload-label">
              <i class="fas fa-cloud-upload-alt"></i>
              <span>Clique para selecionar uma foto</span>
              <small>PNG, JPG, GIF ou WEBP (mﾃ｡x. 10MB)</small>
            </label>
          </div>
        </div>

        <!-- MODO EDIﾃﾃグ - Foto do Encontro -->
        <div *ngIf="isEditMode" class="foto-upload-container">
          <!-- Prﾃｩvia da foto existente -->
          <div class="foto-preview-container" *ngIf="fotoEncontroUrl">
            <div class="foto-preview">
              <img [src]="fotoEncontroUrl" alt="Foto do encontro" class="foto-preview-image">
            </div>
            <div class="foto-preview-actions">
              <span class="foto-preview-label">
                <i class="fas fa-check-circle"></i>
                Foto atual do encontro
              </span>
              <button type="button" class="btn-remove-foto" (click)="removerFoto()" title="Remover foto" [disabled]="isUploadingFoto">
                <i class="fas fa-trash"></i>
                Remover
              </button>
            </div>
          </div>

          <div class="foto-upload-input" *ngIf="!fotoEncontroUrl">
            <input
              type="file"
              id="foto_encontro"
              accept="image/*"
              (change)="onFotoSelecionada($event)"
              [disabled]="isUploadingFoto"
              #fotoInput>
            <label for="foto_encontro" class="foto-upload-label" [class.uploading]="isUploadingFoto">
              <i class="fas" [ngClass]="isUploadingFoto ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'"></i>
              <span>{{ isUploadingFoto ? 'Enviando...' : 'Clique para selecionar uma foto' }}</span>
              <small *ngIf="!isUploadingFoto">PNG, JPG, GIF ou WEBP (mﾃ｡x. 10MB)</small>
            </label>
          </div>
        </div>
      </div>

      <!-- Seﾃｧﾃ｣o Editor de Conteﾃｺdo - Apenas no modo Ediﾃｧﾃ｣o -->
      <div class="form-section" *ngIf="isEditMode && encontroId">
        <div class="section-header">
          <div class="section-header-left">
            <i class="fas fa-pen-to-square section-icon"></i>
            <div>
              <h3 class="section-title">Conteﾃｺdo do Encontro</h3>
              <p class="section-subtitle">Editor completo para o conteﾃｺdo</p>
            </div>
          </div>
        </div>

        <div class="content-card">
          <div class="content-card-body">
            <button
              type="button"
              class="btn-primary btn-large"
              (click)="irParaEditorConteudo()">
              Editar Conteﾃｺdo do Encontro
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-overlay">
  <div class="spinner"></div>
  <p>Carregando...</p>
</div>