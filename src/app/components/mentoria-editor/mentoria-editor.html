<div class="page" *ngIf="!isLoading">

  <!-- Header -->
  <div class="page-header">
    <div class="header-title-section">
      <h1 class="page-title">
        <i class="fas fa-chalkboard-teacher" style="color: var(--green-500); margin-right: 0.5rem;"></i>
        {{ isEditMode ? 'Editar Encontro de Mentoria' : 'Criar Nova Mentoria' }}
      </h1>
      <app-breadcrumb></app-breadcrumb>
    </div>
    <div class="header-actions">
      <!-- Modo Cria√ß√£o: Bot√£o de Criar Mentoria -->
      <button
        type="button"
        class="btn-primary"
        (click)="salvarEncontro()"
        [disabled]="isSaving || encontroForm.invalid"
        *ngIf="!isEditMode">
        <i class="fas fa-plus-circle"></i>
        {{ isSaving ? 'Criando...' : 'Criar Mentoria' }}
      </button>

      <!-- Modo Edi√ß√£o: Bot√µes de Salvar e Publicar -->
      <button
        type="button"
        class="btn-primary"
        (click)="salvarEncontro()"
        [disabled]="isSaving"
        *ngIf="isEditMode">
        <i class="fas fa-save"></i>
        {{ isSaving ? 'Salvando...' : 'Salvar Altera√ß√µes' }}
      </button>

      <button
        type="button"
        class="btn-success"
        (click)="publicarEncontro()"
        [disabled]="!isEditMode || isSaving"
        *ngIf="isEditMode">
        <i class="fas fa-paper-plane"></i>
        Publicar
      </button>
    </div>
  </div>

  <!-- Formul√°rio de Metadados -->
  <div class="form-section">
    <div class="section-header">
      <div class="section-header-left">
        <i class="fas fa-user-circle section-icon"></i>
        <div>
          <h3 class="section-title">
            {{ isEditMode ? 'Informa√ß√µes do Encontro' : 'Dados da Mentoria' }}
          </h3>
          <p class="section-subtitle">
            {{ isEditMode ? 'Configure os dados b√°sicos deste encontro' : 'Preencha as informa√ß√µes para criar a mentoria' }}
          </p>
        </div>
      </div>
    </div>

    <form [formGroup]="encontroForm">
      <!-- MODO CRIA√á√ÉO -->
      <ng-container *ngIf="!isEditMode">
        <!-- Linha 1: Cliente e Contrato -->
        <div class="form-row">
          <div class="form-field">
            <label for="client_id">
              <i class="fas fa-building"></i>
              Cliente *
            </label>
            <select
              id="client_id"
              formControlName="client_id"
              (change)="onClienteChange(+$any($event.target).value)">
              <option value="">{{ loadingClientes ? 'Carregando...' : 'Selecione um cliente' }}</option>
              <option *ngFor="let cliente of clientes" [value]="cliente.id">
                {{ getClienteNome(cliente) }}
              </option>
            </select>
          </div>

          <div class="form-field">
            <label for="contract_id">
              <i class="fas fa-file-contract"></i>
              Contrato *
            </label>
            <select
              id="contract_id"
              formControlName="contract_id">
              <option value="">{{ loadingContratos ? 'Carregando...' : 'Selecione um contrato' }}</option>
              <option *ngFor="let contrato of contratosFiltrados" [value]="contrato.id">
                #{{ contrato.contract_number }} - {{ contrato.type }}
              </option>
            </select>
          </div>
        </div>

        <!-- Linha 2: Nome do Mentorado e Quantidade de Encontros -->
        <div class="form-row">
          <div class="form-field">
            <label for="mentorado_nome">
              <i class="fas fa-user-graduate"></i>
              Nome do Mentorado *
            </label>
            <input
              type="text"
              id="mentorado_nome"
              formControlName="mentorado_nome"
              placeholder="Ex: Jo√£o Silva">
          </div>

          <div class="form-field highlight-field">
            <label for="numero_encontros">
              <i class="fas fa-calendar-check"></i>
              Quantidade de Encontros *
            </label>
            <input
              type="number"
              id="numero_encontros"
              formControlName="numero_encontros"
              min="1"
              max="50"
              placeholder="Ex: 5">
            <small class="field-hint">
              <i class="fas fa-info-circle"></i>
              Ser√£o criados {{ encontroForm.get('numero_encontros')?.value || 5 }} encontros espa√ßados em 7 dias
            </small>
          </div>
        </div>

        <!-- Linha 3: Foto da Mentoria (full width) -->
        <div class="form-field">
          <label for="foto_mentoria">
            <i class="fas fa-image"></i>
            Foto da Mentoria (Opcional)
          </label>
          <div class="foto-upload-container">
            <div class="foto-preview" *ngIf="fotoSelecionadaPreview">
              <img [src]="fotoSelecionadaPreview" alt="Foto da mentoria">
              <button type="button" class="btn-remove-foto" (click)="removerFotoSelecionada()" title="Remover foto">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="foto-upload-input" *ngIf="!fotoSelecionadaPreview">
              <input
                type="file"
                id="foto_mentoria"
                accept="image/*"
                (change)="onFotoSelecionadaCriacao($event)"
                #fotoInputCriacao>
              <label for="foto_mentoria" class="foto-upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Clique para selecionar uma foto</span>
                <small>PNG, JPG, GIF ou WEBP (m√°x. 10MB) - A foto ser√° aplicada a todos os encontros</small>
              </label>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- MODO EDI√á√ÉO -->
      <ng-container *ngIf="isEditMode">
        <!-- Linha 1: Nome do Mentorado e N√∫mero do Encontro -->
        <div class="form-row">
          <div class="form-field">
            <label for="mentorado_nome">
              <i class="fas fa-user-graduate"></i>
              Nome do Mentorado *
            </label>
            <input
              type="text"
              id="mentorado_nome"
              formControlName="mentorado_nome"
              placeholder="Ex: Jo√£o Silva">
          </div>

          <div class="form-field">
            <label for="numero_encontro">
              <i class="fas fa-hashtag"></i>
              N√∫mero do Encontro
            </label>
            <input
              type="number"
              id="numero_encontro"
              formControlName="numero_encontro"
              placeholder="1, 2, 3...">
          </div>
        </div>

        <!-- Linha 2: Data e Status do Encontro -->
        <div class="form-row">
          <div class="form-field">
            <label for="data_encontro">
              <i class="fas fa-calendar-alt"></i>
              Data do Encontro *
            </label>
            <input
              type="date"
              id="data_encontro"
              formControlName="data_encontro">
          </div>

          <div class="form-field">
            <label for="encontro_status">
              <i class="fas fa-check-circle"></i>
              Status do Encontro
            </label>
            <select
              id="encontro_status"
              formControlName="encontro_status"
              class="status-select">
              <option value="em_andamento">üü° Em andamento</option>
              <option value="finalizado">‚úÖ Finalizado</option>
            </select>
          </div>
        </div>
      </ng-container>
    </form>
  </div>

  <!-- Bot√£o para ir ao editor de conte√∫do - APENAS NO MODO EDI√á√ÉO -->
  <div class="content-editor-section" *ngIf="isEditMode && encontroId">
    <div class="content-card">
      <div class="content-card-icon">
        <i class="fas fa-pen-to-square"></i>
      </div>
      <div class="content-card-body">
        <h3 class="content-card-title">Conte√∫do do Encontro</h3>
        <p class="content-card-description">
          Edite o conte√∫do completo do encontro de mentoria com o editor de texto completo, incluindo textos, listas, imagens, v√≠deos e muito mais.
        </p>
        <button
          type="button"
          class="btn-primary btn-large"
          (click)="irParaEditorConteudo()">
          <i class="fas fa-pen-to-square"></i>
          Editar Conte√∫do do Encontro
        </button>
      </div>
    </div>
  </div>

  <!-- √Årea de Blocos - OCULTA COMPLETAMENTE -->
  <div class="blocos-area" *ngIf="false" style="display: none;">
    <h2><i class="fas fa-layer-group"></i> Conte√∫do do Encontro</h2>

    <div
      cdkDropList
      (cdkDropListDropped)="reordenarBlocos($event)"
      class="blocos-list">

      <div
        *ngFor="let bloco of blocos; let i = index"
        cdkDrag
        class="bloco-item"
        [class.editing]="blocoEditando === bloco.id">

        <!-- Drag Handle e Header -->
        <div class="bloco-header" cdkDragHandle>
          <div class="header-left">
            <i class="fas fa-grip-vertical drag-icon"></i>
            <i [class]="'fas ' + getIconeTipo(bloco.tipo)"></i>
            <span class="bloco-tipo">{{ getNomeTipo(bloco.tipo) }}</span>
          </div>
          <div class="header-right">
            <button class="btn-icon" (click)="editarBloco(bloco.id)" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon danger" (click)="removerBloco(i)" title="Remover">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Editor de Bloco (expandido quando editando) -->
        <div class="bloco-editor" *ngIf="blocoEditando === bloco.id">

          <!-- T√çTULO -->
          <div *ngIf="bloco.tipo === 'titulo'" class="editor-content">
            <div class="form-field">
              <label>Texto do T√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.texto" placeholder="Digite o t√≠tulo...">
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>N√≠vel</label>
                <select [(ngModel)]="bloco.configuracao.nivel">
                  <option [value]="1">H1 - Muito Grande</option>
                  <option [value]="2">H2 - Grande</option>
                  <option [value]="3">H3 - M√©dio</option>
                </select>
              </div>
              <div class="form-field">
                <label>Cor</label>
                <input type="color" [(ngModel)]="bloco.configuracao.cor">
              </div>
            </div>
          </div>

          <!-- TEXTO -->
          <div *ngIf="bloco.tipo === 'texto'" class="editor-content">
            <div class="form-field">
              <label>Conte√∫do</label>
              <textarea
                [(ngModel)]="bloco.configuracao.conteudo"
                rows="6"
                placeholder="Digite o texto...">
              </textarea>
              <small>Suporta HTML b√°sico</small>
            </div>
          </div>

          <!-- LISTA -->
          <div *ngIf="bloco.tipo === 'lista'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo da Lista</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: Pr√≥ximos Passos">
            </div>

            <div class="form-field">
              <label>Itens</label>
              <div *ngFor="let item of bloco.configuracao.itens; let idx = index" class="lista-item">
                <input
                  type="text"
                  [(ngModel)]="item.principal"
                  placeholder="Texto principal"
                  class="item-principal">
                <input
                  type="text"
                  [(ngModel)]="item.descricao"
                  placeholder="Descri√ß√£o (opcional)"
                  class="item-descricao">
                <select [(ngModel)]="item.destaque" class="item-destaque">
                  <option [ngValue]="null">Sem destaque</option>
                  <option value="yellow">Amarelo</option>
                  <option value="green">Verde</option>
                  <option value="orange">Laranja</option>
                </select>
                <button class="btn-icon-small danger" (click)="removerItemLista(bloco, idx)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button class="btn-add" (click)="adicionarItemLista(bloco)">
                <i class="fas fa-plus"></i> Adicionar Item
              </button>
            </div>
          </div>

          <!-- IMAGEM -->
          <div *ngIf="bloco.tipo === 'imagem'" class="editor-content">
            <div class="form-field">
              <label>Upload de Imagem</label>
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event, i)"
                class="file-input">
              <div *ngIf="uploadingImage" class="upload-progress">
                <i class="fas fa-spinner fa-spin"></i> Enviando...
              </div>
              <img *ngIf="bloco.configuracao.url" [src]="bloco.configuracao.url" class="preview-image">
            </div>
            <div class="form-field">
              <label>Legenda</label>
              <input type="text" [(ngModel)]="bloco.configuracao.legenda" placeholder="Legenda da imagem">
            </div>
            <div class="form-field">
              <label>Tamanho</label>
              <select [(ngModel)]="bloco.configuracao.largura">
                <option value="small">Pequeno</option>
                <option value="medium">M√©dio</option>
                <option value="large">Grande</option>
                <option value="full">Largura total</option>
              </select>
            </div>
          </div>

          <!-- VIDEO LINK -->
          <div *ngIf="bloco.tipo === 'video_link'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo do V√≠deo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: TED Talk sobre lideran√ßa">
            </div>
            <div class="form-field">
              <label>URL do V√≠deo</label>
              <input type="url" [(ngModel)]="bloco.configuracao.url" placeholder="https://youtube.com/...">
            </div>
            <div class="form-field">
              <label>Autor/Canal</label>
              <input type="text" [(ngModel)]="bloco.configuracao.autor" placeholder="Ex: MARTHA GABRIEL | TEDx">
            </div>
          </div>

          <!-- PERGUNTA -->
          <div *ngIf="bloco.tipo === 'pergunta'" class="editor-content">
            <div class="form-field">
              <label>Pergunta</label>
              <textarea
                [(ngModel)]="bloco.configuracao.pergunta"
                rows="2"
                placeholder="Digite a pergunta...">
              </textarea>
            </div>
            <div class="form-field">
              <label>Placeholder da Resposta</label>
              <input type="text" [(ngModel)]="bloco.configuracao.placeholder" placeholder="Ex: Digite sua resposta...">
            </div>
            <div class="form-field">
              <label>Exemplo de Resposta (opcional)</label>
              <input type="text" [(ngModel)]="bloco.configuracao.resposta_exemplo" placeholder="Ex: Comunica√ß√£o">
            </div>
          </div>

          <!-- SE√á√ÉO DE PERGUNTAS -->
          <div *ngIf="bloco.tipo === 'secao_perguntas'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo da Se√ß√£o</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: Rotina">
            </div>

            <div class="form-field">
              <label>Perguntas</label>
              <div *ngFor="let pergunta of bloco.configuracao.perguntas; let idx = index" class="pergunta-item">
                <textarea
                  [(ngModel)]="pergunta.texto"
                  rows="2"
                  placeholder="Digite a pergunta..."
                  class="pergunta-texto">
                </textarea>
                <button class="btn-icon-small danger" (click)="removerPergunta(bloco, idx)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button class="btn-add" (click)="adicionarPergunta(bloco)">
                <i class="fas fa-plus"></i> Adicionar Pergunta
              </button>
            </div>
          </div>

          <!-- CHECKBOX LISTA -->
          <div *ngIf="bloco.tipo === 'checkbox_lista'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: Tarefas para a pr√≥xima semana">
            </div>

            <div class="form-field">
              <label>Tarefas</label>
              <div *ngFor="let item of bloco.configuracao.itens; let idx = index" class="checkbox-item">
                <input
                  type="text"
                  [(ngModel)]="item.texto"
                  placeholder="Texto da tarefa"
                  class="checkbox-texto">
                <button class="btn-icon-small danger" (click)="removerCheckbox(bloco, idx)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button class="btn-add" (click)="adicionarCheckbox(bloco)">
                <i class="fas fa-plus"></i> Adicionar Tarefa
              </button>
            </div>
          </div>

          <!-- TABELA -->
          <div *ngIf="bloco.tipo === 'tabela'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo da Tabela</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: VECA">
            </div>

            <div class="form-field">
              <label>Colunas</label>
              <div class="tabela-colunas">
                <div *ngFor="let coluna of bloco.configuracao.colunas; let idx = index" class="coluna-item">
                  <input type="text" [(ngModel)]="bloco.configuracao.colunas[idx]" placeholder="Nome da coluna">
                  <button class="btn-icon-small danger" (click)="removerColunaTabela(bloco, idx)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <button class="btn-add-small" (click)="adicionarColunaTabela(bloco)">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>

            <div class="form-field">
              <label>Linhas</label>
              <div class="tabela-linhas">
                <div *ngFor="let linha of bloco.configuracao.linhas; let idxLinha = index" class="linha-item">
                  <div class="linha-celulas">
                    <input
                      *ngFor="let celula of linha; let idxCol = index"
                      type="text"
                      [(ngModel)]="bloco.configuracao.linhas[idxLinha][idxCol]"
                      placeholder="C√©lula">
                  </div>
                  <button class="btn-icon-small danger" (click)="removerLinhaTabela(bloco, idxLinha)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <button class="btn-add" (click)="adicionarLinhaTabela(bloco)">
                  <i class="fas fa-plus"></i> Adicionar Linha
                </button>
              </div>
            </div>
          </div>

          <!-- DESTAQUE -->
          <div *ngIf="bloco.tipo === 'destaque'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: G4 GEST√ÉO E ESTRAT√âGIA">
            </div>
            <div class="form-field">
              <label>Subt√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.subtitulo" placeholder="Texto complementar">
            </div>
            <div class="form-field">
              <label>Cor de Fundo</label>
              <input type="color" [(ngModel)]="bloco.configuracao.cor">
            </div>
          </div>

          <!-- GR√ÅFICO -->
          <div *ngIf="bloco.tipo === 'grafico'" class="editor-content">
            <div class="form-field">
              <label>T√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.titulo" placeholder="Ex: MAPA">
            </div>
            <div class="form-field">
              <label>Subt√≠tulo</label>
              <input type="text" [(ngModel)]="bloco.configuracao.subtitulo" placeholder="Ex: Indicadores positivos">
            </div>
            <div class="form-field">
              <label>Upload de Imagem do Gr√°fico</label>
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event, i)"
                class="file-input">
              <img *ngIf="bloco.configuracao.imagem_url" [src]="bloco.configuracao.imagem_url" class="preview-image">
            </div>
          </div>

          <!-- Bot√£o Salvar Bloco -->
          <div class="bloco-actions">
            <button class="btn-primary-small" (click)="salvarBloco(bloco)">
              <i class="fas fa-check"></i> Salvar Bloco
            </button>
          </div>
        </div>

        <!-- Preview do Bloco (quando n√£o est√° editando) -->
        <div class="bloco-preview" *ngIf="blocoEditando !== bloco.id">
          <div class="preview-content">
            <span class="preview-label">{{ getNomeTipo(bloco.tipo) }}:</span>
            <span class="preview-text">
              {{ bloco.configuracao.texto || bloco.configuracao.titulo || bloco.configuracao.pergunta || 'Bloco configurado' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="blocos.length === 0" class="blocos-empty">
        <i class="fas fa-inbox"></i>
        <p>Nenhum bloco adicionado ainda</p>
        <small>Clique nos bot√µes acima para adicionar blocos de conte√∫do</small>
      </div>
    </div>
  </div>

  <!-- Footer com A√ß√µes -->
  <div class="editor-footer">
    <button class="btn-primary" (click)="salvarEncontro()" [disabled]="isSaving">
      <i class="fas fa-save"></i>
      {{ isSaving ? 'Salvando...' : 'Salvar e Continuar' }}
    </button>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-overlay">
  <div class="spinner"></div>
  <p>Carregando...</p>
</div>
