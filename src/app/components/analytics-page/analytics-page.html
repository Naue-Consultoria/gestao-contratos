<div class="page">
  <div class="page-header">
    <h1 class="page-title">Analytics</h1>
    <app-breadcrumb></app-breadcrumb>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Carregando dados...</span>
    </div>
  </div>

  <div *ngIf="!isLoading">
    <!-- Seletor de Período -->
    <div class="period-selector">
      <label class="period-label">
        <i class="fas fa-calendar-alt"></i>
        Período de análise
      </label>
      <div class="period-buttons">
        <button 
          class="period-btn" 
          [class.active]="selectedPeriod === 'week'"
          (click)="setPeriod('week')">
          Semana
        </button>
        <button 
          class="period-btn" 
          [class.active]="selectedPeriod === 'month'"
          (click)="setPeriod('month')">
          Mês
        </button>
        <button 
          class="period-btn" 
          [class.active]="selectedPeriod === 'quarter'"
          (click)="setPeriod('quarter')">
          Trimestre
        </button>
        <button 
          class="period-btn" 
          [class.active]="selectedPeriod === 'year'"
          (click)="setPeriod('year')">
          Ano
        </button>
      </div>
      <div class="period-info">
        <span class="last-updated">
          <i class="fas fa-clock"></i>
          Atualizado: {{ lastUpdated | date:'dd/MM/yyyy HH:mm' }}
        </span>
        <button class="refresh-btn" (click)="refreshData()" [disabled]="isRefreshing">
          <i class="fas fa-sync" [class.fa-spin]="isRefreshing"></i>
        </button>
      </div>
    </div>


    <!-- KPIs Principais -->
    <div class="kpi-section">
      <h3 class="section-title">
        <i class="fas fa-tachometer-alt"></i>
        Indicadores-Chave de Performance
      </h3>
      <div class="kpi-grid">
        <!-- Taxa de Conversão -->
        <div class="kpi-card primary-kpi">
          <div class="kpi-header">
            <h4 class="kpi-title">Taxa de Conversão</h4>
            <div class="kpi-icon">
              <i class="fas fa-percentage"></i>
            </div>
          </div>
          <div class="kpi-value">{{ analyticsData?.general?.conversionRate || 0 }}%</div>
          <div class="kpi-description">
            <span class="trend" [ngClass]="getTrendClass(12)">
              <i class="fas fa-arrow-up"></i> +12% vs mês anterior
            </span>
          </div>
          <div class="kpi-gauge">
            <canvas id="conversionGauge" width="120" height="60"></canvas>
          </div>
        </div>

        <!-- Receita Total -->
        <div class="kpi-card revenue-kpi">
          <div class="kpi-header">
            <h4 class="kpi-title">Receita Total</h4>
            <div class="kpi-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
          </div>
          <div class="kpi-value">{{ formatCurrency(analyticsData?.general?.totalRevenue || 0) }}</div>
          <div class="kpi-description">
            <div class="revenue-breakdown">
              <span>Coletado: {{ formatCurrency(analyticsData?.revenue?.totalCollected || 0) }}</span>
              <span>Pendente: {{ formatCurrency(analyticsData?.revenue?.totalPending || 0) }}</span>
            </div>
          </div>
          <div class="revenue-progress">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="getRevenueProgress()"
                   [style.background]="'var(--primary-green)'"></div>
            </div>
            <span class="progress-text">{{ getRevenueProgress() }}% coletado</span>
          </div>
        </div>

        <!-- Contratos Ativos -->
        <div class="kpi-card contracts-kpi">
          <div class="kpi-header">
            <h4 class="kpi-title">Contratos Ativos</h4>
            <div class="kpi-icon">
              <i class="fas fa-file-contract"></i>
            </div>
          </div>
          <div class="kpi-value">{{ analyticsData?.general?.activeContracts || 0 }}</div>
          <div class="kpi-description">
            <div class="contract-stats">
              <span>Total: {{ analyticsData?.general?.totalContracts || 0 }}</span>
              <span>Concluídos: {{ analyticsData?.general?.completedContracts || 0 }}</span>
            </div>
          </div>
          <div class="contract-chart">
            <canvas id="contractsDonut" width="80" height="80"></canvas>
          </div>
        </div>

        <!-- Crescimento -->
        <div class="kpi-card growth-kpi">
          <div class="kpi-header">
            <h4 class="kpi-title">Taxa de Crescimento</h4>
            <div class="kpi-icon">
              <i class="fas fa-chart-line"></i>
            </div>
          </div>
          <div class="kpi-value">{{ formatGrowthRate(analyticsData?.general?.growthRate || 0) }}%</div>
          <div class="kpi-description">
            <span class="growth-period">vs {{ selectedPeriod === 'month' ? 'mês' : selectedPeriod === 'quarter' ? 'trimestre' : 'ano' }} anterior</span>
          </div>
          <div class="growth-sparkline">
            <canvas id="growthSparkline" width="200" height="40"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumo Simples -->
    <div class="summary-section">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="summary-content">
            <div class="summary-label">Valor Médio do Contrato</div>
            <div class="summary-value">{{ formatCurrency(analyticsData?.general?.averageContractValue || 0) }}</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="summary-content">
            <div class="summary-label">Novos Clientes</div>
            <div class="summary-value">{{ analyticsData?.clients?.newClients || 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico Principal -->
    <div class="chart-section">
      <h3 class="section-title">
        <i class="fas fa-chart-area"></i>
        Evolução Temporal
      </h3>
      <div class="main-chart-container">
        <div class="chart-header">
          <h4 class="chart-title">Contratos e Receita</h4>
        </div>
        <div class="evolution-chart-wrapper">
          <canvas id="evolutionChart"></canvas>
        </div>
      </div>
    </div>


    <!-- Ações -->
    <div class="actions-section">
      <div class="actions-simple">
        <button class="action-btn export-btn" (click)="exportAnalytics('excel')">
          <i class="fas fa-file-excel"></i>
          <span>Exportar Excel</span>
        </button>
        <button class="action-btn report-btn" (click)="generateReport()">
          <i class="fas fa-file-pdf"></i>
          <span>Gerar Relatório</span>
        </button>
      </div>
    </div>
  </div>
</div>