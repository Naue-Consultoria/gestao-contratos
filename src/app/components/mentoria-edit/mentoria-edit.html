<div class="page" *ngIf="!isLoading">
  <div class="page-header">
    <div class="header-title-section">
      <h1 class="page-title">
        Editar Mentoria
      </h1>
      <app-breadcrumb></app-breadcrumb>
    </div>
    <div class="header-actions">
      <button
        type="button"
        class="btn-primary"
        (click)="salvar()"
        [disabled]="isSaving || mentoriaForm.invalid">
        <i class="fas fa-save"></i>
        {{ isSaving ? 'Salvando...' : 'Salvar Alterações' }}
      </button>
    </div>
  </div>

  <!-- Container Principal com Duas Colunas -->
  <div class="two-column-layout">

    <!-- Coluna Esquerda - Informações Principais -->
    <div class="column-left">

      <!-- Seção de Informações Básicas -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-header-left">
            <i class="fas fa-info-circle section-icon"></i>
            <div>
              <h3 class="section-title">Informações da Mentoria</h3>
              <p class="section-subtitle">Edite os dados básicos da mentoria</p>
            </div>
          </div>
        </div>

        <form [formGroup]="mentoriaForm">
          <!-- Linha 1: Cliente e Contrato -->
          <div class="form-row">
            <!-- Cliente -->
            <div class="form-field">
              <label for="client_id">
                <i class="fas fa-building"></i>
                Cliente *
              </label>
              <select
                id="client_id"
                formControlName="client_id"
                (change)="onClienteChange(+$any($event.target).value)">
                <option value="">{{ loadingClientes ? 'Carregando...' : 'Selecione um cliente' }}</option>
                <option *ngFor="let cliente of clientes" [value]="cliente.id">
                  {{ getClienteNome(cliente) }}
                </option>
              </select>
            </div>

            <!-- Contrato -->
            <div class="form-field">
              <label for="contract_id">
                <i class="fas fa-file-contract"></i>
                Contrato *
              </label>
              <select
                id="contract_id"
                formControlName="contract_id">
                <option value="">{{ loadingContratos ? 'Carregando...' : 'Selecione um contrato' }}</option>
                <option *ngFor="let contrato of contratosFiltrados" [value]="contrato.id">
                  #{{ contrato.contract_number }} - {{ contrato.type }}
                </option>
              </select>
            </div>
          </div>

          <!-- Linha 2: Nome do Mentorado e Email -->
          <div class="form-row">
            <!-- Nome do Mentorado -->
            <div class="form-field">
              <label for="mentorado_nome">
                <i class="fas fa-user-graduate"></i>
                Nome do Mentorado *
              </label>
              <input
                type="text"
                id="mentorado_nome"
                formControlName="mentorado_nome"
                placeholder="Ex: João Silva">
              <div class="field-action-row">
                <button
                  type="button"
                  class="btn-link-action"
                  (click)="atualizarNomeEmTodosEncontros()"
                  [disabled]="isAtualizandoNome || !mentoriaForm.get('mentorado_nome')?.value"
                  title="Atualizar nome em todos os encontros desta mentoria">
                  <i class="fas" [ngClass]="isAtualizandoNome ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                  {{ isAtualizandoNome ? 'Atualizando...' : 'Aplicar em todos os encontros' }}
                </button>
              </div>
            </div>

            <!-- Email do Mentorado -->
            <div class="form-field">
              <label for="mentorado_email">
                <i class="fas fa-envelope"></i>
                Email do Mentorado
              </label>
              <input
                type="email"
                id="mentorado_email"
                formControlName="mentorado_email"
                placeholder="Ex: joao@email.com">
              <small class="field-error" *ngIf="mentoriaForm.get('mentorado_email')?.invalid && mentoriaForm.get('mentorado_email')?.touched">
                <i class="fas fa-exclamation-circle"></i>
                Email inválido
              </small>
            </div>
          </div>

          <!-- Linha 3: Data de Nascimento e Profissão -->
          <div class="form-row">
            <!-- Data de Nascimento do Mentorado -->
            <div class="form-field">
              <label for="mentorado_data_nascimento">
                <i class="fas fa-birthday-cake"></i>
                Data de Nascimento
              </label>
              <input
                type="date"
                id="mentorado_data_nascimento"
                formControlName="mentorado_data_nascimento">
            </div>

            <!-- Profissão do Mentorado -->
            <div class="form-field">
              <label for="mentorado_profissao">
                <i class="fas fa-briefcase"></i>
                Profissão do Mentorado
              </label>
              <input
                type="text"
                id="mentorado_profissao"
                formControlName="mentorado_profissao"
                placeholder="Ex: Empresário">
            </div>
          </div>

          <!-- Linha 4: Status da Mentoria -->
          <div class="form-row">
            <!-- Status da Mentoria -->
            <div class="form-field">
              <label for="status">
                <i class="fas fa-check-circle"></i>
                Status da Mentoria *
              </label>
              <select
                id="status"
                formControlName="status">
                <option value="ativa">Ativa</option>
                <option value="concluida">Concluída</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <!-- Card de Informações Adicionais -->
      <div class="info-card" *ngIf="mentoria">
        <div class="info-card-header">
          <i class="fas fa-info-circle"></i>
          <span>Informações Adicionais</span>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Total de Encontros:</span>
            <span class="info-value">{{ mentoria.numero_encontros }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Criado em:</span>
            <span class="info-value">{{ mentoria.created_at | date: 'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Criado por:</span>
            <span class="info-value">{{ mentoria.criador?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Última atualização:</span>
            <span class="info-value">{{ mentoria.updated_at | date: 'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna Direita - Mídia -->
    <div class="column-right">

      <!-- Seção de Foto da Mentoria -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-header-left">
            <i class="fas fa-image section-icon"></i>
            <div>
              <h3 class="section-title">Foto da Mentoria</h3>
              <p class="section-subtitle">Esta foto será exibida no hub da mentoria</p>
            </div>
          </div>
        </div>

        <div class="foto-upload-container">
          <!-- Prévia da Foto Atual -->
          <div class="foto-preview-container" *ngIf="fotoAtualUrl && !fotoSelecionadaPreview">
            <div class="foto-preview">
              <img [src]="fotoAtualUrl" alt="Foto da mentoria" class="foto-preview-image">
            </div>
            <div class="foto-preview-actions">
              <span class="foto-preview-label">
                <i class="fas fa-check-circle"></i>
                Foto atual da mentoria
              </span>
              <button type="button"
                      class="btn-remove-foto"
                      (click)="removerFotoAtual()"
                      [disabled]="isUploadingFoto"
                      title="Remover foto atual">
                <i class="fas fa-trash"></i>
                Remover
              </button>
            </div>
          </div>

          <!-- Prévia da Nova Foto Selecionada -->
          <div class="foto-preview-container" *ngIf="fotoSelecionadaPreview">
            <div class="foto-preview">
              <img [src]="fotoSelecionadaPreview" alt="Nova foto" class="foto-preview-image">
            </div>
            <div class="foto-preview-actions">
              <span class="foto-preview-label">
                <i class="fas fa-image"></i>
                Nova foto selecionada
              </span>
              <button type="button" class="btn-remove-foto" (click)="removerFotoSelecionada()">
                <i class="fas fa-times"></i>
                Remover
              </button>
            </div>
          </div>

          <!-- Input de Upload -->
          <div class="foto-upload-input" *ngIf="!fotoSelecionadaPreview && !fotoAtualUrl">
            <input
              type="file"
              id="foto_mentoria"
              accept="image/*"
              (change)="onFotoSelecionada($event)"
              [disabled]="isUploadingFoto"
              #fotoInput>
            <label for="foto_mentoria" class="foto-upload-label" [class.uploading]="isUploadingFoto">
              <i class="fas" [ngClass]="isUploadingFoto ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'"></i>
              <span>{{ isUploadingFoto ? 'Enviando...' : 'Clique para selecionar uma foto' }}</span>
              <small *ngIf="!isUploadingFoto">PNG, JPG, GIF ou WEBP (máx. 10MB)</small>
            </label>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-overlay">
  <div class="spinner"></div>
  <p>Carregando...</p>
</div>

<!-- Modal de Confirmação - Atualizar Nome -->
<div class="modal-overlay" *ngIf="showModalAtualizarNome" (click)="fecharModalAtualizarNome()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon warning">
        <i class="fas fa-sync-alt"></i>
      </div>
      <h3 class="modal-title">Atualizar Nome do Mentorado</h3>
    </div>

    <div class="modal-body">
      <p class="modal-message">
        Deseja atualizar o nome do mentorado para
        <strong>"{{ mentoriaForm.get('mentorado_nome')?.value }}"</strong>
        em <strong>TODOS os {{ mentoria?.encontros?.length || 0 }} encontros</strong> desta mentoria?
      </p>
      <div class="modal-info">
        <i class="fas fa-info-circle"></i>
        <span>Esta ação irá substituir o nome em todos os encontros existentes.</span>
      </div>
    </div>

    <div class="modal-footer">
      <button
        type="button"
        class="btn-modal-cancel"
        (click)="fecharModalAtualizarNome()"
        [disabled]="isAtualizandoNome">
        Cancelar
      </button>
      <button
        type="button"
        class="btn-modal-confirm"
        (click)="confirmarAtualizarNome()"
        [disabled]="isAtualizandoNome">
        <i class="fas" [ngClass]="isAtualizandoNome ? 'fa-spinner fa-spin' : 'fa-check'"></i>
        {{ isAtualizandoNome ? 'Atualizando...' : 'Confirmar' }}
      </button>
    </div>
  </div>
</div>
